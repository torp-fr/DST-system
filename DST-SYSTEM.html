<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DST-SYSTEM — Pilotage Stratégique</title>
  <style>
/* ============================================================
   DST-SYSTEM — Outil de Pilotage Stratégique
   Identité visuelle : premium, institutionnel, opérationnel
   Neon Red Metallic — Dark Command Post Theme
   ============================================================ */

/* --- CSS Reset & Base --- */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  /* Couleurs principales — noir profond premium */
  --bg-primary: #111114;
  --bg-secondary: #18181c;
  --bg-tertiary: #222228;
  --bg-card: #1c1c22;
  --bg-hover: #2a2a34;
  --bg-input: #141418;

  /* Texte */
  --text-primary: #e8e8ec;
  --text-secondary: #a0a0a8;
  --text-muted: #6e6e78;
  --text-heading: #f4f4f8;

  /* Accent — rouge néon métallique */
  --accent-red: #e53935;
  --accent-red-light: #ff6659;
  --accent-red-dark: #ab000d;
  --accent-red-bg: rgba(229, 57, 53, 0.10);
  --neon-red: #ff1744;
  --neon-red-glow: rgba(255, 23, 68, 0.35);
  --neon-red-soft: rgba(255, 23, 68, 0.12);
  --metallic-red: linear-gradient(135deg, #e53935 0%, #ff6659 40%, #e53935 60%, #ab000d 100%);

  /* Statuts */
  --color-success: #43a047;
  --color-success-bg: rgba(67, 160, 71, 0.10);
  --color-warning: #f9a825;
  --color-warning-bg: rgba(249, 168, 37, 0.10);
  --color-info: #5c8abf;
  --color-info-bg: rgba(92, 138, 191, 0.10);

  /* Bordures */
  --border-color: #2e2e36;
  --border-light: #3a3a44;

  /* Dimensions */
  --sidebar-width: 252px;
  --header-height: 56px;

  /* Polices */
  --font-main: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, Helvetica, Arial, sans-serif;
  --font-mono: 'JetBrains Mono', 'Fira Code', 'Consolas', 'Monaco', monospace;

  /* Ombres */
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.4);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.5);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.6);
  --shadow-neon: 0 0 12px var(--neon-red-glow), 0 0 4px var(--neon-red-glow);

  /* Transitions */
  --transition-fast: 150ms cubic-bezier(.4,0,.2,1);
  --transition-normal: 280ms cubic-bezier(.4,0,.2,1);
  --transition-smooth: 400ms cubic-bezier(.25,.8,.25,1);
}

/* Animations globales */
@keyframes neonPulse {
  0%, 100% { box-shadow: 0 0 6px var(--neon-red-glow), inset 0 0 6px rgba(255,23,68,0.05); }
  50% { box-shadow: 0 0 14px var(--neon-red-glow), inset 0 0 10px rgba(255,23,68,0.08); }
}
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes slideInLeft {
  from { opacity: 0; transform: translateX(-16px); }
  to { opacity: 1; transform: translateX(0); }
}
@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}

html { font-size: 14px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

body {
  font-family: var(--font-main);
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.55;
  overflow: hidden;
  height: 100vh;
}

a { color: var(--color-info); text-decoration: none; transition: color var(--transition-fast); }
a:hover { color: #7da8d4; text-decoration: none; }

/* --- Layout Shell --- */
#app-shell {
  display: flex;
  height: 100vh;
  width: 100vw;
}

/* --- Sidebar --- Premium Dark Panel with Neon Accents */
#sidebar {
  width: var(--sidebar-width);
  min-width: var(--sidebar-width);
  background: linear-gradient(180deg, #141418 0%, #111114 40%, #0d0d10 100%);
  border-right: 1px solid var(--border-color);
  display: flex;
  flex-direction: column;
  z-index: 100;
  position: relative;
}

/* Subtle red gradient line on the right edge */
#sidebar::after {
  content: '';
  position: absolute;
  top: 0;
  right: -1px;
  width: 1px;
  height: 100%;
  background: linear-gradient(180deg, transparent 0%, var(--neon-red-glow) 30%, var(--neon-red) 50%, var(--neon-red-glow) 70%, transparent 100%);
  opacity: 0.4;
}

.sidebar-brand {
  height: 64px;
  display: flex;
  align-items: center;
  padding: 0 16px;
  border-bottom: 1px solid var(--border-color);
  gap: 12px;
  position: relative;
}

.sidebar-brand img,
.sidebar-brand svg {
  height: 38px;
  width: auto;
  filter: drop-shadow(0 0 6px rgba(255,23,68,0.2));
}

.sidebar-brand .brand-text {
  font-size: 1.05rem;
  font-weight: 800;
  color: var(--text-heading);
  letter-spacing: 1.5px;
  text-transform: uppercase;
  background: linear-gradient(135deg, #fff 0%, #ccc 50%, #fff 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.sidebar-brand .brand-sub {
  font-size: 0.65rem;
  color: var(--text-muted);
  letter-spacing: 1.5px;
  text-transform: uppercase;
  font-weight: 500;
}

.sidebar-nav {
  flex: 1;
  overflow-y: auto;
  padding: 12px 0;
}

.sidebar-nav .nav-section {
  padding: 16px 18px 6px;
  font-size: 0.62rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-muted);
  opacity: 0.7;
}

.sidebar-nav .nav-item {
  display: flex;
  align-items: center;
  padding: 10px 18px;
  margin: 1px 8px;
  cursor: pointer;
  color: var(--text-secondary);
  transition: all var(--transition-normal);
  gap: 11px;
  font-size: 0.88rem;
  font-weight: 500;
  border-radius: 8px;
  border-left: none;
  position: relative;
}

.sidebar-nav .nav-item:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

/* === NEON RED METALLIC — Active Tab Effect === */
.sidebar-nav .nav-item.active {
  background: linear-gradient(135deg, rgba(229,57,53,0.15) 0%, rgba(255,23,68,0.08) 100%);
  color: #fff;
  font-weight: 600;
  box-shadow: 0 0 12px rgba(255,23,68,0.2), inset 0 0 12px rgba(255,23,68,0.06);
  animation: neonPulse 3s ease-in-out infinite;
}

/* Neon glow border for active item */
.sidebar-nav .nav-item.active::before {
  content: '';
  position: absolute;
  left: 0;
  top: 15%;
  height: 70%;
  width: 3px;
  background: var(--metallic-red);
  border-radius: 0 3px 3px 0;
  box-shadow: 0 0 8px var(--neon-red-glow), 0 0 16px rgba(255,23,68,0.15);
}

/* Subtle neon underline shimmer */
.sidebar-nav .nav-item.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 10%;
  right: 10%;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--neon-red), transparent);
  opacity: 0.4;
}

.sidebar-nav .nav-item .nav-icon {
  width: 22px;
  text-align: center;
  font-size: 1rem;
  flex-shrink: 0;
  transition: transform var(--transition-normal), color var(--transition-normal);
}

.sidebar-nav .nav-item.active .nav-icon {
  color: var(--neon-red);
  filter: drop-shadow(0 0 4px var(--neon-red-glow));
  transform: scale(1.1);
}

.sidebar-nav .nav-item .nav-badge {
  margin-left: auto;
  background: var(--accent-red);
  color: #fff;
  font-size: 0.65rem;
  padding: 2px 7px;
  border-radius: 10px;
  font-weight: 700;
  box-shadow: 0 0 6px var(--neon-red-glow);
}

.sidebar-footer {
  padding: 14px 18px;
  border-top: 1px solid var(--border-color);
  font-size: 0.72rem;
  color: var(--text-muted);
  opacity: 0.7;
}

/* --- Main Area --- */
#main-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background: var(--bg-primary);
}

/* --- Header --- */
#header {
  height: var(--header-height);
  min-height: var(--header-height);
  background: linear-gradient(180deg, #18181c 0%, #141418 100%);
  border-bottom: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 28px;
  backdrop-filter: blur(8px);
}

.header-title {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text-heading);
  letter-spacing: 0.3px;
}

.header-alerts {
  display: flex;
  align-items: center;
  gap: 14px;
}

.header-alert-btn {
  position: relative;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  color: var(--text-secondary);
  padding: 7px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 500;
  font-family: var(--font-main);
  transition: all var(--transition-normal);
}

.header-alert-btn:hover {
  background: var(--bg-hover);
  border-color: var(--border-light);
  color: var(--text-primary);
}

.header-alert-btn .badge {
  position: absolute;
  top: -5px;
  right: -5px;
  background: var(--neon-red);
  color: #fff;
  font-size: 0.6rem;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  box-shadow: 0 0 8px var(--neon-red-glow);
}

.header-context {
  font-size: 0.8rem;
  color: var(--text-muted);
  font-weight: 400;
}

/* --- Content Area --- */
#content {
  flex: 1;
  overflow-y: auto;
  padding: 28px;
  animation: fadeInUp 0.3s ease-out;
}

/* --- Page Title --- */
.page-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
}

.page-header h1 {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-heading);
}

.page-header .actions {
  display: flex;
  gap: 8px;
}

/* --- Cards --- Premium glass-morphism effect */
.card {
  background: linear-gradient(135deg, var(--bg-card) 0%, rgba(28,28,34,0.95) 100%);
  border: 1px solid var(--border-color);
  border-radius: 10px;
  padding: 22px;
  margin-bottom: 18px;
  transition: border-color var(--transition-normal), box-shadow var(--transition-normal);
  animation: fadeInUp 0.35s ease-out both;
}

.card:hover {
  border-color: var(--border-light);
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 18px;
}

.card-header h2 {
  font-size: 1.05rem;
  font-weight: 600;
  color: var(--text-heading);
}

.card-header h3 {
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--text-heading);
}

/* --- KPI Grid --- */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
  gap: 16px;
  margin-bottom: 28px;
}

.kpi-card {
  background: linear-gradient(145deg, var(--bg-card) 0%, rgba(20,20,26,0.9) 100%);
  border: 1px solid var(--border-color);
  border-radius: 10px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  transition: all var(--transition-normal);
  position: relative;
  overflow: hidden;
}

.kpi-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--border-light), transparent);
  opacity: 0;
  transition: opacity var(--transition-normal);
}

.kpi-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.35);
  border-color: var(--border-light);
}

.kpi-card:hover::before { opacity: 1; }

.kpi-card .kpi-label {
  font-size: 0.72rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 8px;
  font-weight: 600;
}

.kpi-card .kpi-value {
  font-size: 1.8rem;
  font-weight: 800;
  color: var(--text-heading);
  line-height: 1.2;
}

.kpi-card .kpi-detail {
  font-size: 0.76rem;
  color: var(--text-secondary);
  margin-top: 6px;
}

.kpi-card.kpi-alert {
  border-color: var(--accent-red);
  background: linear-gradient(145deg, var(--accent-red-bg) 0%, rgba(229,57,53,0.05) 100%);
}

.kpi-card.kpi-alert::before {
  background: var(--metallic-red);
  opacity: 1;
}

.kpi-card.kpi-alert .kpi-value {
  color: var(--accent-red-light);
}

.kpi-card.kpi-success {
  border-color: var(--color-success);
  background: linear-gradient(145deg, var(--color-success-bg) 0%, rgba(67,160,71,0.03) 100%);
}

.kpi-card.kpi-warning {
  border-color: var(--color-warning);
  background: linear-gradient(145deg, var(--color-warning-bg) 0%, rgba(249,168,37,0.03) 100%);
}

/* --- Data Grid / Table --- */
.data-table-wrap {
  overflow-x: auto;
  border-radius: 8px;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.86rem;
}

.data-table thead th {
  text-align: left;
  padding: 12px 14px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  font-size: 0.68rem;
  letter-spacing: 1px;
  border-bottom: 1px solid var(--border-color);
  white-space: nowrap;
  background: rgba(0,0,0,0.15);
}

.data-table tbody tr {
  border-bottom: 1px solid rgba(46,46,54,0.5);
  transition: all var(--transition-fast);
}

.data-table tbody tr:hover {
  background: var(--bg-hover);
}

.data-table tbody td {
  padding: 11px 14px;
  color: var(--text-primary);
  vertical-align: middle;
}

.data-table .actions-cell {
  white-space: nowrap;
  text-align: right;
}

.data-table .num {
  text-align: right;
  font-variant-numeric: tabular-nums;
  font-family: var(--font-mono);
}

/* --- Buttons --- Premium with subtle hover glow */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  background: var(--bg-tertiary);
  color: var(--text-primary);
  font-size: 0.84rem;
  font-weight: 500;
  cursor: pointer;
  transition: all var(--transition-normal);
  font-family: var(--font-main);
  white-space: nowrap;
  position: relative;
  overflow: hidden;
}

.btn:hover {
  background: var(--bg-hover);
  border-color: var(--border-light);
  transform: translateY(-1px);
  box-shadow: 0 3px 10px rgba(0,0,0,0.3);
}

.btn:active {
  transform: translateY(0);
  box-shadow: none;
}

.btn-primary {
  background: var(--accent-red);
  border-color: var(--accent-red);
  color: #fff;
}

.btn-primary:hover {
  background: var(--accent-red-light);
  border-color: var(--accent-red-light);
  box-shadow: 0 3px 14px var(--neon-red-glow);
}

.btn-sm {
  padding: 5px 11px;
  font-size: 0.76rem;
  border-radius: 6px;
}

.btn-icon {
  padding: 6px 8px;
  font-size: 0.9rem;
}

.btn-ghost {
  background: transparent;
  border-color: transparent;
}

.btn-ghost:hover {
  background: var(--bg-hover);
  box-shadow: none;
  transform: none;
}

.btn-success {
  background: var(--color-success);
  border-color: var(--color-success);
  color: #fff;
}

.btn-success:hover {
  box-shadow: 0 3px 14px rgba(67,160,71,0.3);
}

.btn-warning {
  background: var(--color-warning);
  border-color: var(--color-warning);
  color: #1a1a1e;
}

.btn-warning:hover {
  box-shadow: 0 3px 14px rgba(249,168,37,0.3);
}

/* --- Forms --- Premium inputs with focus glow */
.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  font-size: 0.76rem;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 5px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
}

.form-control {
  width: 100%;
  padding: 9px 12px;
  background: var(--bg-input);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 0.86rem;
  font-family: var(--font-main);
  transition: all var(--transition-normal);
}

.form-control:focus {
  outline: none;
  border-color: var(--accent-red);
  box-shadow: 0 0 0 3px rgba(229,57,53,0.12), 0 0 8px rgba(255,23,68,0.08);
}

.form-control:hover:not(:focus) {
  border-color: var(--border-light);
}

.form-control::placeholder {
  color: var(--text-muted);
}

/* Remove number input spinners for free input */
.form-control[type="number"] {
  -moz-appearance: textfield;
}
.form-control[type="number"]::-webkit-outer-spin-button,
.form-control[type="number"]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

select.form-control {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236e6e78' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  padding-right: 30px;
}

textarea.form-control {
  resize: vertical;
  min-height: 80px;
}

.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
}

.form-inline {
  display: flex;
  align-items: flex-end;
  gap: 12px;
}

.form-help {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 2px;
}

.form-check {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}

.form-check input[type="checkbox"] {
  accent-color: var(--accent-red);
  width: 16px;
  height: 16px;
}

/* --- Modal --- Premium glass overlay */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
  animation: fadeInUp 0.2s ease-out;
}

.modal {
  background: linear-gradient(180deg, var(--bg-secondary) 0%, #141418 100%);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  width: 100%;
  max-width: 700px;
  max-height: 85vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 16px 48px rgba(0,0,0,0.6), 0 0 1px rgba(255,23,68,0.1);
  animation: fadeInUp 0.25s ease-out;
}

.modal-lg {
  max-width: 900px;
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border-color);
}

.modal-header h2 {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--text-heading);
}

.modal-body {
  padding: 20px;
  overflow-y: auto;
  flex: 1;
}

.modal-footer {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 8px;
  padding: 12px 20px;
  border-top: 1px solid var(--border-color);
}

/* --- Alert Banners --- */
.alert {
  padding: 13px 16px;
  border-radius: 8px;
  margin-bottom: 14px;
  font-size: 0.84rem;
  display: flex;
  align-items: flex-start;
  gap: 10px;
  animation: slideInLeft 0.3s ease-out;
}

.alert-danger {
  background: var(--accent-red-bg);
  border: 1px solid var(--accent-red);
  color: var(--accent-red-light);
}

.alert-warning {
  background: var(--color-warning-bg);
  border: 1px solid var(--color-warning);
  color: var(--color-warning);
}

.alert-info {
  background: var(--color-info-bg);
  border: 1px solid var(--color-info);
  color: var(--color-info);
}

.alert-success {
  background: var(--color-success-bg);
  border: 1px solid var(--color-success);
  color: var(--color-success);
}

.alert .alert-icon {
  font-size: 1rem;
  flex-shrink: 0;
  margin-top: 1px;
}

/* --- Tags / Badges --- */
.tag {
  display: inline-flex;
  align-items: center;
  padding: 3px 9px;
  border-radius: 5px;
  font-size: 0.7rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  transition: transform var(--transition-fast);
}

.tag:hover { transform: scale(1.03); }

.tag-red { background: var(--accent-red-bg); color: var(--accent-red-light); }
.tag-green { background: var(--color-success-bg); color: var(--color-success); }
.tag-yellow { background: var(--color-warning-bg); color: var(--color-warning); }
.tag-blue { background: var(--color-info-bg); color: var(--color-info); }
.tag-neutral { background: var(--bg-tertiary); color: var(--text-secondary); }

/* --- Tabs --- Neon red underline on active */
.tabs {
  display: flex;
  border-bottom: 1px solid var(--border-color);
  margin-bottom: 18px;
  gap: 0;
}

.tab-btn {
  padding: 11px 20px;
  border: none;
  background: none;
  color: var(--text-muted);
  font-size: 0.86rem;
  font-weight: 500;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all var(--transition-normal);
  font-family: var(--font-main);
  position: relative;
}

.tab-btn:hover {
  color: var(--text-primary);
  background: rgba(255,255,255,0.02);
}

.tab-btn.active {
  color: #fff;
  font-weight: 600;
  border-bottom-color: var(--neon-red);
  text-shadow: 0 0 8px rgba(255,23,68,0.3);
}

.tab-btn.active::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 20%;
  right: 20%;
  height: 2px;
  background: var(--neon-red);
  box-shadow: 0 0 8px var(--neon-red-glow), 0 2px 12px var(--neon-red-glow);
  border-radius: 1px;
}

/* --- Alerts Panel (dropdown) --- */
.alerts-panel {
  position: fixed;
  top: var(--header-height);
  right: 0;
  width: 400px;
  max-height: 500px;
  background: linear-gradient(180deg, var(--bg-secondary) 0%, #111114 100%);
  border: 1px solid var(--border-color);
  border-radius: 0 0 0 12px;
  box-shadow: 0 12px 36px rgba(0,0,0,0.6);
  overflow-y: auto;
  z-index: 500;
  display: none;
}

.alerts-panel.open {
  display: block;
  animation: fadeInUp 0.2s ease-out;
}

.alerts-panel .alert-item {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border-color);
  font-size: 0.82rem;
  display: flex;
  align-items: flex-start;
  gap: 8px;
}

.alerts-panel .alert-item:last-child {
  border-bottom: none;
}

.alerts-panel .alert-item .alert-type {
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.68rem;
  letter-spacing: 0.5px;
}

.alerts-panel .alert-item.level-critical .alert-type { color: var(--accent-red-light); }
.alerts-panel .alert-item.level-warning .alert-type { color: var(--color-warning); }
.alerts-panel .alert-item.level-info .alert-type { color: var(--color-info); }

/* --- Progress Bar --- */
.progress-bar {
  width: 100%;
  height: 5px;
  background: rgba(255,255,255,0.05);
  border-radius: 4px;
  overflow: hidden;
}

.progress-bar .progress-fill {
  height: 100%;
  border-radius: 4px;
  transition: width var(--transition-smooth);
}

.progress-fill.fill-green { background: var(--color-success); }
.progress-fill.fill-yellow { background: var(--color-warning); }
.progress-fill.fill-red { background: var(--accent-red); }
.progress-fill.fill-blue { background: var(--color-info); }

/* --- Comparison Table (HR arbitrage) --- */
.comparison-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 14px;
}

.comparison-card {
  background: linear-gradient(145deg, var(--bg-tertiary) 0%, rgba(20,20,26,0.9) 100%);
  border: 1px solid var(--border-color);
  border-radius: 10px;
  padding: 16px;
  text-align: center;
  transition: all var(--transition-normal);
}

.comparison-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.3);
}

.comparison-card.recommended {
  border-color: var(--color-success);
  background: linear-gradient(145deg, var(--color-success-bg) 0%, rgba(67,160,71,0.03) 100%);
}

.comparison-card.not-recommended {
  border-color: var(--accent-red);
  background: linear-gradient(145deg, var(--accent-red-bg) 0%, rgba(229,57,53,0.03) 100%);
}

.comparison-card .comp-label {
  font-size: 0.72rem;
  color: var(--text-muted);
  text-transform: uppercase;
  margin-bottom: 6px;
  letter-spacing: 0.8px;
  font-weight: 600;
}

.comparison-card .comp-value {
  font-size: 1.3rem;
  font-weight: 800;
  color: var(--text-heading);
}

.comparison-card .comp-detail {
  font-size: 0.74rem;
  color: var(--text-secondary);
  margin-top: 4px;
}

/* --- Empty State --- */
.empty-state {
  text-align: center;
  padding: 56px 24px;
  color: var(--text-muted);
  animation: fadeInUp 0.4s ease-out;
}

.empty-state .empty-icon {
  font-size: 3rem;
  margin-bottom: 14px;
  opacity: 0.3;
}

.empty-state p {
  font-size: 0.88rem;
  margin-bottom: 18px;
}

/* --- Search Bar --- */
.search-bar {
  position: relative;
  max-width: 320px;
}

.search-bar input {
  width: 100%;
  padding: 8px 12px 8px 34px;
  background: var(--bg-input);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 0.84rem;
  font-family: var(--font-main);
  transition: all var(--transition-normal);
}

.search-bar input:focus {
  outline: none;
  border-color: var(--accent-red);
  box-shadow: 0 0 0 3px rgba(229,57,53,0.1);
}

.search-bar .search-icon {
  position: absolute;
  left: 11px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  font-size: 0.82rem;
}

/* --- Tooltip --- */
[data-tooltip] {
  position: relative;
}

[data-tooltip]:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: #0a0a0c;
  color: #eee;
  padding: 5px 10px;
  border-radius: 6px;
  font-size: 0.72rem;
  white-space: nowrap;
  z-index: 600;
  margin-bottom: 6px;
  border: 1px solid var(--border-color);
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}

/* --- Utility Classes --- */
.text-right { text-align: right; }
.text-center { text-align: center; }
.text-muted { color: var(--text-muted); }
.text-red { color: var(--accent-red-light); }
.text-green { color: var(--color-success); }
.text-yellow { color: var(--color-warning); }
.text-mono { font-family: var(--font-mono); font-variant-numeric: tabular-nums; }
.font-bold { font-weight: 700; }
.mt-8 { margin-top: 8px; }
.mt-16 { margin-top: 16px; }
.mt-24 { margin-top: 24px; }
.mb-8 { margin-bottom: 8px; }
.mb-16 { margin-bottom: 16px; }
.mb-24 { margin-bottom: 24px; }
.flex { display: flex; }
.flex-between { display: flex; justify-content: space-between; align-items: center; }
.gap-8 { gap: 8px; }
.gap-12 { gap: 12px; }
.gap-16 { gap: 16px; }
.hidden { display: none !important; }

/* --- Scrollbar Styling --- Premium thin scrollbar */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.15); }

/* --- Grid Layouts --- */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }

/* --- Selection --- */
::selection { background: rgba(229,57,53,0.3); color: #fff; }

@media (max-width: 1024px) {
  .grid-2, .grid-3 { grid-template-columns: 1fr; }
  .kpi-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
}

@media (max-width: 768px) {
  :root { --sidebar-width: 56px; }
  .sidebar-nav .nav-item span:not(.nav-icon) { display: none; }
  .sidebar-brand .brand-text, .sidebar-brand .brand-sub { display: none; }
  .sidebar-nav .nav-item.active::after { display: none; }
}
/* === V2 — Styles pilotage stratégique === */
.strat-section { margin-top: 28px; animation: fadeInUp 0.4s ease-out both; }
.strat-section-title {
  font-size: 0.72rem; font-weight: 700; text-transform: uppercase;
  letter-spacing: 1.5px; color: var(--neon-red); margin-bottom: 14px;
  padding-bottom: 8px; border-bottom: 1px solid var(--border-color);
  position: relative;
}
.strat-section-title::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  width: 40px;
  height: 2px;
  background: var(--metallic-red);
  box-shadow: 0 0 6px var(--neon-red-glow);
}
.cost-breakdown { display: grid; grid-template-columns: 1fr auto; gap: 5px 18px; font-size: 0.84rem; }
.cost-breakdown .cb-label { color: var(--text-secondary); }
.cost-breakdown .cb-value { text-align: right; font-family: var(--font-mono); font-variant-numeric: tabular-nums; color: var(--text-primary); }
.cost-breakdown .cb-total { font-weight: 700; color: var(--text-heading); border-top: 1px solid var(--border-color); padding-top: 6px; margin-top: 6px; }
.cost-breakdown .cb-sub { padding-left: 18px; font-size: 0.78rem; color: var(--text-muted); }
.reco-card {
  background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(28,28,34,0.8) 100%);
  border: 1px solid var(--border-color); border-radius: 8px;
  padding: 16px; margin-bottom: 10px;
  transition: all var(--transition-normal);
}
.reco-card:hover { border-color: var(--border-light); transform: translateX(2px); }
.reco-card.reco-critical { border-left: 3px solid var(--neon-red); }
.reco-card.reco-warning { border-left: 3px solid var(--color-warning); }
.reco-card.reco-info { border-left: 3px solid var(--color-info); }
.reco-card.reco-success { border-left: 3px solid var(--color-success); }
.reco-card .reco-title { font-size: 0.82rem; font-weight: 600; color: var(--text-heading); margin-bottom: 4px; }
.reco-card .reco-text { font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5; }
.reco-card .reco-metric { font-family: var(--font-mono); font-weight: 700; color: var(--text-heading); }
.floor-indicator { display: flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 8px; font-size: 0.84rem; font-weight: 500; }
.floor-ok { background: var(--color-success-bg); color: var(--color-success); }
.floor-danger { background: var(--accent-red-bg); color: var(--accent-red-light); box-shadow: inset 0 0 12px rgba(229,57,53,0.05); }
.floor-warning { background: var(--color-warning-bg); color: var(--color-warning); }
.prev-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }
.prev-cell {
  background: linear-gradient(145deg, var(--bg-tertiary) 0%, rgba(20,20,26,0.9) 100%);
  border: 1px solid var(--border-color); border-radius: 10px; padding: 16px;
  text-align: center; transition: all var(--transition-normal);
}
.prev-cell:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.3); border-color: var(--border-light); }
.prev-cell .prev-period { font-size: 0.68rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; font-weight: 600; }
.prev-cell .prev-value { font-size: 1.3rem; font-weight: 800; color: var(--text-heading); font-family: var(--font-mono); }
.prev-cell .prev-detail { font-size: 0.74rem; color: var(--text-secondary); margin-top: 4px; }
.trend-up { color: var(--color-success); }
.trend-down { color: var(--accent-red-light); }
.trend-flat { color: var(--color-warning); }
  </style>
</head>
<body>
  <div id="app-shell">
    <aside id="sidebar"></aside>
    <main id="main-area">
      <header id="header"></header>
      <section id="content"></section>
    </main>
  </div>
  <script>
/* ============================================================
   DST-SYSTEM — Couche de persistance (localStorage)
   Gère toutes les entités métier avec CRUD complet.
   ============================================================ */

const DB = (() => {
  'use strict';

  const STORAGE_PREFIX = 'dst_';

  /* --- Helpers --- */
  function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2, 6);
  }

  function now() {
    return new Date().toISOString();
  }

  function getStore(key) {
    try {
      const raw = localStorage.getItem(STORAGE_PREFIX + key);
      return raw ? JSON.parse(raw) : [];
    } catch (e) {
      console.error(`DB: erreur lecture ${key}`, e);
      return [];
    }
  }

  function setStore(key, data) {
    try {
      localStorage.setItem(STORAGE_PREFIX + key, JSON.stringify(data));
    } catch (e) {
      console.error(`DB: erreur écriture ${key}`, e);
    }
  }

  function getConfig(key, defaultVal) {
    try {
      const raw = localStorage.getItem(STORAGE_PREFIX + 'config_' + key);
      return raw ? JSON.parse(raw) : defaultVal;
    } catch (e) {
      return defaultVal;
    }
  }

  function setConfig(key, val) {
    localStorage.setItem(STORAGE_PREFIX + 'config_' + key, JSON.stringify(val));
  }

  /* --- Generic CRUD Factory --- */
  function createCRUD(storeName) {
    return {
      getAll() {
        return getStore(storeName);
      },
      getById(id) {
        return getStore(storeName).find(item => item.id === id) || null;
      },
      create(data) {
        const items = getStore(storeName);
        const record = {
          ...data,
          id: generateId(),
          createdAt: now(),
          updatedAt: now()
        };
        items.push(record);
        setStore(storeName, items);
        return record;
      },
      update(id, data) {
        const items = getStore(storeName);
        const idx = items.findIndex(item => item.id === id);
        if (idx === -1) return null;
        items[idx] = { ...items[idx], ...data, updatedAt: now() };
        setStore(storeName, items);
        return items[idx];
      },
      delete(id) {
        const items = getStore(storeName);
        const filtered = items.filter(item => item.id !== id);
        setStore(storeName, filtered);
        return filtered.length < items.length;
      },
      count() {
        return getStore(storeName).length;
      },
      filter(predicate) {
        return getStore(storeName).filter(predicate);
      },
      find(predicate) {
        return getStore(storeName).find(predicate) || null;
      },
      clear() {
        setStore(storeName, []);
      }
    };
  }

  /* --- Entités métier --- */
  const operators   = createCRUD('operators');
  const modules     = createCRUD('modules');
  const clients     = createCRUD('clients');
  const offers      = createCRUD('offers');
  const sessions    = createCRUD('sessions');
  const locations   = createCRUD('locations');

  /* --- Paramètres économiques --- */
  const DEFAULT_SETTINGS = {
    // Coûts fixes annuels
    fixedCosts: [
      { label: 'Loyer / locaux', amount: 0 },
      { label: 'Assurances', amount: 0 },
      { label: 'Comptabilité / juridique', amount: 0 },
      { label: 'Logiciels / licences', amount: 0 },
      { label: 'Véhicules', amount: 0 },
      { label: 'Communication / marketing', amount: 0 },
      { label: 'Autres charges fixes', amount: 0 }
    ],
    // Taux charges patronales (%)
    employerChargeRate: 45,
    // Marge cible (%)
    targetMarginPercent: 30,
    // Taux TVA (%)
    vatRate: 20,
    // Amortissements matériels annuels
    equipmentAmortization: [
      { label: 'Simulateurs laser', amount: 0, durationYears: 5 },
      { label: 'Matériel pédagogique', amount: 0, durationYears: 3 },
      { label: 'Équipements de protection', amount: 0, durationYears: 3 },
      { label: 'Informatique / serveurs', amount: 0, durationYears: 4 }
    ],
    // Nombre estimé de sessions annuelles (pour répartition coûts fixes)
    estimatedAnnualSessions: 100,
    // Coûts variables par défaut par session
    defaultSessionVariableCosts: [
      { label: 'Consommables', amount: 0 },
      { label: 'Transport / déplacement', amount: 0 },
      { label: 'Location matériel', amount: 0 }
    ],
    // Types de clients (extensible)
    clientTypes: ['Collectivité', 'Police / Gendarmerie', 'Armée', 'Entreprise privée', 'Sécurité privée', 'Particulier', 'Association', 'Autre'],
    // Statuts opérateurs (extensible)
    operatorStatuses: ['freelance', 'interim', 'contrat_journalier', 'cdd', 'cdi', 'fondateur'],
    // Types d'offres
    offerTypes: ['one_shot', 'abonnement', 'personnalisee'],
    // Coefficients intérim
    interimCoefficient: 2.0,
    // Charges freelance estimées (%)
    freelanceChargeRate: 25,
    // Seuil alerte marge (%)
    marginAlertThreshold: 15,
    // Seuil alerte surcharge opérateur (sessions/mois)
    operatorOverloadThreshold: 15,
    // Seuil bascule CDI (sessions/an par opérateur)
    cdiThreshold: 80
  };

  const settings = {
    get() {
      return getConfig('settings', DEFAULT_SETTINGS);
    },
    set(data) {
      setConfig('settings', data);
    },
    update(partial) {
      const current = this.get();
      const merged = { ...current, ...partial };
      this.set(merged);
      return merged;
    },
    reset() {
      this.set(DEFAULT_SETTINGS);
      return DEFAULT_SETTINGS;
    },
    getDefaults() {
      return { ...DEFAULT_SETTINGS };
    }
  };

  /* --- Export / Import complet --- */
  function exportAll() {
    return {
      version: 1,
      exportedAt: now(),
      data: {
        operators: operators.getAll(),
        modules: modules.getAll(),
        clients: clients.getAll(),
        offers: offers.getAll(),
        sessions: sessions.getAll(),
        locations: locations.getAll(),
        settings: settings.get()
      }
    };
  }

  function importAll(dump) {
    if (!dump || !dump.data) throw new Error('Format d\'import invalide');
    const d = dump.data;
    if (d.operators) setStore('operators', d.operators);
    if (d.modules) setStore('modules', d.modules);
    if (d.clients) setStore('clients', d.clients);
    if (d.offers) setStore('offers', d.offers);
    if (d.sessions) setStore('sessions', d.sessions);
    if (d.locations) setStore('locations', d.locations);
    if (d.settings) settings.set(d.settings);
  }

  function clearAll() {
    ['operators','modules','clients','offers','sessions','locations'].forEach(k => setStore(k, []));
    settings.reset();
  }

  /* --- API publique --- */
  return {
    operators,
    modules,
    clients,
    offers,
    sessions,
    locations,
    settings,
    exportAll,
    importAll,
    clearAll,
    generateId
  };
})();
/* ============================================================
   DST-SYSTEM — Moteur Économique
   Calculs : coûts sessions, coûts RH, marges, seuils, alertes
   ============================================================ */

const Engine = (() => {
  'use strict';

  /* ----------------------------------------------------------
     CALCULS RH — Bidirectionnel
     ---------------------------------------------------------- */

  /**
   * Calcul du coût entreprise à partir du net souhaité par l'opérateur.
   * net → brut → brut + charges patronales = coût entreprise
   */
  function netToCompanyCost(netDaily, status, settings) {
    const s = settings || DB.settings.get();
    switch (status) {
      case 'freelance': {
        // Freelance : facture TTC, le net est son prix HT
        // Le coût entreprise = net + charges estimées freelance
        const rate = s.freelanceChargeRate / 100;
        return {
          net: netDaily,
          gross: netDaily / (1 - rate),
          charges: (netDaily / (1 - rate)) - netDaily,
          companyCost: netDaily / (1 - rate)
        };
      }
      case 'interim': {
        // Intérim : coefficient appliqué sur le brut
        const chargeRate = s.employerChargeRate / 100;
        const gross = netDaily / (1 - 0.23); // ~23% salariales estimées
        const baseCost = gross * (1 + chargeRate);
        const companyCost = baseCost * s.interimCoefficient;
        return { net: netDaily, gross: round2(gross), charges: round2(companyCost - gross), companyCost: round2(companyCost) };
      }
      case 'contrat_journalier':
      case 'cdd':
      case 'cdi': {
        const chargeRate = s.employerChargeRate / 100;
        const gross = netDaily / (1 - 0.23);
        const companyCost = gross * (1 + chargeRate);
        // CDD : prime précarité 10% + congés payés 10%
        const cddMult = status === 'cdd' ? 1.20 : 1.0;
        return {
          net: netDaily,
          gross: round2(gross),
          charges: round2(gross * chargeRate * cddMult),
          companyCost: round2(companyCost * cddMult)
        };
      }
      case 'fondateur':
        return { net: netDaily, gross: netDaily, charges: 0, companyCost: 0 };
      default:
        return { net: netDaily, gross: netDaily, charges: 0, companyCost: netDaily };
    }
  }

  /**
   * Calcul du net à partir d'un coût max entreprise.
   * coût entreprise → brut → net
   */
  function companyCostToNet(maxCost, status, settings) {
    const s = settings || DB.settings.get();
    switch (status) {
      case 'freelance': {
        const rate = s.freelanceChargeRate / 100;
        const net = maxCost * (1 - rate);
        return { net: round2(net), gross: maxCost, charges: round2(maxCost - net), companyCost: maxCost };
      }
      case 'interim': {
        const chargeRate = s.employerChargeRate / 100;
        const baseCost = maxCost / s.interimCoefficient;
        const gross = baseCost / (1 + chargeRate);
        const net = gross * (1 - 0.23);
        return { net: round2(net), gross: round2(gross), charges: round2(maxCost - gross), companyCost: maxCost };
      }
      case 'contrat_journalier':
      case 'cdd':
      case 'cdi': {
        const chargeRate = s.employerChargeRate / 100;
        const cddMult = status === 'cdd' ? 1.20 : 1.0;
        const gross = maxCost / ((1 + chargeRate) * cddMult);
        const net = gross * (1 - 0.23);
        return { net: round2(net), gross: round2(gross), charges: round2(maxCost - gross), companyCost: maxCost };
      }
      case 'fondateur':
        return { net: maxCost, gross: maxCost, charges: 0, companyCost: 0 };
      default:
        return { net: maxCost, gross: maxCost, charges: 0, companyCost: maxCost };
    }
  }

  /**
   * Compare tous les statuts pour un objectif net donné.
   * Retourne un tableau trié par coût entreprise croissant.
   */
  function compareAllStatuses(netDaily, settings) {
    const s = settings || DB.settings.get();
    const statuses = ['freelance', 'interim', 'contrat_journalier', 'cdd', 'cdi'];
    return statuses.map(status => ({
      status,
      label: statusLabel(status),
      ...netToCompanyCost(netDaily, status, s)
    })).sort((a, b) => a.companyCost - b.companyCost);
  }

  /* ----------------------------------------------------------
     CALCULS SESSION
     ---------------------------------------------------------- */

  /**
   * Calcule le coût complet d'une session.
   */
  function computeSessionCost(session) {
    const s = DB.settings.get();
    const result = {
      operatorsCost: 0,
      modulesCost: 0,
      variableCosts: 0,
      fixedCostShare: 0,
      amortizationShare: 0,
      totalCost: 0,
      revenue: 0,
      margin: 0,
      marginPercent: 0,
      belowFloor: false,
      floorPrice: 0,
      alerts: []
    };

    // 1. Coûts opérateurs affectés
    if (session.operatorIds && session.operatorIds.length > 0) {
      session.operatorIds.forEach(opId => {
        const op = DB.operators.getById(opId);
        if (op) {
          const cost = getOperatorDailyCost(op, s);
          result.operatorsCost += cost;
        }
      });
    }

    // 2. Coûts modules
    if (session.moduleIds && session.moduleIds.length > 0) {
      session.moduleIds.forEach(modId => {
        const mod = DB.modules.getById(modId);
        if (mod) {
          result.modulesCost += (mod.fixedCost || 0) + (mod.variableCost || 0);
        }
      });
    }

    // 3. Coûts variables de la session
    if (session.variableCosts && session.variableCosts.length > 0) {
      session.variableCosts.forEach(vc => {
        result.variableCosts += (vc.amount || 0);
      });
    }

    // 4. Quote-part coûts fixes annuels
    const totalFixedAnnual = s.fixedCosts.reduce((sum, c) => sum + (c.amount || 0), 0);
    const estSessions = Math.max(s.estimatedAnnualSessions, 1);
    result.fixedCostShare = round2(totalFixedAnnual / estSessions);

    // 5. Quote-part amortissements
    const totalAmort = s.equipmentAmortization.reduce((sum, a) => {
      const years = Math.max(a.durationYears || 1, 1);
      return sum + ((a.amount || 0) / years);
    }, 0);
    result.amortizationShare = round2(totalAmort / estSessions);

    // 6. Coût total
    result.totalCost = round2(
      result.operatorsCost +
      result.modulesCost +
      result.variableCosts +
      result.fixedCostShare +
      result.amortizationShare
    );

    // 7. Seuil plancher (coût total + marge minimale sécurité 5%)
    result.floorPrice = round2(result.totalCost * 1.05);

    // 8. Revenu (prix facturé)
    result.revenue = session.price || 0;

    // 9. Marge
    result.margin = round2(result.revenue - result.totalCost);
    result.marginPercent = result.revenue > 0
      ? round2((result.margin / result.revenue) * 100)
      : 0;

    // 10. Alertes
    if (result.revenue > 0 && result.revenue < result.floorPrice) {
      result.belowFloor = true;
      result.alerts.push({
        level: 'critical',
        message: `Prix (${fmt(result.revenue)}) sous le seuil plancher (${fmt(result.floorPrice)})`
      });
    }

    if (result.marginPercent < s.marginAlertThreshold && result.revenue > 0) {
      result.alerts.push({
        level: 'warning',
        message: `Marge (${result.marginPercent}%) inférieure au seuil d'alerte (${s.marginAlertThreshold}%)`
      });
    }

    if (result.marginPercent < s.targetMarginPercent && result.marginPercent >= s.marginAlertThreshold && result.revenue > 0) {
      result.alerts.push({
        level: 'info',
        message: `Marge (${result.marginPercent}%) sous la cible (${s.targetMarginPercent}%)`
      });
    }

    return result;
  }

  /**
   * Calcule le coût journalier d'un opérateur pour l'entreprise.
   */
  function getOperatorDailyCost(operator, settings) {
    const s = settings || DB.settings.get();
    if (operator.costMode === 'company_max') {
      return operator.companyCostDaily || 0;
    }
    // Mode net souhaité
    const calc = netToCompanyCost(operator.netDaily || 0, operator.status, s);
    return calc.companyCost;
  }

  /* ----------------------------------------------------------
     CALCULS OFFRE / ABONNEMENT
     ---------------------------------------------------------- */

  /**
   * Calcule le prix plancher d'une offre en fonction des sessions prévues.
   */
  function computeOfferFloor(offer) {
    let totalCost = 0;
    const nbSessions = offer.nbSessions || 1;

    // Estimer le coût moyen par session
    if (offer.moduleIds && offer.moduleIds.length > 0) {
      offer.moduleIds.forEach(modId => {
        const mod = DB.modules.getById(modId);
        if (mod) totalCost += (mod.fixedCost || 0) + (mod.variableCost || 0);
      });
    }

    const s = DB.settings.get();
    const totalFixed = s.fixedCosts.reduce((sum, c) => sum + (c.amount || 0), 0);
    const estSessions = Math.max(s.estimatedAnnualSessions, 1);
    const fixedShare = totalFixed / estSessions;

    totalCost += fixedShare;
    totalCost *= nbSessions;

    return round2(totalCost * 1.05); // +5% seuil sécurité
  }

  /* ----------------------------------------------------------
     MOTEUR D'ALERTES GLOBAL
     ---------------------------------------------------------- */

  function computeAllAlerts() {
    const alerts = [];
    const s = DB.settings.get();
    const allSessions = DB.sessions.getAll();
    const allOperators = DB.operators.getAll();

    // 1. Sessions sous seuil plancher
    allSessions.forEach(session => {
      if (session.status === 'annulee') return;
      const cost = computeSessionCost(session);
      cost.alerts.forEach(a => {
        alerts.push({ ...a, context: `Session "${session.label || session.id}"`, sessionId: session.id });
      });
    });

    // 2. Surcharge opérateur
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    const opSessionCount = {};

    allSessions.forEach(session => {
      if (session.status === 'annulee') return;
      const d = new Date(session.date);
      if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
        (session.operatorIds || []).forEach(opId => {
          opSessionCount[opId] = (opSessionCount[opId] || 0) + 1;
        });
      }
    });

    allOperators.forEach(op => {
      const count = opSessionCount[op.id] || 0;
      if (count >= s.operatorOverloadThreshold) {
        alerts.push({
          level: 'warning',
          message: `${op.firstName} ${op.lastName} : ${count} sessions ce mois (seuil : ${s.operatorOverloadThreshold})`,
          context: 'Surcharge RH',
          operatorId: op.id
        });
      }
    });

    // 3. Bascule CDI pertinente
    const yearSessions = allSessions.filter(sess => {
      const d = new Date(sess.date);
      return d.getFullYear() === currentYear && sess.status !== 'annulee';
    });

    allOperators.forEach(op => {
      if (op.status === 'cdi' || op.status === 'fondateur') return;
      const count = yearSessions.filter(sess =>
        (sess.operatorIds || []).includes(op.id)
      ).length;
      if (count >= s.cdiThreshold) {
        alerts.push({
          level: 'info',
          message: `${op.firstName} ${op.lastName} : ${count} sessions/an — envisager un CDI (seuil : ${s.cdiThreshold})`,
          context: 'Arbitrage RH',
          operatorId: op.id
        });
      }
    });

    // 4. Dépendance opérateur (un opérateur fait >40% des sessions)
    if (yearSessions.length > 5) {
      const opCounts = {};
      yearSessions.forEach(sess => {
        (sess.operatorIds || []).forEach(opId => {
          opCounts[opId] = (opCounts[opId] || 0) + 1;
        });
      });
      Object.entries(opCounts).forEach(([opId, count]) => {
        const percent = (count / yearSessions.length) * 100;
        if (percent > 40) {
          const op = DB.operators.getById(opId);
          if (op) {
            alerts.push({
              level: 'warning',
              message: `${op.firstName} ${op.lastName} assure ${round2(percent)}% des sessions — risque de dépendance`,
              context: 'Dépendance opérateur',
              operatorId: op.id
            });
          }
        }
      });
    }

    // 5. Modules non rentables
    const moduleRevenue = {};
    const moduleCosts = {};
    allSessions.forEach(sess => {
      if (sess.status === 'annulee') return;
      const cost = computeSessionCost(sess);
      const nbMods = (sess.moduleIds || []).length || 1;
      (sess.moduleIds || []).forEach(modId => {
        moduleRevenue[modId] = (moduleRevenue[modId] || 0) + ((sess.price || 0) / nbMods);
        moduleCosts[modId] = (moduleCosts[modId] || 0) + (cost.totalCost / nbMods);
      });
    });

    Object.entries(moduleCosts).forEach(([modId, totalC]) => {
      const totalR = moduleRevenue[modId] || 0;
      if (totalR > 0 && totalC > totalR) {
        const mod = DB.modules.getById(modId);
        if (mod) {
          alerts.push({
            level: 'warning',
            message: `Module "${mod.name}" : coût cumulé (${fmt(totalC)}) > revenu cumulé (${fmt(totalR)})`,
            context: 'Module non rentable',
            moduleId: modId
          });
        }
      }
    });

    return alerts;
  }

  /* ----------------------------------------------------------
     KPI DASHBOARD
     ---------------------------------------------------------- */

  function computeDashboardKPIs() {
    const s = DB.settings.get();
    const sessions = DB.sessions.getAll();
    const clients = DB.clients.getAll();
    const operators = DB.operators.getAll();
    const now = new Date();

    const activeClients = clients.filter(c => c.active !== false);
    const upcomingSessions = sessions.filter(sess => new Date(sess.date) >= now && sess.status !== 'annulee');
    const pastSessions = sessions.filter(sess => new Date(sess.date) < now && sess.status !== 'annulee');

    // Marge moyenne
    let totalMargin = 0;
    let countPriced = 0;
    pastSessions.forEach(sess => {
      if (sess.price > 0) {
        const cost = computeSessionCost(sess);
        totalMargin += cost.marginPercent;
        countPriced++;
      }
    });
    const avgMargin = countPriced > 0 ? round2(totalMargin / countPriced) : 0;

    // CA réalisé
    const totalRevenue = pastSessions.reduce((sum, s) => sum + (s.price || 0), 0);

    // CA prévisionnel
    const forecastRevenue = upcomingSessions.reduce((sum, s) => sum + (s.price || 0), 0);

    // Coût total réalisé
    let totalCosts = 0;
    pastSessions.forEach(sess => {
      totalCosts += computeSessionCost(sess).totalCost;
    });

    // Charge opérateur ce mois
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    const monthSessions = sessions.filter(sess => {
      const d = new Date(sess.date);
      return d.getMonth() === currentMonth && d.getFullYear() === currentYear && sess.status !== 'annulee';
    });

    const opLoad = {};
    monthSessions.forEach(sess => {
      (sess.operatorIds || []).forEach(opId => {
        opLoad[opId] = (opLoad[opId] || 0) + 1;
      });
    });
    const maxLoad = Object.values(opLoad).length > 0 ? Math.max(...Object.values(opLoad)) : 0;

    return {
      activeClients: activeClients.length,
      totalClients: clients.length,
      upcomingSessions: upcomingSessions.length,
      pastSessions: pastSessions.length,
      totalSessions: sessions.length,
      avgMargin,
      totalRevenue: round2(totalRevenue),
      forecastRevenue: round2(forecastRevenue),
      totalCosts: round2(totalCosts),
      netResult: round2(totalRevenue - totalCosts),
      totalOperators: operators.length,
      activeOperators: Object.keys(opLoad).length,
      maxOperatorLoad: maxLoad,
      operatorLoadThreshold: s.operatorOverloadThreshold,
      targetMargin: s.targetMarginPercent,
      monthSessions: monthSessions.length
    };
  }

  /* ----------------------------------------------------------
     UTILITAIRES
     ---------------------------------------------------------- */

  function round2(n) {
    return Math.round(n * 100) / 100;
  }

  function fmt(n) {
    return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(n);
  }

  function fmtPercent(n) {
    return n.toFixed(1) + ' %';
  }

  function statusLabel(status) {
    const labels = {
      freelance: 'Freelance',
      interim: 'Intérim',
      contrat_journalier: 'Contrat journalier',
      cdd: 'CDD',
      cdi: 'CDI',
      fondateur: 'Fondateur'
    };
    return labels[status] || status;
  }

  function sessionStatusLabel(status) {
    const labels = {
      planifiee: 'Planifiée',
      confirmee: 'Confirmée',
      en_cours: 'En cours',
      terminee: 'Terminée',
      annulee: 'Annulée'
    };
    return labels[status] || status;
  }

  function offerTypeLabel(type) {
    const labels = {
      one_shot: 'One-shot',
      abonnement: 'Abonnement',
      personnalisee: 'Personnalisée'
    };
    return labels[type] || type;
  }

  /* --- API publique --- */
  return {
    netToCompanyCost,
    companyCostToNet,
    compareAllStatuses,
    computeSessionCost,
    getOperatorDailyCost,
    computeOfferFloor,
    computeAllAlerts,
    computeDashboardKPIs,
    round2,
    fmt,
    fmtPercent,
    statusLabel,
    sessionStatusLabel,
    offerTypeLabel
  };
})();

/* ============================================================
   DST-SYSTEM V2 — Extensions moteur stratégique
   Ajouts : ventilation détaillée, coût/agent/heure/module,
   seuil plancher offre/abo, intelligence RH, prévisionnel.
   NE REMPLACE RIEN — étend Engine existant.
   ============================================================ */

;(function enhanceEngine() {
  'use strict';
  const E = Engine;
  const R = E.round2;

  /* ----------------------------------------------------------
     1. VENTILATION DÉTAILLÉE DU COÛT SESSION
     ---------------------------------------------------------- */

  /**
   * Retourne un objet enrichi avec le détail par opérateur,
   * par module, coût lieu, coût/agent, coût/heure, coût/module.
   */
  E.computeSessionCostDetailed = function(session) {
    const base = E.computeSessionCost(session);
    const s = DB.settings.get();

    /* Détail par opérateur */
    const operatorsDetail = [];
    (session.operatorIds || []).forEach(opId => {
      const op = DB.operators.getById(opId);
      if (op) {
        const cost = E.getOperatorDailyCost(op, s);
        operatorsDetail.push({
          id: op.id,
          name: (op.firstName || '') + ' ' + (op.lastName || ''),
          status: op.status,
          dailyCost: R(cost)
        });
      }
    });

    /* Détail par module */
    const modulesDetail = [];
    (session.moduleIds || []).forEach(modId => {
      const mod = DB.modules.getById(modId);
      if (mod) {
        modulesDetail.push({
          id: mod.id,
          name: mod.name || mod.label || '',
          fixedCost: mod.fixedCost || 0,
          variableCost: mod.variableCost || 0,
          totalCost: R((mod.fixedCost || 0) + (mod.variableCost || 0)),
          duration: mod.duration || 0
        });
      }
    });

    /* Coût lieu */
    let locationCost = 0;
    let locationName = '—';
    if (session.locationId) {
      const loc = DB.locations.getById(session.locationId);
      if (loc) {
        locationCost = loc.costPerSession || 0;
        locationName = loc.name || loc.label || '—';
      }
    }

    /* Durée totale session (somme durées modules, min 1h) */
    const totalHours = Math.max(modulesDetail.reduce((s, m) => s + (m.duration || 0), 0), 1);
    const nbOperators = Math.max(operatorsDetail.length, 1);

    /* Coûts unitaires */
    const costPerAgent = R(base.totalCost / nbOperators);
    const costPerHour = R(base.totalCost / totalHours);
    const costPerModule = modulesDetail.length > 0
      ? R(base.totalCost / modulesDetail.length)
      : base.totalCost;

    return {
      ...base,
      operatorsDetail,
      modulesDetail,
      locationCost: R(locationCost),
      locationName,
      totalHours,
      costPerAgent,
      costPerHour,
      costPerModule,
      nbOperators
    };
  };

  /* ----------------------------------------------------------
     2. SEUIL PLANCHER ENRICHI (offre, abonnement, mutualisation)
     ---------------------------------------------------------- */

  /**
   * Seuil plancher avancé pour offre/abonnement.
   * Prend en compte les opérateurs moyens, la mutualisation multi-clients.
   */
  E.computeOfferFloorDetailed = function(offer) {
    const s = DB.settings.get();
    const nbSessions = Math.max(offer.nbSessions || 1, 1);
    const nbClients = Math.max((offer.clientIds || []).length, 1);

    let moduleCostPerSession = 0;
    (offer.moduleIds || []).forEach(modId => {
      const mod = DB.modules.getById(modId);
      if (mod) moduleCostPerSession += (mod.fixedCost || 0) + (mod.variableCost || 0);
    });

    const totalFixed = s.fixedCosts.reduce((sum, c) => sum + (c.amount || 0), 0);
    const totalAmort = s.equipmentAmortization.reduce((sum, a) => {
      return sum + ((a.amount || 0) / Math.max(a.durationYears || 1, 1));
    }, 0);
    const est = Math.max(s.estimatedAnnualSessions, 1);
    const fixedShare = (totalFixed + totalAmort) / est;

    const costPerSession = moduleCostPerSession + fixedShare;
    const totalCost = costPerSession * nbSessions;
    const floorTotal = R(totalCost * 1.05);
    const floorPerSession = R(floorTotal / nbSessions);
    const floorPerClient = R(floorTotal / nbClients);
    const pricePerSession = R((offer.price || 0) / nbSessions);
    const pricePerClient = R((offer.price || 0) / nbClients);
    const marginPercent = (offer.price || 0) > 0
      ? R(((offer.price - totalCost) / offer.price) * 100)
      : 0;

    return {
      totalCost: R(totalCost),
      costPerSession: R(costPerSession),
      floorTotal,
      floorPerSession,
      floorPerClient,
      pricePerSession,
      pricePerClient,
      marginPercent,
      isBelowFloor: (offer.price || 0) > 0 && offer.price < floorTotal,
      nbClients,
      nbSessions
    };
  };

  /* ----------------------------------------------------------
     3. INTELLIGENCE RH — Score de pertinence & recommandations
     ---------------------------------------------------------- */

  /**
   * Calcule un score de pertinence RH et des recommandations
   * pour chaque opérateur : bascule CDI, dépendance, projection.
   */
  E.computeHRIntelligence = function() {
    const s = DB.settings.get();
    const operators = DB.operators.getAll();
    const allSessions = DB.sessions.getAll();
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth();
    const results = [];

    /* Sessions de l'année en cours, non annulées */
    const yearSessions = allSessions.filter(sess => {
      const d = new Date(sess.date);
      return d.getFullYear() === currentYear && sess.status !== 'annulee';
    });

    /* Calculer les sessions des 6 derniers mois par mois */
    const monthlyData = {};
    for (let i = 5; i >= 0; i--) {
      const m = new Date(currentYear, currentMonth - i, 1);
      const key = m.getFullYear() + '-' + String(m.getMonth() + 1).padStart(2, '0');
      monthlyData[key] = {};
    }

    allSessions.forEach(sess => {
      if (sess.status === 'annulee') return;
      const d = new Date(sess.date);
      const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
      if (monthlyData[key]) {
        (sess.operatorIds || []).forEach(opId => {
          monthlyData[key][opId] = (monthlyData[key][opId] || 0) + 1;
        });
      }
    });

    const monthKeys = Object.keys(monthlyData).sort();
    const totalYearSessions = yearSessions.length;

    operators.forEach(op => {
      if (op.active === false) return;

      /* Sessions annuelles de cet opérateur */
      const opYearCount = yearSessions.filter(sess =>
        (sess.operatorIds || []).includes(op.id)
      ).length;

      /* Charge mensuelle moyenne sur 6 mois */
      const monthCounts = monthKeys.map(k => monthlyData[k][op.id] || 0);
      const avgMonthly = monthCounts.length > 0
        ? R(monthCounts.reduce((a, b) => a + b, 0) / monthCounts.length)
        : 0;

      /* Tendance (linéaire simple) */
      let trend = 0;
      if (monthCounts.length >= 3) {
        const firstHalf = monthCounts.slice(0, 3).reduce((a, b) => a + b, 0) / 3;
        const secondHalf = monthCounts.slice(3).reduce((a, b) => a + b, 0) / Math.max(monthCounts.slice(3).length, 1);
        trend = R(secondHalf - firstHalf);
      }

      /* Coût entreprise journalier actuel */
      const currentCost = E.getOperatorDailyCost(op, s);
      const currentAnnualCost = R(currentCost * opYearCount);

      /* Comparer tous les statuts pour ce net */
      const netDaily = op.costMode === 'company_max'
        ? E.companyCostToNet(op.companyCostDaily || 0, op.status, s).net
        : (op.netDaily || 0);
      const comparison = E.compareAllStatuses(netDaily, s);

      /* CDI : projeter quand CDI devient rentable */
      const cdiData = comparison.find(c => c.status === 'cdi');
      const currentData = comparison.find(c => c.status === op.status) || comparison[0];
      let cdiBreakEvenMonths = null;
      let cdiRecommendation = null;

      if (op.status !== 'cdi' && op.status !== 'fondateur' && cdiData && currentData) {
        const monthlySavingPerSession = currentData.companyCost - cdiData.companyCost;
        if (monthlySavingPerSession > 0 && avgMonthly > 0) {
          /* CDI est déjà plus rentable par session */
          cdiBreakEvenMonths = 0;
          cdiRecommendation = `CDI immédiatement avantageux : économie de ${E.fmt(monthlySavingPerSession)}/j, soit ~${E.fmt(R(monthlySavingPerSession * avgMonthly))}/mois`;
        } else if (monthlySavingPerSession < 0) {
          /* À quel volume CDI devient rentable ? Calcul seuil */
          const cdiFixedOverhead = R(cdiData.companyCost * 22); /* ~22 jours/mois de "disponibilité" */
          const currentMonthlyCost = R(currentData.companyCost * avgMonthly);
          if (currentMonthlyCost > 0) {
            const breakEvenSessions = Math.ceil(cdiFixedOverhead / currentData.companyCost);
            if (avgMonthly > 0 && trend > 0) {
              const monthsToBreakEven = Math.ceil((breakEvenSessions - avgMonthly) / trend);
              cdiBreakEvenMonths = monthsToBreakEven > 0 ? monthsToBreakEven : null;
              if (cdiBreakEvenMonths && cdiBreakEvenMonths <= 12) {
                cdiRecommendation = `À volume croissant, CDI devient plus rentable dans ~${cdiBreakEvenMonths} mois`;
              }
            }
            if (opYearCount >= s.cdiThreshold) {
              cdiRecommendation = `${opYearCount} sessions/an atteint — passage CDI recommandé (seuil : ${s.cdiThreshold})`;
            }
          }
        }
      }

      /* Dépendance */
      const dependencyPercent = totalYearSessions > 0
        ? R((opYearCount / totalYearSessions) * 100)
        : 0;
      const isDependency = dependencyPercent > 40 && totalYearSessions > 5;

      /* Projection charge à +3, +6, +12 mois */
      const proj3 = R(avgMonthly + trend * 3);
      const proj6 = R(avgMonthly + trend * 6);
      const proj12 = R(avgMonthly + trend * 12);

      /* Score de pertinence (0-100) : coût le moins cher = 100 */
      const cheapest = comparison[0];
      const pertinenceScore = cheapest && currentData && currentData.companyCost > 0
        ? R((cheapest.companyCost / currentData.companyCost) * 100)
        : 100;

      /* Recommandations compilées */
      const recommendations = [];

      if (isDependency) {
        recommendations.push({
          level: 'critical',
          title: 'Dépendance critique',
          text: `Cet opérateur assure ${dependencyPercent}% des sessions. Diversifier le vivier est urgent.`
        });
      }

      if (cdiRecommendation) {
        recommendations.push({
          level: opYearCount >= s.cdiThreshold ? 'warning' : 'info',
          title: 'Arbitrage RH',
          text: cdiRecommendation
        });
      }

      if (pertinenceScore < 80 && op.status !== 'fondateur') {
        const best = comparison[0];
        recommendations.push({
          level: 'info',
          title: 'Optimisation statut',
          text: `Statut actuel (${E.statusLabel(op.status)}) coûte ${E.fmt(currentData.companyCost)}/j. Le statut ${best.label} coûterait ${E.fmt(best.companyCost)}/j (−${E.fmt(R(currentData.companyCost - best.companyCost))}).`
        });
      }

      const overloadThreshold = s.operatorOverloadThreshold;
      if (proj3 >= overloadThreshold || proj6 >= overloadThreshold) {
        const when = proj3 >= overloadThreshold ? '3 mois' : '6 mois';
        recommendations.push({
          level: 'warning',
          title: 'Surcharge projetée',
          text: `Charge projetée à ${when} : ${Math.max(proj3, proj6).toFixed(0)} sess/mois (seuil : ${overloadThreshold}). Anticiper un recrutement.`
        });
      }

      results.push({
        operator: op,
        opYearCount,
        avgMonthly,
        trend,
        trendLabel: trend > 0.5 ? 'hausse' : trend < -0.5 ? 'baisse' : 'stable',
        currentCost,
        currentAnnualCost,
        pertinenceScore,
        comparison,
        cdiBreakEvenMonths,
        dependencyPercent,
        isDependency,
        proj3: Math.max(proj3, 0),
        proj6: Math.max(proj6, 0),
        proj12: Math.max(proj12, 0),
        recommendations,
        monthCounts
      });
    });

    return results.sort((a, b) => b.opYearCount - a.opYearCount);
  };

  /* ----------------------------------------------------------
     4. ALERTES OFFRES / ABONNEMENTS
     ---------------------------------------------------------- */

  /**
   * Alertes avancées pour offres et abonnements.
   */
  E.computeOfferAlerts = function() {
    const alerts = [];
    const offers = DB.offers.getAll();
    const now = new Date();

    offers.forEach(offer => {
      if (offer.active === false) return;

      /* Fin d'abonnement imminente (< 30 jours) */
      if (offer.endDate) {
        const end = new Date(offer.endDate);
        const daysLeft = Math.ceil((end - now) / (1000 * 60 * 60 * 24));
        if (daysLeft <= 30 && daysLeft > 0) {
          alerts.push({
            level: 'warning',
            context: 'Abonnement',
            offerId: offer.id,
            message: `"${offer.label}" expire dans ${daysLeft} jour(s) — penser au renouvellement.`
          });
        } else if (daysLeft <= 0) {
          alerts.push({
            level: 'critical',
            context: 'Abonnement expiré',
            offerId: offer.id,
            message: `"${offer.label}" a expiré le ${end.toLocaleDateString('fr-FR')}.`
          });
        }
      }

      /* Sessions restantes faibles (abonnement) */
      if (offer.type === 'abonnement' && offer.nbSessions > 0) {
        const consumed = offer.sessionsConsumed || 0;
        const remaining = offer.nbSessions - consumed;
        if (remaining <= 2 && remaining > 0) {
          alerts.push({
            level: 'warning',
            context: 'Consommation abonnement',
            offerId: offer.id,
            message: `"${offer.label}" : seulement ${remaining} session(s) restante(s) sur ${offer.nbSessions}.`
          });
        } else if (remaining <= 0) {
          alerts.push({
            level: 'critical',
            context: 'Abonnement épuisé',
            offerId: offer.id,
            message: `"${offer.label}" : toutes les sessions ont été consommées (${consumed}/${offer.nbSessions}).`
          });
        }
      }

      /* Offre structurellement déficitaire */
      const floor = E.computeOfferFloorDetailed(offer);
      if (floor.isBelowFloor) {
        alerts.push({
          level: 'critical',
          context: 'Offre déficitaire',
          offerId: offer.id,
          message: `"${offer.label}" : prix (${E.fmt(offer.price)}) sous le seuil plancher (${E.fmt(floor.floorTotal)}). Marge : ${floor.marginPercent}%.`
        });
      }
    });

    return alerts;
  };

  /* ----------------------------------------------------------
     5. PRÉVISIONNEL — Projection tendancielle
     ---------------------------------------------------------- */

  /**
   * Projections à 3, 6, 12 mois basées sur les tendances des 6 derniers mois.
   */
  E.computeForecasts = function() {
    const s = DB.settings.get();
    const allSessions = DB.sessions.getAll();
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth();

    /* Volume mensuel sur les 6 derniers mois */
    const monthlyVolume = [];
    const monthlyRevenue = [];
    const monthlyCost = [];

    for (let i = 5; i >= 0; i--) {
      const m = new Date(currentYear, currentMonth - i, 1);
      const mEnd = new Date(currentYear, currentMonth - i + 1, 0);
      const month = m.getMonth();
      const year = m.getFullYear();

      const monthSessions = allSessions.filter(sess => {
        if (sess.status === 'annulee') return false;
        const d = new Date(sess.date);
        return d.getMonth() === month && d.getFullYear() === year;
      });

      let rev = 0, cost = 0;
      monthSessions.forEach(sess => {
        rev += (sess.price || 0);
        cost += E.computeSessionCost(sess).totalCost;
      });

      const label = m.toLocaleDateString('fr-FR', { month: 'short', year: '2-digit' });
      monthlyVolume.push({ label, count: monthSessions.length });
      monthlyRevenue.push({ label, amount: R(rev) });
      monthlyCost.push({ label, amount: R(cost) });
    }

    /* Tendances linéaires */
    function linearTrend(values) {
      const n = values.length;
      if (n < 2) return 0;
      let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
      values.forEach((v, i) => {
        sumX += i; sumY += v; sumXY += i * v; sumXX += i * i;
      });
      const denom = n * sumXX - sumX * sumX;
      return denom !== 0 ? (n * sumXY - sumX * sumY) / denom : 0;
    }

    const volumeValues = monthlyVolume.map(m => m.count);
    const revenueValues = monthlyRevenue.map(m => m.amount);
    const costValues = monthlyCost.map(m => m.amount);

    const volumeTrend = linearTrend(volumeValues);
    const revenueTrend = linearTrend(revenueValues);

    const avgVolume = volumeValues.reduce((a, b) => a + b, 0) / volumeValues.length || 0;
    const avgRevenue = revenueValues.reduce((a, b) => a + b, 0) / revenueValues.length || 0;
    const avgCost = costValues.reduce((a, b) => a + b, 0) / costValues.length || 0;
    const avgMargin = avgRevenue > 0 ? R(((avgRevenue - avgCost) / avgRevenue) * 100) : 0;

    /* Projections */
    function project(base, trend, months) {
      return Math.max(R(base + trend * months), 0);
    }

    const projections = {
      volume: {
        m3: project(avgVolume, volumeTrend, 3),
        m6: project(avgVolume, volumeTrend, 6),
        m12: project(avgVolume, volumeTrend, 12)
      },
      revenue: {
        m3: project(avgRevenue, revenueTrend, 3),
        m6: project(avgRevenue, revenueTrend, 6),
        m12: project(avgRevenue, revenueTrend, 12)
      },
      margin: {
        current: avgMargin,
        trend: revenueTrend > 0 ? 'hausse' : revenueTrend < 0 ? 'baisse' : 'stable'
      }
    };

    /* HR : charge projetée et seuil de recrutement */
    const operators = DB.operators.getAll().filter(o => o.active !== false);
    const capaciteTotale = operators.length * s.operatorOverloadThreshold;
    const chargeActuelle = avgVolume;

    let recruitmentNeeded = null;
    if (projections.volume.m6 > capaciteTotale && operators.length > 0) {
      const shortfall = Math.ceil(projections.volume.m6 / s.operatorOverloadThreshold) - operators.length;
      recruitmentNeeded = {
        horizon: '6 mois',
        count: shortfall,
        message: `Recrutement de ${shortfall} opérateur(s) recommandé sous 6 mois pour absorber la charge projetée.`
      };
    } else if (projections.volume.m12 > capaciteTotale && operators.length > 0) {
      const shortfall = Math.ceil(projections.volume.m12 / s.operatorOverloadThreshold) - operators.length;
      recruitmentNeeded = {
        horizon: '12 mois',
        count: shortfall,
        message: `Recrutement de ${shortfall} opérateur(s) à prévoir sous 12 mois.`
      };
    }

    /* Statut recommandé pour un recrutement */
    let recruitmentStatus = null;
    if (recruitmentNeeded) {
      const testNet = 200; /* net journalier estimé pour comparaison */
      const comp = E.compareAllStatuses(testNet, s);
      recruitmentStatus = comp[0]; /* Le moins cher */
    }

    return {
      monthlyVolume,
      monthlyRevenue,
      monthlyCost,
      avgVolume: R(avgVolume),
      avgRevenue: R(avgRevenue),
      avgCost: R(avgCost),
      avgMargin,
      volumeTrend: R(volumeTrend),
      revenueTrend: R(revenueTrend),
      projections,
      capaciteTotale,
      chargeActuelle: R(chargeActuelle),
      recruitmentNeeded,
      recruitmentStatus,
      trendLabel: volumeTrend > 0.3 ? 'hausse' : volumeTrend < -0.3 ? 'baisse' : 'stable'
    };
  };

  /* ----------------------------------------------------------
     6. EXTENSION computeAllAlerts — ajouter alertes V2
     ---------------------------------------------------------- */
  const _originalAlerts = E.computeAllAlerts;
  E.computeAllAlerts = function() {
    const base = _originalAlerts.call(E);
    const offerAlerts = E.computeOfferAlerts();
    return base.concat(offerAlerts);
  };

})();
/* ============================================================
   DST-SYSTEM — Vue Tableau de Bord (Dashboard)
   Poste de commandement stratégique pour le dirigeant.
   Synthèse économique, alertes, sessions, charge opérateurs.
   ============================================================ */

window.Views = window.Views || {};

Views.Dashboard = {

  /**
   * Rendu complet du tableau de bord exécutif.
   * @param {HTMLElement} container — élément DOM cible
   */
  render(container) {
    'use strict';

    const settings  = DB.settings.get();
    const kpis      = Engine.computeDashboardKPIs();
    const alerts    = Engine.computeAllAlerts();
    const sessions  = DB.sessions.getAll();
    const now       = new Date();

    /* ----------------------------------------------------------
       1. CONSTRUCTION DES CARTES KPI
       ---------------------------------------------------------- */

    /** Détermine la classe CSS de la marge en fonction des seuils */
    function marginClass(avgMargin) {
      if (avgMargin >= settings.targetMarginPercent) return 'kpi-success';
      if (avgMargin >= settings.marginAlertThreshold) return 'kpi-warning';
      return 'kpi-alert';
    }

    /** Détermine la classe CSS du résultat net */
    function netResultClass(val) {
      return val >= 0 ? 'kpi-success' : 'kpi-alert';
    }

    /** Détermine la classe CSS de la charge opérateur */
    function loadClass(maxLoad, threshold) {
      const ratio = threshold > 0 ? maxLoad / threshold : 0;
      if (ratio >= 1)   return 'kpi-alert';
      if (ratio >= 0.7) return 'kpi-warning';
      return '';
    }

    const kpiCardsHTML = `
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-label">Clients actifs</div>
          <div class="kpi-value">${kpis.activeClients}</div>
          <div class="kpi-detail">sur ${kpis.totalClients} au total</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Sessions à venir</div>
          <div class="kpi-value">${kpis.upcomingSessions}</div>
          <div class="kpi-detail">${kpis.totalSessions} sessions au total</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Sessions ce mois</div>
          <div class="kpi-value">${kpis.monthSessions}</div>
          <div class="kpi-detail">${kpis.activeOperators} opérateur(s) mobilisé(s)</div>
        </div>
        <div class="kpi-card ${marginClass(kpis.avgMargin)}">
          <div class="kpi-label">Marge moyenne</div>
          <div class="kpi-value">${Engine.fmtPercent(kpis.avgMargin)}</div>
          <div class="kpi-detail">Cible : ${Engine.fmtPercent(settings.targetMarginPercent)}</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">CA réalisé</div>
          <div class="kpi-value text-mono">${Engine.fmt(kpis.totalRevenue)}</div>
          <div class="kpi-detail">${kpis.pastSessions} session(s) facturée(s)</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">CA prévisionnel</div>
          <div class="kpi-value text-mono">${Engine.fmt(kpis.forecastRevenue)}</div>
          <div class="kpi-detail">${kpis.upcomingSessions} session(s) planifiée(s)</div>
        </div>
        <div class="kpi-card ${netResultClass(kpis.netResult)}">
          <div class="kpi-label">Résultat net</div>
          <div class="kpi-value text-mono">${Engine.fmt(kpis.netResult)}</div>
          <div class="kpi-detail">Coûts totaux : ${Engine.fmt(kpis.totalCosts)}</div>
        </div>
        <div class="kpi-card ${loadClass(kpis.maxOperatorLoad, kpis.operatorLoadThreshold)}">
          <div class="kpi-label">Charge opérateur max</div>
          <div class="kpi-value">${kpis.maxOperatorLoad} <span style="font-size:0.9rem;font-weight:400;">sess/mois</span></div>
          <div class="kpi-detail">Seuil : ${kpis.operatorLoadThreshold} sessions/mois</div>
        </div>
      </div>
    `;

    /* ----------------------------------------------------------
       2. SECTION ALERTES INTELLIGENTES
       ---------------------------------------------------------- */

    function buildAlertsHTML() {
      if (alerts.length === 0) {
        return `
          <div class="card">
            <div class="card-header"><h2>Alertes intelligentes</h2></div>
            <div class="alert alert-success">
              <span class="alert-icon">&#10003;</span>
              <span>Aucune alerte — tous les indicateurs sont nominaux.</span>
            </div>
          </div>
        `;
      }

      /* Regrouper les alertes par contexte */
      const grouped = {};
      alerts.forEach(a => {
        const ctx = a.context || 'Général';
        if (!grouped[ctx]) grouped[ctx] = [];
        grouped[ctx].push(a);
      });

      /** Icône et classe selon le niveau d'alerte */
      function alertStyle(level) {
        switch (level) {
          case 'critical': return { cls: 'alert-danger',  icon: '\u26A0' };  // ⚠
          case 'warning':  return { cls: 'alert-warning', icon: '\u26A1' };  // ⚡
          case 'info':     return { cls: 'alert-info',    icon: '\u2139' };  // ℹ
          default:         return { cls: 'alert-info',    icon: '\u2139' };
        }
      }

      let alertsInner = '';
      Object.keys(grouped).forEach(ctx => {
        alertsInner += `<div class="mb-8" style="font-size:0.78rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;">${escapeHTML(ctx)}</div>`;
        grouped[ctx].forEach(a => {
          const style = alertStyle(a.level);
          alertsInner += `
            <div class="alert ${style.cls}">
              <span class="alert-icon">${style.icon}</span>
              <span>${escapeHTML(a.message)}</span>
            </div>
          `;
        });
      });

      return `
        <div class="card">
          <div class="card-header">
            <h2>Alertes intelligentes</h2>
            <span class="tag tag-red">${alerts.length} alerte${alerts.length > 1 ? 's' : ''}</span>
          </div>
          ${alertsInner}
        </div>
      `;
    }

    /* ----------------------------------------------------------
       3. TABLEAU DES PROCHAINES SESSIONS
       ---------------------------------------------------------- */

    function buildUpcomingSessionsHTML() {
      /* Filtrer les sessions futures, trier par date, limiter à 10 */
      const upcoming = sessions
        .filter(s => new Date(s.date) >= now && s.status !== 'annulee')
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .slice(0, 10);

      if (upcoming.length === 0) {
        return `
          <div class="card">
            <div class="card-header"><h2>Prochaines sessions</h2></div>
            <div class="empty-state">
              <div class="empty-icon">&#128197;</div>
              <p>Aucune session à venir.</p>
            </div>
          </div>
        `;
      }

      /** Classe CSS pour le tag de statut */
      function statusTagClass(status) {
        switch (status) {
          case 'confirmee': return 'tag-green';
          case 'planifiee': return 'tag-blue';
          case 'en_cours':  return 'tag-yellow';
          case 'terminee':  return 'tag-neutral';
          case 'annulee':   return 'tag-red';
          default:          return 'tag-neutral';
        }
      }

      /** Formater la date en français court */
      function fmtDate(isoDate) {
        const d = new Date(isoDate);
        return d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
      }

      /** Récupérer les noms des clients liés à une session */
      function getClientNames(session) {
        const ids = session.clientIds || (session.clientId ? [session.clientId] : []);
        if (ids.length === 0) return '<span class="text-muted">—</span>';
        return ids.map(id => {
          const client = DB.clients.getById(id);
          return client ? escapeHTML(client.name || client.label || client.company || id) : escapeHTML(id);
        }).join(', ');
      }

      /** Récupérer le nom du lieu */
      function getLocationName(session) {
        if (!session.locationId) return '<span class="text-muted">—</span>';
        const loc = DB.locations.getById(session.locationId);
        return loc ? escapeHTML(loc.name || loc.label || session.locationId) : escapeHTML(session.locationId);
      }

      let rowsHTML = '';
      upcoming.forEach(sess => {
        const cost = Engine.computeSessionCost(sess);
        const marginDisplay = sess.price > 0
          ? `<span class="${cost.marginPercent < settings.marginAlertThreshold ? 'text-red' : cost.marginPercent < settings.targetMarginPercent ? 'text-yellow' : 'text-green'} font-bold">${Engine.fmtPercent(cost.marginPercent)}</span>`
          : '<span class="text-muted">—</span>';

        rowsHTML += `
          <tr>
            <td class="text-mono">${fmtDate(sess.date)}</td>
            <td>${escapeHTML(sess.label || sess.name || '—')}</td>
            <td>${getClientNames(sess)}</td>
            <td>${getLocationName(sess)}</td>
            <td><span class="tag ${statusTagClass(sess.status)}">${Engine.sessionStatusLabel(sess.status)}</span></td>
            <td class="num">${marginDisplay}</td>
          </tr>
        `;
      });

      return `
        <div class="card">
          <div class="card-header">
            <h2>Prochaines sessions</h2>
            <span class="text-muted" style="font-size:0.82rem;">${upcoming.length} session${upcoming.length > 1 ? 's' : ''} affichée${upcoming.length > 1 ? 's' : ''}</span>
          </div>
          <div class="data-table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Libellé</th>
                  <th>Client(s)</th>
                  <th>Lieu</th>
                  <th>Statut</th>
                  <th class="text-right">Marge %</th>
                </tr>
              </thead>
              <tbody>
                ${rowsHTML}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    /* ----------------------------------------------------------
       4. SYNTHÈSE ÉCONOMIQUE
       ---------------------------------------------------------- */

    function buildEconomicSummaryHTML() {
      /* Calcul des coûts fixes annuels totaux */
      const totalFixedAnnual = settings.fixedCosts.reduce((sum, c) => sum + (c.amount || 0), 0);

      /* Calcul des amortissements annuels totaux */
      const totalAmortAnnual = settings.equipmentAmortization.reduce((sum, a) => {
        const years = Math.max(a.durationYears || 1, 1);
        return sum + ((a.amount || 0) / years);
      }, 0);

      /* Quote-part par session */
      const estSessions = Math.max(settings.estimatedAnnualSessions, 1);
      const fixedPerSession = totalFixedAnnual / estSessions;
      const amortPerSession = totalAmortAnnual / estSessions;
      const costPerSession  = Engine.round2(fixedPerSession + amortPerSession);

      /* Comparaison visuelle marge cible vs marge réelle */
      const targetMargin = settings.targetMarginPercent;
      const actualMargin = kpis.avgMargin;
      const maxMarginScale = Math.max(targetMargin, actualMargin, 1);

      const targetBarWidth = Math.min((targetMargin / maxMarginScale) * 100, 100);
      const actualBarWidth = Math.min((actualMargin / maxMarginScale) * 100, 100);
      const actualBarColor = actualMargin >= targetMargin ? 'fill-green' : actualMargin >= settings.marginAlertThreshold ? 'fill-yellow' : 'fill-red';

      return `
        <div class="card">
          <div class="card-header"><h2>Synthèse économique</h2></div>

          <div class="grid-2 mb-16">
            <div>
              <div style="font-size:0.78rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px;">Charges fixes / an</div>
              <div class="text-mono font-bold" style="font-size:1.2rem;">${Engine.fmt(totalFixedAnnual)}</div>
            </div>
            <div>
              <div style="font-size:0.78rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px;">Amortissements / an</div>
              <div class="text-mono font-bold" style="font-size:1.2rem;">${Engine.fmt(Engine.round2(totalAmortAnnual))}</div>
            </div>
          </div>

          <div class="mb-16">
            <div style="font-size:0.78rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px;">Coût fixe par session (quote-part)</div>
            <div class="text-mono font-bold" style="font-size:1.2rem;">${Engine.fmt(costPerSession)}</div>
            <div style="font-size:0.78rem;color:var(--text-secondary);margin-top:2px;">
              Basé sur ${estSessions} sessions estimées/an (fixes : ${Engine.fmt(Engine.round2(fixedPerSession))} + amort. : ${Engine.fmt(Engine.round2(amortPerSession))})
            </div>
          </div>

          <div>
            <div style="font-size:0.78rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px;">Marge cible vs marge réelle</div>

            <div class="flex-between mb-8">
              <span style="font-size:0.82rem;">Cible</span>
              <span class="text-mono font-bold">${Engine.fmtPercent(targetMargin)}</span>
            </div>
            <div class="progress-bar mb-16" style="height:10px;">
              <div class="progress-fill fill-blue" style="width:${targetBarWidth}%;"></div>
            </div>

            <div class="flex-between mb-8">
              <span style="font-size:0.82rem;">Réelle</span>
              <span class="text-mono font-bold ${actualMargin >= targetMargin ? 'text-green' : actualMargin >= settings.marginAlertThreshold ? 'text-yellow' : 'text-red'}">${Engine.fmtPercent(actualMargin)}</span>
            </div>
            <div class="progress-bar" style="height:10px;">
              <div class="progress-fill ${actualBarColor}" style="width:${actualBarWidth}%;"></div>
            </div>

            ${actualMargin < targetMargin
              ? `<div style="font-size:0.78rem;color:var(--color-warning);margin-top:8px;">Écart : ${Engine.fmtPercent(Engine.round2(targetMargin - actualMargin))} sous la cible</div>`
              : `<div style="font-size:0.78rem;color:var(--color-success);margin-top:8px;">Marge supérieure à la cible de ${Engine.fmtPercent(Engine.round2(actualMargin - targetMargin))}</div>`
            }
          </div>
        </div>
      `;
    }

    /* ----------------------------------------------------------
       5. CHARGE OPÉRATEURS
       ---------------------------------------------------------- */

    function buildOperatorLoadHTML() {
      const operators  = DB.operators.getAll();
      const threshold  = settings.operatorOverloadThreshold;
      const currentMonth = now.getMonth();
      const currentYear  = now.getFullYear();

      /* Compter les sessions par opérateur ce mois-ci */
      const opSessionCount = {};
      sessions.forEach(sess => {
        if (sess.status === 'annulee') return;
        const d = new Date(sess.date);
        if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
          (sess.operatorIds || []).forEach(opId => {
            opSessionCount[opId] = (opSessionCount[opId] || 0) + 1;
          });
        }
      });

      /* Trier par charge décroissante, top 5 */
      const ranked = Object.entries(opSessionCount)
        .map(([opId, count]) => {
          const op = DB.operators.getById(opId);
          return {
            id: opId,
            name: op ? `${op.firstName || ''} ${op.lastName || ''}`.trim() : opId,
            count
          };
        })
        .sort((a, b) => b.count - a.count)
        .slice(0, 5);

      if (ranked.length === 0) {
        return `
          <div class="card">
            <div class="card-header"><h2>Charge opérateurs — ce mois</h2></div>
            <div class="empty-state">
              <div class="empty-icon">&#128100;</div>
              <p>Aucun opérateur planifié ce mois-ci.</p>
            </div>
          </div>
        `;
      }

      /** Couleur de la barre selon le ratio charge/seuil */
      function barColor(count) {
        if (threshold <= 0) return 'fill-green';
        const ratio = count / threshold;
        if (ratio >= 1)   return 'fill-red';
        if (ratio >= 0.7) return 'fill-yellow';
        return 'fill-green';
      }

      let barsHTML = '';
      ranked.forEach(op => {
        const percent = threshold > 0 ? Math.min((op.count / threshold) * 100, 100) : 100;
        const colorClass = barColor(op.count);

        barsHTML += `
          <div class="mb-16">
            <div class="flex-between mb-8">
              <span style="font-size:0.88rem;">${escapeHTML(op.name)}</span>
              <span class="text-mono font-bold">${op.count} / ${threshold}</span>
            </div>
            <div class="progress-bar" style="height:10px;">
              <div class="progress-fill ${colorClass}" style="width:${percent}%;"></div>
            </div>
          </div>
        `;
      });

      return `
        <div class="card">
          <div class="card-header">
            <h2>Charge opérateurs — ce mois</h2>
            <span class="text-muted" style="font-size:0.82rem;">Top 5 — seuil : ${threshold} sess/mois</span>
          </div>
          ${barsHTML}
        </div>
      `;
    }

    /* ----------------------------------------------------------
       6. UTILITAIRE — Échappement HTML
       ---------------------------------------------------------- */

    function escapeHTML(str) {
      if (str == null) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    /* ----------------------------------------------------------
       7. VUE PRÉVISIONNELLE (V2)
       ---------------------------------------------------------- */

    function buildForecastHTML() {
      try {
        const fc = Engine.computeForecasts();
        const trendIcon = fc.trendLabel === 'hausse' ? '&#x25B2;' : fc.trendLabel === 'baisse' ? '&#x25BC;' : '&#x25CF;';
        const trendClass = fc.trendLabel === 'hausse' ? 'trend-up' : fc.trendLabel === 'baisse' ? 'trend-down' : 'trend-flat';

        /* Historique volume mensuel (mini-table texte) */
        let histHTML = fc.monthlyVolume.map(m =>
          `<span style="display:inline-block;text-align:center;min-width:55px;"><span class="text-muted" style="font-size:0.68rem;display:block;">${m.label}</span><span class="font-bold">${m.count}</span></span>`
        ).join('');

        /* Recommandation recrutement */
        let recruitHTML = '';
        if (fc.recruitmentNeeded) {
          recruitHTML = `
            <div class="reco-card reco-warning">
              <div class="reco-title">Seuil de recrutement</div>
              <div class="reco-text">${escapeHTML(fc.recruitmentNeeded.message)}${fc.recruitmentStatus ? ` Statut recommandé : <strong>${fc.recruitmentStatus.label}</strong> (${Engine.fmt(fc.recruitmentStatus.companyCost)}/j).` : ''}</div>
            </div>`;
        }

        return `
          <div class="card strat-section">
            <div class="strat-section-title">Anticipation — si tendance actuelle maintenue</div>
            <div class="flex gap-8 mb-16" style="flex-wrap:wrap;align-items:center;">
              <span class="text-muted" style="font-size:0.82rem;">Tendance globale :</span>
              <span class="${trendClass} font-bold">${trendIcon} ${fc.trendLabel}</span>
              <span class="text-muted" style="font-size:0.82rem;margin-left:16px;">Moy. mensuelle :</span>
              <span class="font-bold">${fc.avgVolume} sess</span>
              <span class="text-muted" style="font-size:0.82rem;margin-left:16px;">CA moy :</span>
              <span class="font-bold text-mono">${Engine.fmt(fc.avgRevenue)}</span>
            </div>

            <div class="mb-16" style="font-size:0.82rem;color:var(--text-secondary);">
              Volume des 6 derniers mois : ${histHTML}
            </div>

            <div class="prev-grid mb-16">
              <div class="prev-cell">
                <div class="prev-period">+3 mois</div>
                <div class="prev-value">${fc.projections.volume.m3.toFixed(0)}</div>
                <div class="prev-detail">sess/mois</div>
              </div>
              <div class="prev-cell">
                <div class="prev-period">+6 mois</div>
                <div class="prev-value">${fc.projections.volume.m6.toFixed(0)}</div>
                <div class="prev-detail">sess/mois</div>
              </div>
              <div class="prev-cell">
                <div class="prev-period">+12 mois</div>
                <div class="prev-value">${fc.projections.volume.m12.toFixed(0)}</div>
                <div class="prev-detail">sess/mois</div>
              </div>
            </div>

            <div class="prev-grid mb-16">
              <div class="prev-cell">
                <div class="prev-period">CA +3 mois</div>
                <div class="prev-value" style="font-size:1rem;">${Engine.fmt(fc.projections.revenue.m3)}</div>
                <div class="prev-detail">/mois projeté</div>
              </div>
              <div class="prev-cell">
                <div class="prev-period">CA +6 mois</div>
                <div class="prev-value" style="font-size:1rem;">${Engine.fmt(fc.projections.revenue.m6)}</div>
                <div class="prev-detail">/mois projeté</div>
              </div>
              <div class="prev-cell">
                <div class="prev-period">Marge actuelle</div>
                <div class="prev-value ${fc.avgMargin >= settings.targetMarginPercent ? 'text-green' : fc.avgMargin >= settings.marginAlertThreshold ? 'text-yellow' : 'text-red'}">${Engine.fmtPercent(fc.avgMargin)}</div>
                <div class="prev-detail">tendance ${fc.projections.margin.trend}</div>
              </div>
            </div>

            <div class="mb-8" style="font-size:0.82rem;">
              <span class="text-muted">Capacité RH totale :</span>
              <span class="font-bold">${fc.capaciteTotale} sess/mois</span>
              <span class="text-muted" style="margin-left:16px;">Charge actuelle :</span>
              <span class="font-bold">${fc.chargeActuelle} sess/mois</span>
              <span class="text-muted" style="margin-left:8px;">(${fc.capaciteTotale > 0 ? Engine.round2((fc.chargeActuelle / fc.capaciteTotale) * 100) : 0}%)</span>
            </div>
            ${recruitHTML}
          </div>
        `;
      } catch(e) { return ''; }
    }

    /* ----------------------------------------------------------
       8. RECOMMANDATIONS RH STRATÉGIQUES (V2)
       ---------------------------------------------------------- */

    function buildHRIntelligenceHTML() {
      try {
        const hrData = Engine.computeHRIntelligence();
        if (hrData.length === 0) return '';

        /* Ne montrer que les opérateurs avec des recommandations */
        const withRecos = hrData.filter(h => h.recommendations.length > 0);
        if (withRecos.length === 0) {
          return `
            <div class="card strat-section">
              <div class="strat-section-title">Intelligence RH</div>
              <div class="alert alert-success"><span class="alert-icon">&#10003;</span> Aucune recommandation — vivier RH optimal.</div>
            </div>`;
        }

        let inner = '';
        withRecos.slice(0, 5).forEach(h => {
          const op = h.operator;
          inner += `<div style="margin-bottom:16px;">`;
          inner += `<div class="flex-between mb-8">
            <div>
              <span class="font-bold">${escapeHTML((op.firstName || '') + ' ' + (op.lastName || ''))}</span>
              <span class="tag tag-neutral" style="margin-left:8px;">${Engine.statusLabel(op.status)}</span>
            </div>
            <div class="text-mono text-muted" style="font-size:0.8rem;">
              Score : <span class="font-bold ${h.pertinenceScore >= 90 ? 'text-green' : h.pertinenceScore >= 70 ? 'text-yellow' : 'text-red'}">${h.pertinenceScore}/100</span>
              &nbsp;|&nbsp; ${h.opYearCount} sess/an &nbsp;|&nbsp; ~${h.avgMonthly}/mois
            </div>
          </div>`;

          /* Projection charge */
          inner += `<div class="prev-grid mb-8">
            <div class="prev-cell" style="padding:8px;">
              <div class="prev-period">+3 mois</div>
              <div class="prev-value" style="font-size:1rem;">${h.proj3.toFixed(1)}</div>
              <div class="prev-detail">sess/mois</div>
            </div>
            <div class="prev-cell" style="padding:8px;">
              <div class="prev-period">+6 mois</div>
              <div class="prev-value" style="font-size:1rem;">${h.proj6.toFixed(1)}</div>
              <div class="prev-detail">sess/mois</div>
            </div>
            <div class="prev-cell" style="padding:8px;">
              <div class="prev-period">+12 mois</div>
              <div class="prev-value" style="font-size:1rem;">${h.proj12.toFixed(1)}</div>
              <div class="prev-detail">sess/mois</div>
            </div>
          </div>`;

          h.recommendations.forEach(r => {
            const cls = r.level === 'critical' ? 'reco-critical' : r.level === 'warning' ? 'reco-warning' : r.level === 'success' ? 'reco-success' : 'reco-info';
            inner += `<div class="reco-card ${cls}">
              <div class="reco-title">${escapeHTML(r.title)}</div>
              <div class="reco-text">${r.text}</div>
            </div>`;
          });

          inner += `</div>`;
        });

        return `
          <div class="card strat-section">
            <div class="strat-section-title">Intelligence RH — Recommandations</div>
            ${inner}
          </div>
        `;
      } catch(e) { return ''; }
    }

    /* ----------------------------------------------------------
       9. ASSEMBLAGE FINAL (V2 — enrichi)
       ---------------------------------------------------------- */

    const today = now.toLocaleDateString('fr-FR', {
      weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
    });

    container.innerHTML = `
      <div class="page-header">
        <div>
          <h1>Tableau de bord</h1>
          <span class="text-muted" style="font-size:0.82rem;">${escapeHTML(today)} — Poste de commandement stratégique</span>
        </div>
      </div>

      <!-- Indicateurs clés -->
      ${kpiCardsHTML}

      <!-- Alertes intelligentes -->
      ${buildAlertsHTML()}

      <!-- Vue prévisionnelle -->
      ${buildForecastHTML()}

      <!-- Prochaines sessions + Synthèse économique -->
      <div class="grid-2">
        <div>
          ${buildUpcomingSessionsHTML()}
        </div>
        <div>
          ${buildEconomicSummaryHTML()}
          ${buildOperatorLoadHTML()}
        </div>
      </div>

      <!-- Intelligence RH -->
      ${buildHRIntelligenceHTML()}
    `;
  }
};
/* ============================================================
   DST-SYSTEM — Vue Clients
   Gestion complète du fichier client : liste, CRUD, fiche
   détaillée avec historique sessions, offres et statistiques.
   ============================================================ */

window.Views = window.Views || {};

Views.Clients = (() => {
  'use strict';

  /* --- État interne du module --- */
  let _container = null;
  let _searchTerm = '';
  let _filterType = '';
  let _expandedClientId = null;

  /* -----------------------------------------------------------
     RENDU PRINCIPAL
     ----------------------------------------------------------- */

  function render(container) {
    _container = container;
    _renderPage();
  }

  /**
   * Reconstruit l'intégralité de la page clients.
   */
  function _renderPage() {
    const clients = DB.clients.getAll();
    const settings = DB.settings.get();
    const clientTypes = settings.clientTypes || [];

    /* Filtrage par recherche et type */
    const filtered = _applyFilters(clients);

    /* Compteurs pour les KPI */
    const activeCount = clients.filter(c => c.active !== false).length;
    const inactiveCount = clients.length - activeCount;

    _container.innerHTML = `
      <!-- En-tête de page -->
      <div class="page-header">
        <h1>Clients</h1>
        <div class="actions">
          <button class="btn btn-primary" id="btn-add-client">+ Nouveau client</button>
        </div>
      </div>

      <!-- KPI synthèse -->
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-label">Total clients</div>
          <div class="kpi-value">${clients.length}</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Clients actifs</div>
          <div class="kpi-value">${activeCount}</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Clients inactifs</div>
          <div class="kpi-value">${inactiveCount}</div>
        </div>
      </div>

      <!-- Barre de recherche et filtre type -->
      <div class="card">
        <div class="flex-between mb-16">
          <div class="search-bar">
            <span class="search-icon">&#128269;</span>
            <input type="text" id="client-search" placeholder="Rechercher par nom ou contact..."
                   value="${_escapeAttr(_searchTerm)}" />
          </div>
          <div class="flex gap-8">
            <select class="form-control" id="client-filter-type" style="width:auto;min-width:180px;">
              <option value="">Tous les types</option>
              ${clientTypes.map(t => `
                <option value="${_escapeAttr(t)}" ${_filterType === t ? 'selected' : ''}>${_escapeHtml(t)}</option>
              `).join('')}
            </select>
          </div>
        </div>

        <!-- Tableau clients -->
        ${filtered.length > 0 ? _renderTable(filtered) : `
          <div class="empty-state">
            <div class="empty-icon">&#128101;</div>
            <p>Aucun client trouvé${_searchTerm || _filterType ? ' pour ces critères.' : '. Créez votre premier client.'}</p>
            ${!_searchTerm && !_filterType ? '<button class="btn btn-primary" id="btn-empty-add">+ Nouveau client</button>' : ''}
          </div>
        `}
      </div>

      <!-- Panneau détail (inséré dynamiquement sous le tableau) -->
      <div id="client-detail-panel"></div>
    `;

    /* --- Attachement des écouteurs --- */
    _bindPageEvents(clientTypes);
  }

  /* -----------------------------------------------------------
     FILTRAGE
     ----------------------------------------------------------- */

  /**
   * Applique les filtres recherche + type sur la liste.
   */
  function _applyFilters(clients) {
    let result = clients;
    if (_filterType) {
      result = result.filter(c => c.type === _filterType);
    }
    if (_searchTerm) {
      const term = _searchTerm.toLowerCase();
      result = result.filter(c =>
        (c.name || '').toLowerCase().includes(term) ||
        (c.contactName || '').toLowerCase().includes(term) ||
        (c.type || '').toLowerCase().includes(term)
      );
    }
    /* Tri alphabétique par nom */
    result.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'fr'));
    return result;
  }

  /* -----------------------------------------------------------
     TABLEAU CLIENTS
     ----------------------------------------------------------- */

  /**
   * Génère le HTML du tableau des clients.
   */
  function _renderTable(clients) {
    const allSessions = DB.sessions.getAll();
    const rows = clients.map(client => {
      const sessCount = allSessions.filter(s => s.clientId === client.id).length;
      const tagClass = _typeTagClass(client.type);
      const isExpanded = _expandedClientId === client.id;
      return `
        <tr class="client-row ${isExpanded ? 'active' : ''}" data-id="${client.id}" style="cursor:pointer;">
          <td><strong>${_escapeHtml(client.name || '—')}</strong></td>
          <td><span class="tag ${tagClass}">${_escapeHtml(client.type || 'N/C')}</span></td>
          <td>
            ${client.contactName ? _escapeHtml(client.contactName) : '<span class="text-muted">—</span>'}
            ${client.contactEmail ? `<br><small class="text-muted">${_escapeHtml(client.contactEmail)}</small>` : ''}
          </td>
          <td class="num">${sessCount}</td>
          <td>
            ${client.active !== false
              ? '<span class="tag tag-green">Actif</span>'
              : '<span class="tag tag-neutral">Inactif</span>'}
          </td>
          <td class="actions-cell">
            <button class="btn btn-sm btn-edit-client" data-id="${client.id}" title="Modifier">&#9998;</button>
            <button class="btn btn-sm btn-delete-client" data-id="${client.id}" title="Supprimer">&#128465;</button>
          </td>
        </tr>
      `;
    }).join('');

    return `
      <div class="data-table-wrap">
        <table class="data-table" id="clients-table">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Type</th>
              <th>Contact</th>
              <th>Sessions</th>
              <th>Statut</th>
              <th class="text-right">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      </div>
    `;
  }

  /* -----------------------------------------------------------
     FICHE DÉTAIL CLIENT
     ----------------------------------------------------------- */

  /**
   * Affiche ou masque la fiche détaillée d'un client.
   */
  function _toggleDetail(clientId) {
    if (_expandedClientId === clientId) {
      _expandedClientId = null;
      const panel = _container.querySelector('#client-detail-panel');
      if (panel) panel.innerHTML = '';
      /* Retirer la surbrillance de la ligne */
      _container.querySelectorAll('.client-row.active').forEach(r => r.classList.remove('active'));
      return;
    }
    _expandedClientId = clientId;
    _renderDetail(clientId);
    /* Mettre à jour la surbrillance des lignes */
    _container.querySelectorAll('.client-row').forEach(r => {
      r.classList.toggle('active', r.dataset.id === clientId);
    });
  }

  /**
   * Construit le panneau de détail pour un client donné.
   */
  function _renderDetail(clientId) {
    const client = DB.clients.getById(clientId);
    if (!client) return;

    const panel = _container.querySelector('#client-detail-panel');
    if (!panel) return;

    /* Récupérer les sessions liées */
    const clientSessions = DB.sessions.filter(s => s.clientId === clientId);
    clientSessions.sort((a, b) => new Date(b.date) - new Date(a.date));

    /* Récupérer les offres liées (clientIds contient l'id) */
    const clientOffers = DB.offers.filter(o =>
      (o.clientIds && o.clientIds.includes(clientId)) ||
      (o.clientId && o.clientId === clientId)
    );

    /* Statistiques */
    const stats = _computeClientStats(clientSessions);

    panel.innerHTML = `
      <div class="card mt-16" id="detail-card">
        <div class="card-header">
          <h2>Fiche client : ${_escapeHtml(client.name)}</h2>
          <button class="btn btn-sm" id="btn-close-detail">Fermer</button>
        </div>

        <!-- Résumé informations -->
        <div class="grid-2 mb-16">
          <div>
            <table class="data-table" style="font-size:0.85rem;">
              <tbody>
                <tr><td class="text-muted" style="width:140px;">Type</td><td><span class="tag ${_typeTagClass(client.type)}">${_escapeHtml(client.type || 'N/C')}</span></td></tr>
                <tr><td class="text-muted">Contact</td><td>${_escapeHtml(client.contactName || '—')}</td></tr>
                <tr><td class="text-muted">Email</td><td>${client.contactEmail ? `<a href="mailto:${_escapeAttr(client.contactEmail)}">${_escapeHtml(client.contactEmail)}</a>` : '—'}</td></tr>
                <tr><td class="text-muted">Téléphone</td><td>${_escapeHtml(client.contactPhone || '—')}</td></tr>
                <tr><td class="text-muted">Adresse</td><td>${_escapeHtml(client.address || '—')}</td></tr>
                <tr><td class="text-muted">SIRET</td><td><span class="text-mono">${_escapeHtml(client.siret || '—')}</span></td></tr>
                <tr><td class="text-muted">Statut</td><td>${client.active !== false ? '<span class="tag tag-green">Actif</span>' : '<span class="tag tag-neutral">Inactif</span>'}</td></tr>
                ${client.notes ? `<tr><td class="text-muted">Notes</td><td>${_escapeHtml(client.notes)}</td></tr>` : ''}
              </tbody>
            </table>
          </div>
          <div>
            <!-- KPI client -->
            <div class="kpi-grid" style="grid-template-columns:1fr 1fr;">
              <div class="kpi-card">
                <div class="kpi-label">Sessions totales</div>
                <div class="kpi-value">${stats.totalSessions}</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Total facturé</div>
                <div class="kpi-value">${Engine.fmt(stats.totalSpent)}</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Coût moyen / session</div>
                <div class="kpi-value">${stats.totalSessions > 0 ? Engine.fmt(stats.avgSessionCost) : '—'}</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Offres actives</div>
                <div class="kpi-value">${clientOffers.length}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Historique des sessions -->
        <div class="card-header">
          <h3>Historique des sessions</h3>
        </div>
        ${clientSessions.length > 0 ? `
          <div class="data-table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Libellé</th>
                  <th>Statut</th>
                  <th class="text-right">Prix facturé</th>
                  <th class="text-right">Coût total</th>
                  <th class="text-right">Marge</th>
                </tr>
              </thead>
              <tbody>
                ${clientSessions.map(s => {
                  const cost = Engine.computeSessionCost(s);
                  const statusLabel = Engine.sessionStatusLabel ? Engine.sessionStatusLabel(s.status) : (s.status || '—');
                  return `
                    <tr>
                      <td>${_formatDate(s.date)}</td>
                      <td>${_escapeHtml(s.label || s.name || '—')}</td>
                      <td><span class="tag ${_sessionStatusTag(s.status)}">${_escapeHtml(statusLabel)}</span></td>
                      <td class="num">${Engine.fmt(s.price || 0)}</td>
                      <td class="num">${Engine.fmt(cost.totalCost)}</td>
                      <td class="num ${cost.marginPercent < 0 ? 'text-red' : ''}">${cost.marginPercent.toFixed(1)} %</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        ` : `
          <div class="empty-state" style="padding:24px;">
            <p class="text-muted">Aucune session enregistrée pour ce client.</p>
          </div>
        `}

        <!-- Offres / abonnements -->
        <div class="card-header mt-24">
          <h3>Offres et abonnements</h3>
        </div>
        ${clientOffers.length > 0 ? `
          <div class="data-table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Intitulé</th>
                  <th>Type</th>
                  <th class="text-right">Nb sessions</th>
                  <th class="text-right">Prix</th>
                </tr>
              </thead>
              <tbody>
                ${clientOffers.map(o => {
                  const typeLabel = Engine.offerTypeLabel ? Engine.offerTypeLabel(o.type) : (o.type || '—');
                  return `
                    <tr>
                      <td>${_escapeHtml(o.label || o.name || '—')}</td>
                      <td><span class="tag tag-blue">${_escapeHtml(typeLabel)}</span></td>
                      <td class="num">${o.nbSessions || '—'}</td>
                      <td class="num">${Engine.fmt(o.price || 0)}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        ` : `
          <div class="empty-state" style="padding:24px;">
            <p class="text-muted">Aucune offre liée à ce client.</p>
          </div>
        `}
      </div>
    `;

    /* Écouteur fermeture du panneau */
    const btnClose = panel.querySelector('#btn-close-detail');
    if (btnClose) {
      btnClose.addEventListener('click', () => _toggleDetail(clientId));
    }

    /* Scroll vers le panneau détail */
    panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  /**
   * Calcule les statistiques d'un client à partir de ses sessions.
   */
  function _computeClientStats(sessions) {
    let totalSpent = 0;
    const validSessions = sessions.filter(s => s.status !== 'annulee');
    validSessions.forEach(s => {
      totalSpent += (s.price || 0);
    });
    const avgSessionCost = validSessions.length > 0
      ? Engine.round2(totalSpent / validSessions.length)
      : 0;
    return {
      totalSessions: validSessions.length,
      totalSpent: Engine.round2(totalSpent),
      avgSessionCost
    };
  }

  /* -----------------------------------------------------------
     MODAL FORMULAIRE (CRÉER / MODIFIER)
     ----------------------------------------------------------- */

  /**
   * Affiche la modale de création ou d'édition d'un client.
   * @param {Object|null} client — null pour une création, objet pour édition.
   */
  function _openFormModal(client) {
    const isEdit = !!client;
    const settings = DB.settings.get();
    const clientTypes = settings.clientTypes || [];
    const c = client || {};

    /* Déterminer si le type actuel est un type personnalisé */
    const isCustomType = c.type && !clientTypes.includes(c.type);

    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.id = 'client-modal-overlay';

    overlay.innerHTML = `
      <div class="modal">
        <div class="modal-header">
          <h2>${isEdit ? 'Modifier le client' : 'Nouveau client'}</h2>
          <button class="btn btn-sm btn-ghost" id="btn-modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label for="client-name">Nom / Raison sociale *</label>
              <input type="text" class="form-control" id="client-name"
                     value="${_escapeAttr(c.name || '')}" placeholder="Nom du client" required />
            </div>
            <div class="form-group">
              <label for="client-type">Type de client</label>
              <select class="form-control" id="client-type">
                ${clientTypes.map(t => `
                  <option value="${_escapeAttr(t)}" ${c.type === t ? 'selected' : ''}>${_escapeHtml(t)}</option>
                `).join('')}
                <option value="__custom" ${isCustomType ? 'selected' : ''}>Autre (saisie libre)...</option>
              </select>
            </div>
          </div>

          <!-- Champ type personnalisé (masqué par défaut) -->
          <div class="form-group ${isCustomType ? '' : 'hidden'}" id="custom-type-group">
            <label for="client-type-custom">Type personnalisé</label>
            <input type="text" class="form-control" id="client-type-custom"
                   value="${isCustomType ? _escapeAttr(c.type) : ''}" placeholder="Saisissez un type..." />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="client-contact-name">Nom du contact</label>
              <input type="text" class="form-control" id="client-contact-name"
                     value="${_escapeAttr(c.contactName || '')}" placeholder="Prénom Nom" />
            </div>
            <div class="form-group">
              <label for="client-contact-email">Email</label>
              <input type="email" class="form-control" id="client-contact-email"
                     value="${_escapeAttr(c.contactEmail || '')}" placeholder="contact@exemple.fr" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="client-contact-phone">Téléphone</label>
              <input type="tel" class="form-control" id="client-contact-phone"
                     value="${_escapeAttr(c.contactPhone || '')}" placeholder="06 00 00 00 00" />
            </div>
            <div class="form-group">
              <label for="client-siret">SIRET</label>
              <input type="text" class="form-control" id="client-siret"
                     value="${_escapeAttr(c.siret || '')}" placeholder="123 456 789 00012" />
            </div>
          </div>

          <div class="form-group">
            <label for="client-address">Adresse</label>
            <input type="text" class="form-control" id="client-address"
                   value="${_escapeAttr(c.address || '')}" placeholder="Adresse complète" />
          </div>

          <div class="form-group">
            <label for="client-notes">Notes internes</label>
            <textarea class="form-control" id="client-notes" rows="3"
                      placeholder="Remarques, contexte, historique...">${_escapeHtml(c.notes || '')}</textarea>
          </div>

          <div class="form-group">
            <label class="form-check">
              <input type="checkbox" id="client-active" ${c.active !== false ? 'checked' : ''} />
              Client actif
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" id="btn-modal-cancel">Annuler</button>
          <button class="btn btn-primary" id="btn-modal-save">${isEdit ? 'Enregistrer' : 'Créer'}</button>
        </div>
      </div>
    `;

    document.body.appendChild(overlay);

    /* --- Écouteurs de la modale --- */

    /* Bascule type personnalisé */
    const selectType = overlay.querySelector('#client-type');
    const customGroup = overlay.querySelector('#custom-type-group');
    selectType.addEventListener('change', () => {
      if (selectType.value === '__custom') {
        customGroup.classList.remove('hidden');
        overlay.querySelector('#client-type-custom').focus();
      } else {
        customGroup.classList.add('hidden');
      }
    });

    /* Fermer la modale */
    const closeModal = () => {
      overlay.remove();
    };

    overlay.querySelector('#btn-modal-close').addEventListener('click', closeModal);
    overlay.querySelector('#btn-modal-cancel').addEventListener('click', closeModal);

    /* Clic sur le fond sombre */
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) closeModal();
    });

    /* Sauvegarder */
    overlay.querySelector('#btn-modal-save').addEventListener('click', () => {
      const name = overlay.querySelector('#client-name').value.trim();
      if (!name) {
        overlay.querySelector('#client-name').style.borderColor = 'var(--accent-red)';
        overlay.querySelector('#client-name').focus();
        return;
      }

      /* Résoudre le type (standard ou personnalisé) */
      let type = selectType.value;
      if (type === '__custom') {
        type = overlay.querySelector('#client-type-custom').value.trim() || 'Autre';
      }

      const data = {
        name,
        type,
        contactName: overlay.querySelector('#client-contact-name').value.trim(),
        contactEmail: overlay.querySelector('#client-contact-email').value.trim(),
        contactPhone: overlay.querySelector('#client-contact-phone').value.trim(),
        address: overlay.querySelector('#client-address').value.trim(),
        siret: overlay.querySelector('#client-siret').value.trim(),
        notes: overlay.querySelector('#client-notes').value.trim(),
        active: overlay.querySelector('#client-active').checked
      };

      if (isEdit) {
        DB.clients.update(client.id, data);
      } else {
        DB.clients.create(data);
      }

      closeModal();
      /* Rafraîchir le panneau détail si ouvert sur ce client */
      if (isEdit && _expandedClientId === client.id) {
        _expandedClientId = client.id;
      }
      _renderPage();
    });

    /* Focus initial sur le champ nom */
    overlay.querySelector('#client-name').focus();
  }

  /* -----------------------------------------------------------
     SUPPRESSION CLIENT
     ----------------------------------------------------------- */

  /**
   * Affiche une modale de confirmation de suppression.
   */
  function _confirmDelete(clientId) {
    const client = DB.clients.getById(clientId);
    if (!client) return;

    /* Vérifier les sessions liées */
    const linkedSessions = DB.sessions.filter(s => s.clientId === clientId);

    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.innerHTML = `
      <div class="modal" style="max-width:480px;">
        <div class="modal-header">
          <h2>Confirmer la suppression</h2>
          <button class="btn btn-sm btn-ghost" id="btn-del-close">&times;</button>
        </div>
        <div class="modal-body">
          <p>Voulez-vous vraiment supprimer le client <strong>${_escapeHtml(client.name)}</strong> ?</p>
          ${linkedSessions.length > 0 ? `
            <div class="alert alert-warning mt-16">
              <span class="alert-icon">&#9888;</span>
              <span>Ce client est lié à <strong>${linkedSessions.length}</strong> session(s). Les sessions ne seront pas supprimées mais perdront leur référence client.</span>
            </div>
          ` : ''}
          <p class="text-muted mt-8">Cette action est irréversible.</p>
        </div>
        <div class="modal-footer">
          <button class="btn" id="btn-del-cancel">Annuler</button>
          <button class="btn btn-primary" id="btn-del-confirm" style="background:var(--accent-red);border-color:var(--accent-red);">Supprimer</button>
        </div>
      </div>
    `;

    document.body.appendChild(overlay);

    const closeModal = () => overlay.remove();

    overlay.querySelector('#btn-del-close').addEventListener('click', closeModal);
    overlay.querySelector('#btn-del-cancel').addEventListener('click', closeModal);
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) closeModal();
    });

    overlay.querySelector('#btn-del-confirm').addEventListener('click', () => {
      DB.clients.delete(clientId);
      /* Fermer le détail si ouvert sur ce client */
      if (_expandedClientId === clientId) {
        _expandedClientId = null;
      }
      closeModal();
      _renderPage();
    });
  }

  /* -----------------------------------------------------------
     ATTACHEMENT DES ÉVÉNEMENTS
     ----------------------------------------------------------- */

  /**
   * Branche tous les écouteurs d'événements après le rendu HTML.
   */
  function _bindPageEvents(clientTypes) {
    /* Bouton nouveau client */
    const btnAdd = _container.querySelector('#btn-add-client');
    if (btnAdd) btnAdd.addEventListener('click', () => _openFormModal(null));

    /* Bouton ajout dans l'état vide */
    const btnEmptyAdd = _container.querySelector('#btn-empty-add');
    if (btnEmptyAdd) btnEmptyAdd.addEventListener('click', () => _openFormModal(null));

    /* Champ de recherche */
    const searchInput = _container.querySelector('#client-search');
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        _searchTerm = e.target.value;
        _renderPage();
        /* Re-focus le champ recherche après le re-rendu */
        const newInput = _container.querySelector('#client-search');
        if (newInput) {
          newInput.focus();
          newInput.setSelectionRange(newInput.value.length, newInput.value.length);
        }
      });
    }

    /* Filtre par type */
    const filterType = _container.querySelector('#client-filter-type');
    if (filterType) {
      filterType.addEventListener('change', (e) => {
        _filterType = e.target.value;
        _renderPage();
      });
    }

    /* Lignes du tableau — clic pour ouvrir la fiche détail */
    _container.querySelectorAll('.client-row').forEach(row => {
      row.addEventListener('click', (e) => {
        /* Ne pas ouvrir si clic sur un bouton d'action */
        if (e.target.closest('.btn-edit-client') || e.target.closest('.btn-delete-client')) return;
        _toggleDetail(row.dataset.id);
      });
    });

    /* Boutons modifier */
    _container.querySelectorAll('.btn-edit-client').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const client = DB.clients.getById(btn.dataset.id);
        if (client) _openFormModal(client);
      });
    });

    /* Boutons supprimer */
    _container.querySelectorAll('.btn-delete-client').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        _confirmDelete(btn.dataset.id);
      });
    });

    /* Si un détail était ouvert, le ré-afficher */
    if (_expandedClientId) {
      const exists = DB.clients.getById(_expandedClientId);
      if (exists) {
        _renderDetail(_expandedClientId);
      } else {
        _expandedClientId = null;
      }
    }
  }

  /* -----------------------------------------------------------
     UTILITAIRES
     ----------------------------------------------------------- */

  /**
   * Retourne la classe CSS du tag selon le type de client.
   */
  function _typeTagClass(type) {
    if (!type) return 'tag-neutral';
    const t = type.toLowerCase();
    if (t.includes('police') || t.includes('gendarmerie')) return 'tag-blue';
    if (t.includes('armée') || t.includes('armee') || t.includes('défense')) return 'tag-green';
    if (t.includes('entreprise')) return 'tag-yellow';
    if (t.includes('collectivité') || t.includes('collectivite')) return 'tag-neutral';
    if (t.includes('sécurité') || t.includes('securite')) return 'tag-blue';
    if (t.includes('association')) return 'tag-green';
    if (t.includes('particulier')) return 'tag-yellow';
    return 'tag-neutral';
  }

  /**
   * Retourne la classe CSS du tag selon le statut de session.
   */
  function _sessionStatusTag(status) {
    const map = {
      planifiee: 'tag-blue',
      confirmee: 'tag-green',
      en_cours: 'tag-yellow',
      terminee: 'tag-neutral',
      annulee: 'tag-red'
    };
    return map[status] || 'tag-neutral';
  }

  /**
   * Formate une date ISO en format français lisible.
   */
  function _formatDate(isoDate) {
    if (!isoDate) return '—';
    try {
      const d = new Date(isoDate);
      return d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    } catch (e) {
      return isoDate;
    }
  }

  /**
   * Échappe les caractères HTML pour éviter les injections.
   */
  function _escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  /**
   * Échappe les caractères pour les attributs HTML.
   */
  function _escapeAttr(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  /* --- API publique du module --- */
  return { render };

})();
/* ============================================================
   DST-SYSTEM — Vue : Offres & Abonnements
   Gestion complète des offres commerciales (CRUD),
   suivi des abonnements, prix plancher, clonage.
   ============================================================ */

window.Views = window.Views || {};

Views.Offers = {

  /**
   * Point d'entrée unique — injecte le HTML et branche tous les listeners.
   * @param {HTMLElement} container — zone #content de l'application
   */
  render(container) {
    'use strict';

    /* ==========================================================
       ÉTAT LOCAL
       ========================================================== */

    let searchTerm = '';        // filtre recherche en cours
    let filterType = '';        // filtre par type d'offre
    let filterActive = '';      // filtre par statut actif

    /* ==========================================================
       HELPERS INTERNES
       ========================================================== */

    /** Classe CSS du tag selon le type d'offre */
    function tagClass(type) {
      const map = {
        one_shot: 'tag-blue',
        abonnement: 'tag-green',
        personnalisee: 'tag-yellow'
      };
      return map[type] || 'tag-neutral';
    }

    /** Récupère le libellé d'un client par son id */
    function clientLabel(id) {
      const c = DB.clients.getById(id);
      if (!c) return '(inconnu)';
      return c.name || c.label || (`${c.firstName || ''} ${c.lastName || ''}`).trim() || id;
    }

    /** Récupère le libellé d'un module par son id */
    function moduleLabel(id) {
      const m = DB.modules.getById(id);
      return m ? (m.name || m.label || id) : '(inconnu)';
    }

    /** Calcule les sessions restantes */
    function sessionsRemaining(offer) {
      const total = offer.nbSessions || 0;
      const consumed = offer.sessionsConsumed || 0;
      return Math.max(total - consumed, 0);
    }

    /** Détermine la couleur de la barre de progression */
    function progressColor(consumed, total) {
      if (total <= 0) return 'fill-green';
      const ratio = consumed / total;
      if (ratio >= 0.85) return 'fill-red';
      if (ratio >= 0.55) return 'fill-yellow';
      return 'fill-green';
    }

    /** Pourcentage de consommation (borné 0-100) */
    function progressPercent(consumed, total) {
      if (total <= 0) return 0;
      return Math.min(Math.round((consumed / total) * 100), 100);
    }

    /** Échappe le HTML pour éviter les injections */
    function esc(str) {
      if (str == null) return '';
      const d = document.createElement('div');
      d.textContent = String(str);
      return d.innerHTML;
    }

    /* ==========================================================
       RENDU — TABLEAU PRINCIPAL
       ========================================================== */

    function renderMain() {
      const offers = DB.offers.getAll();

      /* Filtrage */
      let filtered = offers;

      if (searchTerm) {
        const q = searchTerm.toLowerCase();
        filtered = filtered.filter(o =>
          (o.label || '').toLowerCase().includes(q) ||
          (o.clientIds || []).some(cid => clientLabel(cid).toLowerCase().includes(q)) ||
          (o.notes || '').toLowerCase().includes(q)
        );
      }
      if (filterType) {
        filtered = filtered.filter(o => o.type === filterType);
      }
      if (filterActive === 'active') {
        filtered = filtered.filter(o => o.active !== false);
      } else if (filterActive === 'inactive') {
        filtered = filtered.filter(o => o.active === false);
      }

      /* Tri par date de création décroissante */
      filtered.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));

      /* Construction HTML */
      let html = `
        <div class="page-header">
          <h1>Offres & Abonnements</h1>
          <div class="actions">
            <button class="btn btn-primary" id="btn-new-offer">+ Nouvelle offre</button>
          </div>
        </div>

        <!-- Barre de filtres -->
        <div class="card">
          <div class="form-row" style="align-items:flex-end;">
            <div class="form-group" style="margin-bottom:0;">
              <label>Recherche</label>
              <div class="search-bar" style="max-width:100%;">
                <span class="search-icon">&#128269;</span>
                <input type="text" id="offers-search" class="form-control"
                       placeholder="Rechercher une offre..." value="${esc(searchTerm)}">
              </div>
            </div>
            <div class="form-group" style="margin-bottom:0;">
              <label>Type</label>
              <select id="offers-filter-type" class="form-control">
                <option value="">Tous les types</option>
                <option value="one_shot" ${filterType === 'one_shot' ? 'selected' : ''}>One-shot</option>
                <option value="abonnement" ${filterType === 'abonnement' ? 'selected' : ''}>Abonnement</option>
                <option value="personnalisee" ${filterType === 'personnalisee' ? 'selected' : ''}>Personnalis\u00e9e</option>
              </select>
            </div>
            <div class="form-group" style="margin-bottom:0;">
              <label>Statut</label>
              <select id="offers-filter-active" class="form-control">
                <option value="">Tous</option>
                <option value="active" ${filterActive === 'active' ? 'selected' : ''}>Actives</option>
                <option value="inactive" ${filterActive === 'inactive' ? 'selected' : ''}>Inactives</option>
              </select>
            </div>
          </div>
        </div>`;

      if (filtered.length === 0) {
        html += `
          <div class="card">
            <div class="empty-state">
              <div class="empty-icon">&#128230;</div>
              <p>Aucune offre trouv\u00e9e.</p>
              <button class="btn btn-primary" id="btn-new-offer-empty">+ Cr\u00e9er une offre</button>
            </div>
          </div>`;
      } else {
        html += `
          <div class="card">
            <div class="data-table-wrap">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Libell\u00e9</th>
                    <th>Type</th>
                    <th>Client(s)</th>
                    <th>Prix</th>
                    <th>Sessions</th>
                    <th>Statut</th>
                    <th class="actions-cell">Actions</th>
                  </tr>
                </thead>
                <tbody>`;

        filtered.forEach(offer => {
          /* Clients liés */
          const clientNames = (offer.clientIds || []).map(cid => esc(clientLabel(cid))).join(', ') || '<span class="text-muted">—</span>';

          /* Sessions (affiché uniquement pour abonnements) */
          let sessionsHtml = '<span class="text-muted">—</span>';
          if (offer.type === 'abonnement' && offer.nbSessions > 0) {
            const consumed = offer.sessionsConsumed || 0;
            const total = offer.nbSessions;
            const remaining = sessionsRemaining(offer);
            const pct = progressPercent(consumed, total);
            const color = progressColor(consumed, total);
            sessionsHtml = `
              <div style="min-width:110px;">
                <span class="text-mono">${consumed} / ${total}</span>
                <span class="text-muted" style="font-size:0.72rem;"> (reste ${remaining})</span>
                <div class="progress-bar mt-8">
                  <div class="progress-fill ${color}" style="width:${pct}%;"></div>
                </div>
              </div>`;
          }

          /* Statut */
          const isActive = offer.active !== false;
          const statusHtml = isActive
            ? '<span class="tag tag-green">Active</span>'
            : '<span class="tag tag-neutral">Inactive</span>';

          html += `
                  <tr>
                    <td><strong>${esc(offer.label || '(sans nom)')}</strong></td>
                    <td><span class="tag ${tagClass(offer.type)}">${esc(Engine.offerTypeLabel(offer.type))}</span></td>
                    <td>${clientNames}</td>
                    <td class="num">${Engine.fmt(offer.price || 0)}</td>
                    <td>${sessionsHtml}</td>
                    <td>${statusHtml}</td>
                    <td class="actions-cell">
                      <button class="btn btn-sm btn-action-edit" data-id="${offer.id}" data-tooltip="Modifier">&#9998;</button>
                      <button class="btn btn-sm btn-warning btn-action-clone" data-id="${offer.id}" data-tooltip="Dupliquer">&#10697;</button>
                      <button class="btn btn-sm btn-action-delete" data-id="${offer.id}" data-tooltip="Supprimer">&#128465;</button>
                    </td>
                  </tr>`;
        });

        html += `
                </tbody>
              </table>
            </div>
          </div>`;
      }

      container.innerHTML = html;
      attachMainListeners();
    }

    /* ==========================================================
       LISTENERS — PAGE PRINCIPALE
       ========================================================== */

    function attachMainListeners() {
      /* Boutons "Nouvelle offre" */
      const btnNew = container.querySelector('#btn-new-offer');
      if (btnNew) btnNew.addEventListener('click', () => openModal(null));

      const btnNewEmpty = container.querySelector('#btn-new-offer-empty');
      if (btnNewEmpty) btnNewEmpty.addEventListener('click', () => openModal(null));

      /* Recherche */
      const searchInput = container.querySelector('#offers-search');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          searchTerm = e.target.value;
          renderMain();
          /* Restaurer le focus après re-rendu */
          const el = container.querySelector('#offers-search');
          if (el) { el.focus(); el.selectionStart = el.selectionEnd = el.value.length; }
        });
      }

      /* Filtre type */
      const selType = container.querySelector('#offers-filter-type');
      if (selType) {
        selType.addEventListener('change', (e) => {
          filterType = e.target.value;
          renderMain();
        });
      }

      /* Filtre statut */
      const selActive = container.querySelector('#offers-filter-active');
      if (selActive) {
        selActive.addEventListener('change', (e) => {
          filterActive = e.target.value;
          renderMain();
        });
      }

      /* Boutons d'action sur chaque ligne */
      container.querySelectorAll('.btn-action-edit').forEach(btn => {
        btn.addEventListener('click', () => openModal(btn.dataset.id));
      });

      container.querySelectorAll('.btn-action-clone').forEach(btn => {
        btn.addEventListener('click', () => cloneOffer(btn.dataset.id));
      });

      container.querySelectorAll('.btn-action-delete').forEach(btn => {
        btn.addEventListener('click', () => deleteOffer(btn.dataset.id));
      });
    }

    /* ==========================================================
       CLONAGE D'UNE OFFRE
       ========================================================== */

    function cloneOffer(id) {
      const original = DB.offers.getById(id);
      if (!original) return;

      /* Copier tous les champs sauf id/dates techniques */
      const clone = {
        label: (original.label || '') + ' (copie)',
        type: original.type,
        clientIds: [...(original.clientIds || [])],
        moduleIds: [...(original.moduleIds || [])],
        price: original.price || 0,
        nbSessions: original.nbSessions || 0,
        recurrence: original.recurrence || null,
        sessionsConsumed: 0,
        startDate: original.startDate || '',
        endDate: original.endDate || '',
        notes: original.notes || '',
        active: true
      };

      DB.offers.create(clone);
      renderMain();
    }

    /* ==========================================================
       SUPPRESSION
       ========================================================== */

    function deleteOffer(id) {
      const offer = DB.offers.getById(id);
      if (!offer) return;

      const confirmed = confirm(`Supprimer l'offre "${offer.label || '(sans nom)'}" ?\nCette action est irr\u00e9versible.`);
      if (!confirmed) return;

      DB.offers.delete(id);
      renderMain();
    }

    /* ==========================================================
       MODALE — CRÉATION / ÉDITION
       ========================================================== */

    function openModal(offerId) {
      const isEdit = !!offerId;
      const offer = isEdit ? DB.offers.getById(offerId) : null;

      /* Valeurs par défaut pour la création */
      const data = {
        label: offer ? offer.label : '',
        type: offer ? offer.type : 'one_shot',
        clientIds: offer ? [...(offer.clientIds || [])] : [],
        moduleIds: offer ? [...(offer.moduleIds || [])] : [],
        price: offer ? (offer.price || 0) : 0,
        nbSessions: offer ? (offer.nbSessions || 0) : 0,
        recurrence: offer ? (offer.recurrence || '') : '',
        sessionsConsumed: offer ? (offer.sessionsConsumed || 0) : 0,
        startDate: offer ? (offer.startDate || '') : '',
        endDate: offer ? (offer.endDate || '') : '',
        notes: offer ? (offer.notes || '') : '',
        active: offer ? (offer.active !== false) : true
      };

      /* Listes de référence */
      const allClients = DB.clients.getAll();
      const allModules = DB.modules.getAll();

      /* --- Construction des listes à cocher --- */

      function buildCheckboxList(items, selectedIds, namePrefix, labelFn) {
        if (items.length === 0) {
          return `<p class="text-muted" style="font-size:0.82rem;">Aucun \u00e9l\u00e9ment disponible.</p>`;
        }
        let html = '<div style="max-height:150px;overflow-y:auto;border:1px solid var(--border-color);border-radius:6px;padding:8px;">';
        items.forEach(item => {
          const checked = selectedIds.includes(item.id) ? 'checked' : '';
          const lbl = labelFn(item);
          html += `
            <label class="form-check" style="margin-bottom:4px;">
              <input type="checkbox" name="${namePrefix}" value="${item.id}" ${checked}>
              <span>${esc(lbl)}</span>
            </label>`;
        });
        html += '</div>';
        return html;
      }

      const clientCheckboxes = buildCheckboxList(
        allClients,
        data.clientIds,
        'offer-clients',
        c => c.name || c.label || (`${c.firstName || ''} ${c.lastName || ''}`).trim() || c.id
      );

      const moduleCheckboxes = buildCheckboxList(
        allModules,
        data.moduleIds,
        'offer-modules',
        m => m.name || m.label || m.id
      );

      /* --- Options de récurrence --- */
      const recurrences = [
        { value: '', label: 'Aucune (one-shot)' },
        { value: 'mensuel', label: 'Mensuel' },
        { value: 'trimestriel', label: 'Trimestriel' },
        { value: 'semestriel', label: 'Semestriel' },
        { value: 'annuel', label: 'Annuel' }
      ];

      let recurrenceOptions = '';
      recurrences.forEach(r => {
        const sel = (data.recurrence === r.value) ? 'selected' : '';
        recurrenceOptions += `<option value="${r.value}" ${sel}>${r.label}</option>`;
      });

      /* --- Visibilité conditionnelle : champs abonnement --- */
      const showAboFields = data.type === 'abonnement';

      /* --- HTML de la modale --- */
      const modalTitle = isEdit ? 'Modifier l\u2019offre' : 'Nouvelle offre';

      let modalHtml = `
        <div class="modal-overlay" id="offer-modal-overlay">
          <div class="modal modal-lg">
            <div class="modal-header">
              <h2>${modalTitle}</h2>
              <button class="btn btn-sm btn-ghost" id="modal-close-x">&times;</button>
            </div>
            <div class="modal-body">

              <!-- Zone d'alerte prix plancher -->
              <div id="floor-alert" class="hidden"></div>

              <div class="form-row">
                <div class="form-group">
                  <label for="offer-label">Libell\u00e9 *</label>
                  <input type="text" id="offer-label" class="form-control"
                         placeholder="Ex : Pack Formation Q1 2025" value="${esc(data.label)}">
                </div>
                <div class="form-group">
                  <label for="offer-type">Type *</label>
                  <select id="offer-type" class="form-control">
                    <option value="one_shot" ${data.type === 'one_shot' ? 'selected' : ''}>One-shot</option>
                    <option value="abonnement" ${data.type === 'abonnement' ? 'selected' : ''}>Abonnement</option>
                    <option value="personnalisee" ${data.type === 'personnalisee' ? 'selected' : ''}>Personnalis\u00e9e</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="offer-price">Prix total (EUR) *</label>
                  <input type="number" id="offer-price" class="form-control" min="0" step="any"
                         value="${data.price}">
                  <span class="form-help" id="floor-hint"></span>
                </div>
                <div class="form-group">
                  <label>Statut</label>
                  <select id="offer-active" class="form-control">
                    <option value="true" ${data.active ? 'selected' : ''}>Active</option>
                    <option value="false" ${!data.active ? 'selected' : ''}>Inactive</option>
                  </select>
                </div>
              </div>

              <!-- Champs spécifiques abonnement -->
              <div id="abo-fields" class="${showAboFields ? '' : 'hidden'}">
                <div class="form-row">
                  <div class="form-group">
                    <label for="offer-nb-sessions">Nombre de sessions</label>
                    <input type="number" id="offer-nb-sessions" class="form-control" min="0" step="any"
                           value="${data.nbSessions}">
                  </div>
                  <div class="form-group">
                    <label for="offer-recurrence">R\u00e9currence</label>
                    <select id="offer-recurrence" class="form-control">
                      ${recurrenceOptions}
                    </select>
                  </div>
                  ${isEdit ? `
                  <div class="form-group">
                    <label for="offer-sessions-consumed">Sessions consomm\u00e9es</label>
                    <input type="number" id="offer-sessions-consumed" class="form-control" min="0" step="any"
                           value="${data.sessionsConsumed}">
                  </div>` : ''}
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="offer-start-date">Date de d\u00e9but</label>
                  <input type="date" id="offer-start-date" class="form-control" value="${esc(data.startDate)}">
                </div>
                <div class="form-group">
                  <label for="offer-end-date">Date de fin</label>
                  <input type="date" id="offer-end-date" class="form-control" value="${esc(data.endDate)}">
                </div>
              </div>

              <!-- Affectation clients -->
              <div class="form-group">
                <label>Client(s) associ\u00e9(s)</label>
                <div id="clients-checkbox-list">
                  ${clientCheckboxes}
                </div>
                <span class="form-help">Une offre peut \u00eatre mutualis\u00e9e entre plusieurs clients.</span>
              </div>

              <!-- Affectation modules -->
              <div class="form-group">
                <label>Module(s) inclus</label>
                <div id="modules-checkbox-list">
                  ${moduleCheckboxes}
                </div>
              </div>

              <!-- Notes -->
              <div class="form-group">
                <label for="offer-notes">Notes</label>
                <textarea id="offer-notes" class="form-control" rows="3"
                          placeholder="Remarques, conditions particuli\u00e8res...">${esc(data.notes)}</textarea>
              </div>

            </div>
            <div class="modal-footer">
              <button class="btn" id="modal-cancel">Annuler</button>
              <button class="btn btn-primary" id="modal-save">${isEdit ? 'Enregistrer' : 'Cr\u00e9er'}</button>
            </div>
          </div>
        </div>`;

      /* Injection de la modale dans le DOM */
      const wrapper = document.createElement('div');
      wrapper.innerHTML = modalHtml;
      document.body.appendChild(wrapper.firstElementChild);

      const overlay = document.getElementById('offer-modal-overlay');

      /* --- Vérification du prix plancher (à l'ouverture et au changement) --- */
      function checkFloorPrice() {
        const priceInput = overlay.querySelector('#offer-price');
        const nbSessionsInput = overlay.querySelector('#offer-nb-sessions');
        const typeSelect = overlay.querySelector('#offer-type');
        const floorAlert = overlay.querySelector('#floor-alert');
        const floorHint = overlay.querySelector('#floor-hint');

        const currentPrice = parseFloat(priceInput.value) || 0;
        const currentNbSessions = parseInt(nbSessionsInput ? nbSessionsInput.value : '1', 10) || 1;

        /* Récupérer les modules sélectionnés */
        const selectedModules = [];
        overlay.querySelectorAll('input[name="offer-modules"]:checked').forEach(cb => {
          selectedModules.push(cb.value);
        });

        /* Construire un objet offre partiel pour le calcul du plancher */
        const partialOffer = {
          type: typeSelect.value,
          moduleIds: selectedModules,
          nbSessions: currentNbSessions
        };

        const floor = Engine.computeOfferFloor(partialOffer);

        /* Afficher le prix plancher en indication */
        floorHint.textContent = `Prix plancher estim\u00e9 : ${Engine.fmt(floor)}`;

        /* Alerte si en dessous */
        if (currentPrice > 0 && currentPrice < floor) {
          floorAlert.className = 'alert alert-danger mb-16';
          floorAlert.innerHTML = `
            <span class="alert-icon">&#9888;</span>
            <div>
              <strong>Prix sous le seuil plancher</strong><br>
              Le prix saisi (${Engine.fmt(currentPrice)}) est inf\u00e9rieur au co\u00fbt plancher estim\u00e9 (${Engine.fmt(floor)}).
              Vous pouvez tout de m\u00eame enregistrer, mais la rentabilit\u00e9 n'est pas assur\u00e9e.
            </div>`;
        } else {
          floorAlert.className = 'hidden';
          floorAlert.innerHTML = '';
        }
      }

      /* Appel initial */
      checkFloorPrice();

      /* --- Écouteurs de la modale --- */

      /* Afficher/masquer les champs abonnement selon le type */
      const typeSelect = overlay.querySelector('#offer-type');
      typeSelect.addEventListener('change', () => {
        const aboFields = overlay.querySelector('#abo-fields');
        if (typeSelect.value === 'abonnement') {
          aboFields.classList.remove('hidden');
        } else {
          aboFields.classList.add('hidden');
        }
        checkFloorPrice();
      });

      /* Re-calcul plancher quand le prix, les sessions ou les modules changent */
      overlay.querySelector('#offer-price').addEventListener('input', checkFloorPrice);

      const nbSessionsInput = overlay.querySelector('#offer-nb-sessions');
      if (nbSessionsInput) {
        nbSessionsInput.addEventListener('input', checkFloorPrice);
      }

      overlay.querySelectorAll('input[name="offer-modules"]').forEach(cb => {
        cb.addEventListener('change', checkFloorPrice);
      });

      /* Fermeture de la modale */
      function closeModal() {
        if (overlay && overlay.parentNode) {
          overlay.parentNode.removeChild(overlay);
        }
      }

      overlay.querySelector('#modal-close-x').addEventListener('click', closeModal);
      overlay.querySelector('#modal-cancel').addEventListener('click', closeModal);

      /* Fermer en cliquant sur l'overlay (hors modale) */
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) closeModal();
      });

      /* Fermer avec Echap */
      function escHandler(e) {
        if (e.key === 'Escape') {
          closeModal();
          document.removeEventListener('keydown', escHandler);
        }
      }
      document.addEventListener('keydown', escHandler);

      /* --- Sauvegarde --- */
      overlay.querySelector('#modal-save').addEventListener('click', () => {
        const label = overlay.querySelector('#offer-label').value.trim();
        if (!label) {
          alert('Le libell\u00e9 de l\u2019offre est obligatoire.');
          overlay.querySelector('#offer-label').focus();
          return;
        }

        const type = overlay.querySelector('#offer-type').value;
        const price = parseFloat(overlay.querySelector('#offer-price').value) || 0;
        const active = overlay.querySelector('#offer-active').value === 'true';
        const startDate = overlay.querySelector('#offer-start-date').value;
        const endDate = overlay.querySelector('#offer-end-date').value;
        const notes = overlay.querySelector('#offer-notes').value.trim();

        /* Champs abonnement */
        const nbSessionsEl = overlay.querySelector('#offer-nb-sessions');
        const nbSessions = nbSessionsEl ? (parseInt(nbSessionsEl.value, 10) || 0) : 0;

        const recurrenceEl = overlay.querySelector('#offer-recurrence');
        const recurrence = recurrenceEl ? (recurrenceEl.value || null) : null;

        const sessConsumedEl = overlay.querySelector('#offer-sessions-consumed');
        const sessionsConsumed = sessConsumedEl ? (parseInt(sessConsumedEl.value, 10) || 0) : (isEdit ? data.sessionsConsumed : 0);

        /* Clients sélectionnés */
        const selectedClientIds = [];
        overlay.querySelectorAll('input[name="offer-clients"]:checked').forEach(cb => {
          selectedClientIds.push(cb.value);
        });

        /* Modules sélectionnés */
        const selectedModuleIds = [];
        overlay.querySelectorAll('input[name="offer-modules"]:checked').forEach(cb => {
          selectedModuleIds.push(cb.value);
        });

        /* Vérification finale du prix plancher (alerte non bloquante) */
        const partialOffer = { type, moduleIds: selectedModuleIds, nbSessions };
        const floor = Engine.computeOfferFloor(partialOffer);
        if (price > 0 && price < floor) {
          const proceed = confirm(
            `Attention : le prix (${Engine.fmt(price)}) est inf\u00e9rieur au seuil plancher (${Engine.fmt(floor)}).\n` +
            `La rentabilit\u00e9 de cette offre n'est pas garantie.\n\nContinuer quand m\u00eame ?`
          );
          if (!proceed) return;
        }

        /* Objet offre à persister */
        const offerData = {
          label,
          type,
          clientIds: selectedClientIds,
          moduleIds: selectedModuleIds,
          price,
          nbSessions: type === 'abonnement' ? nbSessions : 0,
          recurrence: type === 'abonnement' ? recurrence : null,
          sessionsConsumed: type === 'abonnement' ? sessionsConsumed : 0,
          startDate,
          endDate,
          notes,
          active
        };

        if (isEdit) {
          DB.offers.update(offerId, offerData);
        } else {
          DB.offers.create(offerData);
        }

        closeModal();
        renderMain();
      });
    }

    /* ==========================================================
       RENDU INITIAL
       ========================================================== */

    renderMain();
  }
};
/* ============================================================
   DST-SYSTEM — Vue Sessions
   Module le plus central : relie clients, offres, modules,
   opérateurs et lieux. CRUD complet, calcul de coûts en temps
   réel, alertes, compatibilité, consommation abonnement.
   ============================================================ */

window.Views = window.Views || {};

Views.Sessions = {

  /* ==========================================================
     Point d'entrée — rendu dans le conteneur fourni
     ========================================================== */
  render(container) {
    'use strict';

    // --- État local ---
    let searchTerm = '';
    let filterStatus = 'all';

    // --- Données référentielles (rechargées à chaque rendu) ---
    const allClients   = () => DB.clients.getAll();
    const allOperators = () => DB.operators.getAll();
    const allModules   = () => DB.modules.getAll();
    const allLocations = () => DB.locations.getAll();
    const allOffers    = () => DB.offers.getAll();
    const allSessions  = () => DB.sessions.getAll();

    /* --------------------------------------------------------
       Helpers de lookup (résolution id → entité)
       -------------------------------------------------------- */
    function clientName(id) {
      const c = DB.clients.getById(id);
      return c ? (c.name || `${c.firstName || ''} ${c.lastName || ''}`.trim()) : '—';
    }

    function operatorName(id) {
      const o = DB.operators.getById(id);
      return o ? `${o.firstName || ''} ${o.lastName || ''}`.trim() : '—';
    }

    function moduleName(id) {
      const m = DB.modules.getById(id);
      return m ? m.name : '—';
    }

    function locationName(id) {
      const l = DB.locations.getById(id);
      return l ? l.name : '—';
    }

    function offerLabel(id) {
      const o = DB.offers.getById(id);
      if (!o) return '—';
      return o.label || o.name || Engine.offerTypeLabel(o.type);
    }

    /* --------------------------------------------------------
       Correspondance statut → classe tag CSS
       -------------------------------------------------------- */
    function statusTagClass(status) {
      const map = {
        planifiee: 'tag-blue',
        confirmee: 'tag-green',
        en_cours:  'tag-yellow',
        terminee:  'tag-neutral',
        annulee:   'tag-red'
      };
      return map[status] || 'tag-neutral';
    }

    /* --------------------------------------------------------
       Classe CSS pour le niveau d'alerte Engine
       -------------------------------------------------------- */
    function alertCssClass(level) {
      if (level === 'critical') return 'alert-danger';
      if (level === 'warning')  return 'alert-warning';
      return 'alert-info';
    }

    function alertIcon(level) {
      if (level === 'critical') return '!!';
      if (level === 'warning')  return '!';
      return 'i';
    }

    /* --------------------------------------------------------
       Formater une date ISO en JJ/MM/AAAA
       -------------------------------------------------------- */
    function fmtDate(iso) {
      if (!iso) return '—';
      const d = new Date(iso);
      if (isNaN(d)) return iso;
      return d.toLocaleDateString('fr-FR');
    }

    /* --------------------------------------------------------
       Raccourci liste tronquée (3 éléments max)
       -------------------------------------------------------- */
    function truncList(arr, mapFn, max) {
      max = max || 3;
      if (!arr || arr.length === 0) return '—';
      const mapped = arr.map(mapFn);
      if (mapped.length <= max) return mapped.join(', ');
      return mapped.slice(0, max).join(', ') + ` (+${mapped.length - max})`;
    }

    /* ==========================================================
       Rendu principal — en-tête + table ou état vide
       ========================================================== */
    function renderMain() {
      const sessions = allSessions();

      // Filtrage par statut
      let filtered = sessions;
      if (filterStatus !== 'all') {
        filtered = filtered.filter(s => s.status === filterStatus);
      }

      // Filtrage par recherche texte
      if (searchTerm) {
        const q = searchTerm.toLowerCase();
        filtered = filtered.filter(s => {
          const label = (s.label || '').toLowerCase();
          const clientNames = (s.clientIds || []).map(id => clientName(id).toLowerCase()).join(' ');
          const modNames = (s.moduleIds || []).map(id => moduleName(id).toLowerCase()).join(' ');
          const loc = locationName(s.locationId).toLowerCase();
          return label.includes(q) || clientNames.includes(q) || modNames.includes(q) || loc.includes(q);
        });
      }

      // Tri par date décroissante
      filtered.sort((a, b) => {
        const da = a.date ? new Date(a.date) : new Date(0);
        const db = b.date ? new Date(b.date) : new Date(0);
        return db - da;
      });

      // Compteurs par statut pour les onglets
      const countByStatus = {};
      sessions.forEach(s => {
        countByStatus[s.status] = (countByStatus[s.status] || 0) + 1;
      });

      container.innerHTML = `
        <!-- En-tête de page -->
        <div class="page-header">
          <h1>Sessions</h1>
          <div class="actions">
            <div class="search-bar">
              <span class="search-icon">&#128269;</span>
              <input type="text" id="sess-search" class="form-control"
                     placeholder="Rechercher..." value="${searchTerm}">
            </div>
            <button class="btn btn-primary" id="btn-new-session">+ Nouvelle session</button>
          </div>
        </div>

        <!-- Onglets de filtre par statut -->
        <div class="tabs" id="sess-status-tabs">
          <button class="tab-btn ${filterStatus === 'all' ? 'active' : ''}" data-status="all">
            Toutes (${sessions.length})
          </button>
          <button class="tab-btn ${filterStatus === 'planifiee' ? 'active' : ''}" data-status="planifiee">
            Planifiées (${countByStatus.planifiee || 0})
          </button>
          <button class="tab-btn ${filterStatus === 'confirmee' ? 'active' : ''}" data-status="confirmee">
            Confirmées (${countByStatus.confirmee || 0})
          </button>
          <button class="tab-btn ${filterStatus === 'en_cours' ? 'active' : ''}" data-status="en_cours">
            En cours (${countByStatus.en_cours || 0})
          </button>
          <button class="tab-btn ${filterStatus === 'terminee' ? 'active' : ''}" data-status="terminee">
            Terminées (${countByStatus.terminee || 0})
          </button>
          <button class="tab-btn ${filterStatus === 'annulee' ? 'active' : ''}" data-status="annulee">
            Annulées (${countByStatus.annulee || 0})
          </button>
        </div>

        ${filtered.length === 0 ? renderEmptyState() : renderTable(filtered)}
      `;

      attachMainListeners(filtered);
    }

    /* ==========================================================
       Rendu de l'état vide
       ========================================================== */
    function renderEmptyState() {
      return `
        <div class="empty-state">
          <div class="empty-icon">&#128197;</div>
          <p>Aucune session ${filterStatus !== 'all' ? 'avec ce statut' : 'enregistrée'}.</p>
          <button class="btn btn-primary" id="btn-empty-new">+ Créer une session</button>
        </div>
      `;
    }

    /* ==========================================================
       Rendu de la table des sessions
       ========================================================== */
    function renderTable(sessions) {
      const rows = sessions.map(s => {
        const cost = Engine.computeSessionCost(s);
        const marginClass = cost.belowFloor ? 'text-red'
          : cost.marginPercent < (DB.settings.get().marginAlertThreshold || 15) ? 'text-yellow'
          : 'text-green';

        return `
          <tr data-id="${s.id}">
            <td>${fmtDate(s.date)}${s.time ? '<br><span class="text-muted" style="font-size:.75rem">' + s.time + '</span>' : ''}</td>
            <td><strong>${s.label || '—'}</strong></td>
            <td>${truncList(s.clientIds, clientName)}</td>
            <td>${truncList(s.moduleIds, moduleName, 2)}</td>
            <td>${truncList(s.operatorIds, operatorName, 2)}</td>
            <td>${locationName(s.locationId)}</td>
            <td class="num">${s.price ? Engine.fmt(s.price) : '—'}</td>
            <td class="num ${marginClass}">${s.price ? Engine.fmtPercent(cost.marginPercent) : '—'}</td>
            <td><span class="tag ${statusTagClass(s.status)}">${Engine.sessionStatusLabel(s.status)}</span></td>
            <td class="actions-cell">
              <button class="btn btn-sm btn-edit" data-id="${s.id}" title="Modifier">&#9998;</button>
              <button class="btn btn-sm btn-delete" data-id="${s.id}" title="Supprimer">&#128465;</button>
            </td>
          </tr>
        `;
      }).join('');

      return `
        <div class="card">
          <div class="data-table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Libellé</th>
                  <th>Client(s)</th>
                  <th>Modules</th>
                  <th>Opérateurs</th>
                  <th>Lieu</th>
                  <th class="text-right">Prix</th>
                  <th class="text-right">Marge %</th>
                  <th>Statut</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    /* ==========================================================
       Écouteurs de la vue principale
       ========================================================== */
    function attachMainListeners(filteredSessions) {
      // Recherche
      const searchInput = container.querySelector('#sess-search');
      if (searchInput) {
        searchInput.addEventListener('input', e => {
          searchTerm = e.target.value;
          renderMain();
        });
      }

      // Onglets statut
      const tabs = container.querySelectorAll('#sess-status-tabs .tab-btn');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          filterStatus = tab.dataset.status;
          renderMain();
        });
      });

      // Bouton nouvelle session (en-tête et état vide)
      const btnNew = container.querySelector('#btn-new-session');
      if (btnNew) btnNew.addEventListener('click', () => openModal(null));

      const btnEmptyNew = container.querySelector('#btn-empty-new');
      if (btnEmptyNew) btnEmptyNew.addEventListener('click', () => openModal(null));

      // Boutons modifier
      container.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', e => {
          e.stopPropagation();
          const id = btn.dataset.id;
          const session = DB.sessions.getById(id);
          if (session) openModal(session);
        });
      });

      // Boutons supprimer
      container.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', e => {
          e.stopPropagation();
          const id = btn.dataset.id;
          const session = DB.sessions.getById(id);
          if (session) openDeleteConfirm(session);
        });
      });
    }

    /* ==========================================================
       Modal de confirmation de suppression
       ========================================================== */
    function openDeleteConfirm(session) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal" style="max-width:480px">
          <div class="modal-header">
            <h2>Supprimer la session</h2>
            <button class="btn btn-sm btn-close-modal">&times;</button>
          </div>
          <div class="modal-body">
            <p>Confirmez-vous la suppression de la session
               <strong>${session.label || '(sans libellé)'}</strong>
               du ${fmtDate(session.date)} ?</p>
            <p class="text-muted" style="margin-top:8px;font-size:.82rem">
              Cette action est irréversible.
            </p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-cancel-del">Annuler</button>
            <button class="btn btn-primary btn-confirm-del">Supprimer</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);

      // Fermeture
      const close = () => { overlay.remove(); };
      overlay.querySelector('.btn-close-modal').addEventListener('click', close);
      overlay.querySelector('.btn-cancel-del').addEventListener('click', close);
      overlay.addEventListener('click', e => { if (e.target === overlay) close(); });

      // Confirmation
      overlay.querySelector('.btn-confirm-del').addEventListener('click', () => {
        DB.sessions.delete(session.id);
        close();
        renderMain();
      });
    }

    /* ==========================================================
       Vérifications de compatibilité
       ========================================================== */

    /**
     * Vérifie les incompatibilités entre modules sélectionnés.
     * Retourne un tableau de messages d'avertissement.
     */
    function checkModuleIncompatibilities(moduleIds) {
      const warnings = [];
      if (!moduleIds || moduleIds.length < 2) return warnings;
      const mods = moduleIds.map(id => DB.modules.getById(id)).filter(Boolean);
      for (let i = 0; i < mods.length; i++) {
        for (let j = i + 1; j < mods.length; j++) {
          const a = mods[i];
          const b = mods[j];
          // Vérifier si a déclare b incompatible
          if (a.incompatibilities && a.incompatibilities.includes(b.id)) {
            warnings.push(`"${a.name}" et "${b.name}" sont déclarés incompatibles.`);
          }
          // Vérifier si b déclare a incompatible
          if (b.incompatibilities && b.incompatibilities.includes(a.id)) {
            if (!warnings.some(w => w.includes(a.name) && w.includes(b.name))) {
              warnings.push(`"${b.name}" et "${a.name}" sont déclarés incompatibles.`);
            }
          }
        }
      }
      return warnings;
    }

    /**
     * Vérifie si les modules sélectionnés sont compatibles avec le lieu choisi.
     * Retourne un tableau de messages d'avertissement.
     */
    function checkLocationCompatibility(locationId, moduleIds) {
      const warnings = [];
      if (!locationId || !moduleIds || moduleIds.length === 0) return warnings;
      const loc = DB.locations.getById(locationId);
      if (!loc || !loc.compatibleModuleIds) return warnings;
      moduleIds.forEach(modId => {
        if (!loc.compatibleModuleIds.includes(modId)) {
          const mod = DB.modules.getById(modId);
          warnings.push(
            `Le module "${mod ? mod.name : modId}" n'est pas compatible avec le lieu "${loc.name}".`
          );
        }
      });
      return warnings;
    }

    /* ==========================================================
       Informations abonnement (si offre de type abonnement)
       ========================================================== */
    function renderSubscriptionInfo(offerId) {
      if (!offerId) return '';
      const offer = DB.offers.getById(offerId);
      if (!offer || offer.type !== 'abonnement') return '';

      const total  = offer.nbSessions || 0;
      const used   = offer.sessionsConsumed || 0;
      const remain = Math.max(total - used, 0);
      const pct    = total > 0 ? Math.round((used / total) * 100) : 0;

      let fillClass = 'fill-green';
      if (pct >= 90) fillClass = 'fill-red';
      else if (pct >= 70) fillClass = 'fill-yellow';

      return `
        <div class="card" style="margin-top:12px;padding:14px">
          <div class="card-header" style="margin-bottom:8px">
            <h3>Consommation abonnement</h3>
          </div>
          <p style="font-size:.85rem;margin-bottom:8px">
            Offre : <strong>${offer.label || offer.name || Engine.offerTypeLabel(offer.type)}</strong>
          </p>
          <div class="flex-between mb-8" style="font-size:.82rem">
            <span>${used} / ${total} sessions consommées</span>
            <span class="${remain <= 2 ? 'text-red' : ''}">${remain} restante(s)</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill ${fillClass}" style="width:${Math.min(pct, 100)}%"></div>
          </div>
          ${remain === 0 ? '<p class="text-red" style="margin-top:6px;font-size:.8rem">Toutes les sessions de cet abonnement ont été consommées.</p>' : ''}
        </div>
      `;
    }

    /* ==========================================================
       Panneau de ventilation des coûts (temps réel)
       ========================================================== */
    function renderCostBreakdown(sessionData) {
      const cost = Engine.computeSessionCost(sessionData);

      // Alertes
      let alertsHtml = '';
      if (cost.alerts.length > 0) {
        alertsHtml = cost.alerts.map(a => `
          <div class="alert ${alertCssClass(a.level)}">
            <span class="alert-icon">${alertIcon(a.level)}</span>
            <span>${a.message}</span>
          </div>
        `).join('');
      }

      return `
        <div class="card" id="cost-breakdown-panel" style="margin-top:12px;padding:14px">
          <div class="card-header" style="margin-bottom:10px">
            <h3>Ventilation des coûts</h3>
          </div>

          ${alertsHtml}

          <div class="kpi-grid" style="grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px">
            <div class="kpi-card" style="padding:12px">
              <span class="kpi-label">Opérateurs</span>
              <span class="kpi-value" style="font-size:1.1rem">${Engine.fmt(cost.operatorsCost)}</span>
            </div>
            <div class="kpi-card" style="padding:12px">
              <span class="kpi-label">Modules</span>
              <span class="kpi-value" style="font-size:1.1rem">${Engine.fmt(cost.modulesCost)}</span>
            </div>
            <div class="kpi-card" style="padding:12px">
              <span class="kpi-label">Coûts variables</span>
              <span class="kpi-value" style="font-size:1.1rem">${Engine.fmt(cost.variableCosts)}</span>
            </div>
            <div class="kpi-card" style="padding:12px">
              <span class="kpi-label">Quote-part fixe</span>
              <span class="kpi-value" style="font-size:1.1rem">${Engine.fmt(cost.fixedCostShare)}</span>
            </div>
            <div class="kpi-card" style="padding:12px">
              <span class="kpi-label">Amortissements</span>
              <span class="kpi-value" style="font-size:1.1rem">${Engine.fmt(cost.amortizationShare)}</span>
            </div>
          </div>

          <table style="width:100%;font-size:.85rem;border-collapse:collapse">
            <tr style="border-top:1px solid var(--border-color)">
              <td style="padding:6px 0;font-weight:600">Coût total</td>
              <td class="text-right text-mono" style="padding:6px 0">${Engine.fmt(cost.totalCost)}</td>
            </tr>
            <tr>
              <td style="padding:6px 0;font-weight:600">Prix facturé</td>
              <td class="text-right text-mono" style="padding:6px 0">${Engine.fmt(cost.revenue)}</td>
            </tr>
            <tr style="border-top:1px solid var(--border-color)">
              <td style="padding:6px 0;font-weight:700">Marge</td>
              <td class="text-right text-mono ${cost.margin >= 0 ? 'text-green' : 'text-red'}" style="padding:6px 0">
                ${Engine.fmt(cost.margin)} (${Engine.fmtPercent(cost.marginPercent)})
              </td>
            </tr>
            <tr>
              <td style="padding:6px 0;color:var(--text-muted)">Prix plancher</td>
              <td class="text-right text-mono" style="padding:6px 0;color:var(--text-muted)">
                ${Engine.fmt(cost.floorPrice)}
              </td>
            </tr>
          </table>
        </div>
      `;
    }

    /* ==========================================================
       Sous-formulaire des coûts variables (ajout / suppression)
       ========================================================== */
    function renderVariableCostsSubform(variableCosts) {
      const lines = (variableCosts || []).map((vc, i) => `
        <div class="form-row" style="grid-template-columns:1fr 120px 40px;align-items:end;margin-bottom:6px" data-vc-idx="${i}">
          <div class="form-group" style="margin-bottom:0">
            ${i === 0 ? '<label>Libellé</label>' : ''}
            <input type="text" class="form-control vc-label" value="${vc.label || ''}" placeholder="Ex: Transport">
          </div>
          <div class="form-group" style="margin-bottom:0">
            ${i === 0 ? '<label>Montant</label>' : ''}
            <input type="number" class="form-control vc-amount" value="${vc.amount || 0}" min="0" step="any">
          </div>
          <div style="padding-bottom:2px">
            <button type="button" class="btn btn-sm vc-remove" data-idx="${i}" title="Retirer">&times;</button>
          </div>
        </div>
      `).join('');

      return `
        <div id="variable-costs-section">
          <label style="display:block;font-size:.8rem;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px">
            Coûts variables
          </label>
          ${lines}
          <button type="button" class="btn btn-sm" id="btn-add-vc" style="margin-top:4px">+ Ajouter un coût</button>
        </div>
      `;
    }

    /* ==========================================================
       Rendu multi-select sous forme de checkboxes
       ========================================================== */
    function renderCheckboxGroup(name, options, selectedIds) {
      if (!options || options.length === 0) {
        return '<p class="text-muted" style="font-size:.82rem">Aucun élément disponible.</p>';
      }
      const sel = selectedIds || [];
      return `
        <div class="checkbox-group" style="max-height:160px;overflow-y:auto;border:1px solid var(--border-color);border-radius:6px;padding:8px;background:var(--bg-input)">
          ${options.map(o => `
            <label class="form-check" style="margin-bottom:4px">
              <input type="checkbox" name="${name}" value="${o.id}" ${sel.includes(o.id) ? 'checked' : ''}>
              <span style="font-size:.85rem">${o.displayName}</span>
            </label>
          `).join('')}
        </div>
      `;
    }

    /* ==========================================================
       Modal de création / édition
       ========================================================== */
    function openModal(session) {
      const isEdit = !!session;
      const data = session ? { ...session } : {
        label: '',
        date: new Date().toISOString().split('T')[0],
        time: '',
        clientIds: [],
        offerId: '',
        moduleIds: [],
        operatorIds: [],
        locationId: '',
        price: 0,
        status: 'planifiee',
        variableCosts: [],
        recurrence: null,
        notes: ''
      };

      // Préparer les options pour les groupes de checkboxes
      const clientOpts = allClients().map(c => ({
        id: c.id,
        displayName: c.name || `${c.firstName || ''} ${c.lastName || ''}`.trim() || c.id
      }));

      const moduleOpts = allModules().map(m => ({
        id: m.id,
        displayName: m.name || m.id
      }));

      const operatorOpts = allOperators().map(o => ({
        id: o.id,
        displayName: `${o.firstName || ''} ${o.lastName || ''}`.trim() || o.id
      }));

      const locations = allLocations();
      const offers    = allOffers();

      // Construire le HTML de la modale
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';

      function buildModalContent() {
        // Alertes de compatibilité
        const modWarnings = checkModuleIncompatibilities(data.moduleIds);
        const locWarnings = checkLocationCompatibility(data.locationId, data.moduleIds);
        const compatAlerts = [...modWarnings, ...locWarnings];
        const compatHtml = compatAlerts.length > 0
          ? compatAlerts.map(w => `
              <div class="alert alert-warning">
                <span class="alert-icon">!</span>
                <span>${w}</span>
              </div>
            `).join('')
          : '';

        return `
          <div class="modal modal-lg">
            <div class="modal-header">
              <h2>${isEdit ? 'Modifier la session' : 'Nouvelle session'}</h2>
              <button class="btn btn-sm btn-close-modal">&times;</button>
            </div>
            <div class="modal-body">

              ${compatHtml}

              <div class="grid-2">
                <!-- Colonne gauche : formulaire -->
                <div>
                  <!-- Libellé -->
                  <div class="form-group">
                    <label for="sess-label">Libellé</label>
                    <input type="text" id="sess-label" class="form-control"
                           value="${data.label || ''}" placeholder="Ex: Session CQP Sécurité">
                  </div>

                  <!-- Date / Heure -->
                  <div class="form-row" style="grid-template-columns:1fr 1fr">
                    <div class="form-group">
                      <label for="sess-date">Date</label>
                      <input type="date" id="sess-date" class="form-control" value="${data.date || ''}">
                    </div>
                    <div class="form-group">
                      <label for="sess-time">Heure</label>
                      <input type="time" id="sess-time" class="form-control" value="${data.time || ''}">
                    </div>
                  </div>

                  <!-- Statut / Récurrence -->
                  <div class="form-row" style="grid-template-columns:1fr 1fr">
                    <div class="form-group">
                      <label for="sess-status">Statut</label>
                      <select id="sess-status" class="form-control">
                        <option value="planifiee"  ${data.status === 'planifiee'  ? 'selected' : ''}>Planifiée</option>
                        <option value="confirmee"  ${data.status === 'confirmee'  ? 'selected' : ''}>Confirmée</option>
                        <option value="en_cours"   ${data.status === 'en_cours'   ? 'selected' : ''}>En cours</option>
                        <option value="terminee"   ${data.status === 'terminee'   ? 'selected' : ''}>Terminée</option>
                        <option value="annulee"    ${data.status === 'annulee'    ? 'selected' : ''}>Annulée</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label for="sess-recurrence">Récurrence</label>
                      <select id="sess-recurrence" class="form-control">
                        <option value=""            ${!data.recurrence               ? 'selected' : ''}>Aucune</option>
                        <option value="hebdomadaire" ${data.recurrence === 'hebdomadaire' ? 'selected' : ''}>Hebdomadaire</option>
                        <option value="mensuel"      ${data.recurrence === 'mensuel'      ? 'selected' : ''}>Mensuel</option>
                      </select>
                    </div>
                  </div>

                  <!-- Prix -->
                  <div class="form-group">
                    <label for="sess-price">Prix facturé (EUR)</label>
                    <input type="number" id="sess-price" class="form-control"
                           value="${data.price || 0}" min="0" step="any">
                  </div>

                  <!-- Lieu -->
                  <div class="form-group">
                    <label for="sess-location">Lieu</label>
                    <select id="sess-location" class="form-control">
                      <option value="">— Aucun —</option>
                      ${locations.map(l => `
                        <option value="${l.id}" ${data.locationId === l.id ? 'selected' : ''}>${l.name}</option>
                      `).join('')}
                    </select>
                  </div>

                  <!-- Offre liée -->
                  <div class="form-group">
                    <label for="sess-offer">Offre liée (optionnel)</label>
                    <select id="sess-offer" class="form-control">
                      <option value="">— Aucune —</option>
                      ${offers.map(o => `
                        <option value="${o.id}" ${data.offerId === o.id ? 'selected' : ''}>
                          ${o.label || o.name || Engine.offerTypeLabel(o.type)}${o.type === 'abonnement' ? ' [Abo]' : ''}
                        </option>
                      `).join('')}
                    </select>
                  </div>

                  <!-- Clients (multi-select) -->
                  <div class="form-group">
                    <label>Client(s)</label>
                    ${renderCheckboxGroup('clientIds', clientOpts, data.clientIds)}
                  </div>

                  <!-- Modules (multi-select) -->
                  <div class="form-group">
                    <label>Module(s)</label>
                    ${renderCheckboxGroup('moduleIds', moduleOpts, data.moduleIds)}
                  </div>

                  <!-- Opérateurs (multi-select) -->
                  <div class="form-group">
                    <label>Opérateur(s)</label>
                    ${renderCheckboxGroup('operatorIds', operatorOpts, data.operatorIds)}
                  </div>

                  <!-- Coûts variables -->
                  ${renderVariableCostsSubform(data.variableCosts)}

                  <!-- Notes -->
                  <div class="form-group" style="margin-top:12px">
                    <label for="sess-notes">Notes</label>
                    <textarea id="sess-notes" class="form-control" rows="3"
                              placeholder="Remarques, consignes particulières...">${data.notes || ''}</textarea>
                  </div>
                </div>

                <!-- Colonne droite : ventilation coûts + abonnement -->
                <div>
                  ${renderCostBreakdown(data)}
                  ${renderSubscriptionInfo(data.offerId)}
                </div>
              </div>

            </div>
            <div class="modal-footer">
              <button class="btn btn-cancel">Annuler</button>
              <button class="btn btn-primary btn-save">
                ${isEdit ? 'Enregistrer' : 'Créer la session'}
              </button>
            </div>
          </div>
        `;
      }

      overlay.innerHTML = buildModalContent();
      document.body.appendChild(overlay);

      /* ---- Collecte des valeurs courantes du formulaire ---- */
      function gatherFormData() {
        const form = overlay;
        data.label  = (form.querySelector('#sess-label')  || {}).value || '';
        data.date   = (form.querySelector('#sess-date')   || {}).value || '';
        data.time   = (form.querySelector('#sess-time')   || {}).value || '';
        data.status = (form.querySelector('#sess-status') || {}).value || 'planifiee';
        data.price  = parseFloat((form.querySelector('#sess-price') || {}).value) || 0;
        data.locationId  = (form.querySelector('#sess-location')   || {}).value || '';
        data.offerId     = (form.querySelector('#sess-offer')      || {}).value || '';
        data.notes       = (form.querySelector('#sess-notes')      || {}).value || '';

        const recVal = (form.querySelector('#sess-recurrence') || {}).value;
        data.recurrence = recVal || null;

        // Checkboxes multi-select
        data.clientIds = Array.from(form.querySelectorAll('input[name="clientIds"]:checked')).map(cb => cb.value);
        data.moduleIds = Array.from(form.querySelectorAll('input[name="moduleIds"]:checked')).map(cb => cb.value);
        data.operatorIds = Array.from(form.querySelectorAll('input[name="operatorIds"]:checked')).map(cb => cb.value);

        // Coûts variables
        data.variableCosts = [];
        form.querySelectorAll('[data-vc-idx]').forEach(row => {
          const lbl = (row.querySelector('.vc-label') || {}).value || '';
          const amt = parseFloat((row.querySelector('.vc-amount') || {}).value) || 0;
          data.variableCosts.push({ label: lbl, amount: amt });
        });

        return data;
      }

      /* ---- Rafraîchir le panneau de coûts et la compatibilité ---- */
      function refreshRightPanel() {
        gatherFormData();
        // Re-rendre entièrement la modale pour refléter les changements
        overlay.innerHTML = buildModalContent();
        attachModalListeners();
      }

      /* ---- Écouteurs internes de la modale ---- */
      function attachModalListeners() {
        const form = overlay;

        // Fermeture
        const closeModal = () => { overlay.remove(); };
        form.querySelector('.btn-close-modal').addEventListener('click', closeModal);
        form.querySelector('.btn-cancel').addEventListener('click', closeModal);
        overlay.addEventListener('click', e => { if (e.target === overlay) closeModal(); });

        // Champs qui déclenchent un recalcul des coûts
        const recalcFields = [
          '#sess-price', '#sess-location', '#sess-offer'
        ];
        recalcFields.forEach(sel => {
          const el = form.querySelector(sel);
          if (el) el.addEventListener('change', refreshRightPanel);
        });

        // Checkboxes modules, opérateurs, clients → recalcul
        form.querySelectorAll('input[name="moduleIds"], input[name="operatorIds"], input[name="clientIds"]').forEach(cb => {
          cb.addEventListener('change', refreshRightPanel);
        });

        // Coûts variables — montants → recalcul
        form.querySelectorAll('.vc-amount').forEach(input => {
          input.addEventListener('change', refreshRightPanel);
        });

        // Retirer un coût variable
        form.querySelectorAll('.vc-remove').forEach(btn => {
          btn.addEventListener('click', () => {
            gatherFormData();
            const idx = parseInt(btn.dataset.idx, 10);
            data.variableCosts.splice(idx, 1);
            overlay.innerHTML = buildModalContent();
            attachModalListeners();
          });
        });

        // Ajouter un coût variable
        const btnAddVc = form.querySelector('#btn-add-vc');
        if (btnAddVc) {
          btnAddVc.addEventListener('click', () => {
            gatherFormData();
            data.variableCosts.push({ label: '', amount: 0 });
            overlay.innerHTML = buildModalContent();
            attachModalListeners();
          });
        }

        // --- Sauvegarde ---
        form.querySelector('.btn-save').addEventListener('click', () => {
          gatherFormData();

          // Validation minimale
          if (!data.date) {
            alert('Veuillez renseigner une date.');
            return;
          }

          // Déterminer si le statut vient de passer à « terminee »
          const previousStatus = session ? session.status : null;
          const newStatus = data.status;
          const justCompleted = (newStatus === 'terminee' && previousStatus !== 'terminee');

          if (isEdit) {
            DB.sessions.update(session.id, data);
          } else {
            DB.sessions.create(data);
          }

          // Mise à jour consommation abonnement si la session passe à « terminée »
          if (justCompleted && data.offerId) {
            const offer = DB.offers.getById(data.offerId);
            if (offer && offer.type === 'abonnement') {
              const consumed = (offer.sessionsConsumed || 0) + 1;
              DB.offers.update(offer.id, { sessionsConsumed: consumed });
            }
          }

          // Si session redevient non-terminée depuis terminée (annulation de complétion)
          if (isEdit && previousStatus === 'terminee' && newStatus !== 'terminee' && data.offerId) {
            const offer = DB.offers.getById(data.offerId);
            if (offer && offer.type === 'abonnement') {
              const consumed = Math.max((offer.sessionsConsumed || 0) - 1, 0);
              DB.offers.update(offer.id, { sessionsConsumed: consumed });
            }
          }

          closeModal();
          renderMain();
        });
      }

      attachModalListeners();
    }

    /* ==========================================================
       Lancement du premier rendu
       ========================================================== */
    renderMain();
  }
};
/* ============================================================
   DST-SYSTEM — Vue Opérateurs (Vivier RH)
   Gestion complète du pool d'opérateurs : CRUD, calcul de coûts
   bidirectionnel, arbitrage RH multi-statuts.
   ============================================================ */

window.Views = window.Views || {};

Views.Operators = (() => {
  'use strict';

  /* ----------------------------------------------------------
     CONSTANTES
     ---------------------------------------------------------- */

  /** Correspondance statut → classe CSS du tag */
  const STATUS_TAG_CLASS = {
    freelance:          'tag-blue',
    interim:            'tag-yellow',
    cdd:                'tag-yellow',
    cdi:                'tag-green',
    contrat_journalier: 'tag-neutral',
    fondateur:          'tag-red'
  };

  /** Liste ordonnée des statuts pour les selects */
  const STATUS_OPTIONS = [
    'freelance',
    'interim',
    'contrat_journalier',
    'cdd',
    'cdi',
    'fondateur'
  ];

  /* ----------------------------------------------------------
     ÉTAT LOCAL DE LA VUE
     ---------------------------------------------------------- */

  /** Référence vers le conteneur DOM principal */
  let _container = null;

  /** Filtre de recherche courant (nom ou statut) */
  let _searchQuery = '';

  /** Filtre par statut ('' = tous) */
  let _statusFilter = '';

  /* ----------------------------------------------------------
     POINT D'ENTRÉE — RENDER
     ---------------------------------------------------------- */

  /**
   * Rendu principal de la vue opérateurs.
   * @param {HTMLElement} container — élément DOM cible
   */
  function render(container) {
    _container = container;
    _searchQuery = '';
    _statusFilter = '';
    _renderPage();
  }

  /* ----------------------------------------------------------
     RENDU DE LA PAGE COMPLÈTE
     ---------------------------------------------------------- */

  /** Construit et injecte le HTML complet de la page */
  function _renderPage() {
    const operators = _getFilteredOperators();
    const allOperators = DB.operators.getAll();

    // KPI rapides
    const totalActive = allOperators.filter(op => op.active !== false).length;
    const totalPool = allOperators.length;
    const avgCost = _computeAverageCost(allOperators.filter(op => op.active !== false));

    _container.innerHTML = `
      <!-- En-tête de page -->
      <div class="page-header">
        <h1>Vivier RH — Opérateurs</h1>
        <div class="actions">
          <button class="btn btn-primary" id="btn-add-operator">+ Nouvel opérateur</button>
        </div>
      </div>

      <!-- KPI résumé -->
      <div class="kpi-grid">
        <div class="kpi-card">
          <span class="kpi-label">Pool total</span>
          <span class="kpi-value">${totalPool}</span>
          <span class="kpi-detail">${totalActive} actif${totalActive > 1 ? 's' : ''}</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-label">Coût moyen / jour</span>
          <span class="kpi-value">${avgCost !== null ? Engine.fmt(avgCost) : '—'}</span>
          <span class="kpi-detail">Coût entreprise (actifs)</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-label">Freelances</span>
          <span class="kpi-value">${allOperators.filter(o => o.status === 'freelance').length}</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-label">CDI / Fondateurs</span>
          <span class="kpi-value">${allOperators.filter(o => o.status === 'cdi' || o.status === 'fondateur').length}</span>
        </div>
      </div>

      <!-- Barre de recherche et filtre -->
      <div class="card">
        <div class="flex-between gap-12" style="flex-wrap:wrap;">
          <div class="search-bar">
            <span class="search-icon">&#128269;</span>
            <input type="text" id="search-operators" placeholder="Rechercher par nom, spécialité…"
                   value="${_escapeAttr(_searchQuery)}" />
          </div>
          <div class="flex gap-8" style="align-items:center;">
            <label style="font-size:0.8rem;color:var(--text-secondary);white-space:nowrap;">Filtrer par statut :</label>
            <select id="filter-status" class="form-control" style="width:auto;min-width:160px;">
              <option value="">Tous les statuts</option>
              ${STATUS_OPTIONS.map(s => `
                <option value="${s}" ${_statusFilter === s ? 'selected' : ''}>${Engine.statusLabel(s)}</option>
              `).join('')}
            </select>
          </div>
        </div>
      </div>

      <!-- Tableau des opérateurs -->
      <div class="card">
        ${operators.length === 0 ? _renderEmptyState() : _renderTable(operators)}
      </div>
    `;

    // Attacher les événements
    _bindPageEvents();
  }

  /* ----------------------------------------------------------
     RENDU DU TABLEAU
     ---------------------------------------------------------- */

  /**
   * Génère le HTML du tableau d'opérateurs.
   * @param {Array} operators — liste filtrée
   * @returns {string} HTML
   */
  function _renderTable(operators) {
    const settings = DB.settings.get();

    const rows = operators.map(op => {
      const cost = _getDisplayCost(op, settings);
      const tagClass = STATUS_TAG_CLASS[op.status] || 'tag-neutral';
      const specialties = (op.specialties || []).join(', ') || '—';
      const activeLabel = op.active !== false
        ? '<span class="tag tag-green">Actif</span>'
        : '<span class="tag tag-neutral">Inactif</span>';

      return `
        <tr>
          <td><strong>${_escape(op.firstName)} ${_escape(op.lastName)}</strong></td>
          <td><span class="tag ${tagClass}">${Engine.statusLabel(op.status)}</span></td>
          <td class="num">${cost !== null ? Engine.fmt(cost) : '—'}</td>
          <td>${_escape(specialties)}</td>
          <td>${activeLabel}</td>
          <td class="actions-cell">
            <button class="btn btn-sm" data-action="view" data-id="${op.id}" title="Voir détails & arbitrage">Détails</button>
            <button class="btn btn-sm" data-action="edit" data-id="${op.id}" title="Modifier">Modifier</button>
            <button class="btn btn-sm" data-action="delete" data-id="${op.id}" title="Supprimer" style="color:var(--accent-red-light);">Supprimer</button>
          </td>
        </tr>
      `;
    }).join('');

    return `
      <div class="data-table-wrap">
        <table class="data-table">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Statut</th>
              <th>Coût / jour</th>
              <th>Spécialités</th>
              <th>Actif</th>
              <th class="text-right">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      </div>
    `;
  }

  /** Rendu de l'état vide (aucun opérateur trouvé) */
  function _renderEmptyState() {
    if (DB.operators.getAll().length === 0) {
      return `
        <div class="empty-state">
          <div class="empty-icon">&#128100;</div>
          <p>Aucun opérateur dans le vivier RH.</p>
          <button class="btn btn-primary" id="btn-add-operator-empty">+ Ajouter un opérateur</button>
        </div>
      `;
    }
    return `
      <div class="empty-state">
        <div class="empty-icon">&#128269;</div>
        <p>Aucun opérateur ne correspond aux critères de recherche.</p>
      </div>
    `;
  }

  /* ----------------------------------------------------------
     MODALE — FORMULAIRE CRÉATION / ÉDITION
     ---------------------------------------------------------- */

  /**
   * Ouvre la modale de création ou d'édition d'un opérateur.
   * @param {object|null} operator — opérateur existant (null = création)
   */
  function _openFormModal(operator) {
    const isEdit = !!operator;
    const op = operator || _defaultOperator();

    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.id = 'operator-modal-overlay';

    overlay.innerHTML = `
      <div class="modal modal-lg">
        <div class="modal-header">
          <h2>${isEdit ? 'Modifier l\'opérateur' : 'Nouvel opérateur'}</h2>
          <button class="btn btn-sm btn-ghost" id="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <form id="operator-form" autocomplete="off">

            <!-- Identité -->
            <div class="form-row">
              <div class="form-group">
                <label for="op-firstName">Prénom *</label>
                <input type="text" id="op-firstName" class="form-control" required
                       value="${_escapeAttr(op.firstName)}" placeholder="Prénom" />
              </div>
              <div class="form-group">
                <label for="op-lastName">Nom *</label>
                <input type="text" id="op-lastName" class="form-control" required
                       value="${_escapeAttr(op.lastName)}" placeholder="Nom" />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="op-email">Email</label>
                <input type="email" id="op-email" class="form-control"
                       value="${_escapeAttr(op.email)}" placeholder="email@exemple.fr" />
              </div>
              <div class="form-group">
                <label for="op-phone">Téléphone</label>
                <input type="text" id="op-phone" class="form-control"
                       value="${_escapeAttr(op.phone)}" placeholder="06 xx xx xx xx" />
              </div>
            </div>

            <!-- Statut et activité -->
            <div class="form-row">
              <div class="form-group">
                <label for="op-status">Statut *</label>
                <select id="op-status" class="form-control" required>
                  ${STATUS_OPTIONS.map(s => `
                    <option value="${s}" ${op.status === s ? 'selected' : ''}>${Engine.statusLabel(s)}</option>
                  `).join('')}
                </select>
              </div>
              <div class="form-group" style="display:flex;align-items:flex-end;">
                <label class="form-check">
                  <input type="checkbox" id="op-active" ${op.active !== false ? 'checked' : ''} />
                  <span>Opérateur actif</span>
                </label>
              </div>
            </div>

            <!-- Mode de coût -->
            <div class="card" style="margin-top:8px;">
              <div class="card-header">
                <h3>Tarification</h3>
              </div>

              <div class="form-group">
                <label>Mode de calcul</label>
                <div class="flex gap-16" style="margin-top:4px;">
                  <label class="form-check">
                    <input type="radio" name="costMode" value="net_desired"
                           ${op.costMode !== 'company_max' ? 'checked' : ''} />
                    <span>Net souhaité par l'opérateur</span>
                  </label>
                  <label class="form-check">
                    <input type="radio" name="costMode" value="company_max"
                           ${op.costMode === 'company_max' ? 'checked' : ''} />
                    <span>Coût max entreprise</span>
                  </label>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group" id="group-netDaily">
                  <label for="op-netDaily">Net journalier souhaité (&euro;)</label>
                  <input type="number" id="op-netDaily" class="form-control" min="0" step="any"
                         value="${op.netDaily || ''}" placeholder="Ex : 250" />
                </div>
                <div class="form-group" id="group-companyCost">
                  <label for="op-companyCostDaily">Coût max entreprise / jour (&euro;)</label>
                  <input type="number" id="op-companyCostDaily" class="form-control" min="0" step="any"
                         value="${op.companyCostDaily || ''}" placeholder="Ex : 450" />
                </div>
              </div>

              <!-- Résultat du calcul en temps réel -->
              <div id="cost-preview" class="mt-8"></div>
            </div>

            <!-- Spécialités (tags) -->
            <div class="form-group mt-16">
              <label for="op-specialties">Spécialités</label>
              <input type="text" id="op-specialties" class="form-control"
                     value="${_escapeAttr((op.specialties || []).join(', '))}"
                     placeholder="Tir tactique, CQB, médical… (séparées par des virgules)" />
              <span class="form-help">Séparez chaque spécialité par une virgule.</span>
            </div>

            <!-- Notes -->
            <div class="form-group">
              <label for="op-notes">Notes</label>
              <textarea id="op-notes" class="form-control" rows="3"
                        placeholder="Informations complémentaires…">${_escape(op.notes || '')}</textarea>
            </div>

          </form>
        </div>
        <div class="modal-footer">
          <button class="btn" id="modal-cancel">Annuler</button>
          <button class="btn btn-primary" id="modal-save">${isEdit ? 'Enregistrer' : 'Créer'}</button>
        </div>
      </div>
    `;

    document.body.appendChild(overlay);

    // Initialiser la visibilité des champs de coût
    _toggleCostFields();

    // Calcul de coût initial si des valeurs existent
    _updateCostPreview();

    // --- Événements de la modale ---

    // Fermeture
    const closeModal = () => overlay.remove();
    overlay.querySelector('#modal-close').addEventListener('click', closeModal);
    overlay.querySelector('#modal-cancel').addEventListener('click', closeModal);
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) closeModal();
    });

    // Basculer entre les modes de coût
    overlay.querySelectorAll('input[name="costMode"]').forEach(radio => {
      radio.addEventListener('change', () => {
        _toggleCostFields();
        _updateCostPreview();
      });
    });

    // Mise à jour du calcul en temps réel
    overlay.querySelector('#op-netDaily').addEventListener('input', _updateCostPreview);
    overlay.querySelector('#op-companyCostDaily').addEventListener('input', _updateCostPreview);
    overlay.querySelector('#op-status').addEventListener('change', _updateCostPreview);

    // Sauvegarde
    overlay.querySelector('#modal-save').addEventListener('click', () => {
      const form = overlay.querySelector('#operator-form');
      if (!form.reportValidity()) return;
      _saveOperator(isEdit ? op.id : null, overlay);
    });
  }

  /** Bascule la visibilité des champs selon le mode de coût */
  function _toggleCostFields() {
    const overlay = document.getElementById('operator-modal-overlay');
    if (!overlay) return;

    const mode = overlay.querySelector('input[name="costMode"]:checked').value;
    const groupNet = overlay.querySelector('#group-netDaily');
    const groupCompany = overlay.querySelector('#group-companyCost');

    if (mode === 'net_desired') {
      groupNet.style.display = '';
      groupCompany.style.display = 'none';
    } else {
      groupNet.style.display = 'none';
      groupCompany.style.display = '';
    }
  }

  /** Met à jour l'aperçu du calcul de coût dans la modale */
  function _updateCostPreview() {
    const overlay = document.getElementById('operator-modal-overlay');
    if (!overlay) return;

    const mode = overlay.querySelector('input[name="costMode"]:checked').value;
    const status = overlay.querySelector('#op-status').value;
    const preview = overlay.querySelector('#cost-preview');
    const settings = DB.settings.get();

    let calc = null;

    if (mode === 'net_desired') {
      const netVal = parseFloat(overlay.querySelector('#op-netDaily').value);
      if (!netVal || netVal <= 0) { preview.innerHTML = ''; return; }
      calc = Engine.netToCompanyCost(netVal, status, settings);
    } else {
      const costVal = parseFloat(overlay.querySelector('#op-companyCostDaily').value);
      if (!costVal || costVal <= 0) { preview.innerHTML = ''; return; }
      calc = Engine.companyCostToNet(costVal, status, settings);
    }

    if (!calc) { preview.innerHTML = ''; return; }

    preview.innerHTML = `
      <div class="kpi-grid" style="grid-template-columns:repeat(4,1fr);">
        <div class="kpi-card">
          <span class="kpi-label">Net / jour</span>
          <span class="kpi-value" style="font-size:1.2rem;">${Engine.fmt(calc.net)}</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-label">Brut / jour</span>
          <span class="kpi-value" style="font-size:1.2rem;">${Engine.fmt(calc.gross)}</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-label">Charges</span>
          <span class="kpi-value" style="font-size:1.2rem;">${Engine.fmt(calc.charges)}</span>
        </div>
        <div class="kpi-card${status === 'fondateur' ? '' : ' kpi-warning'}">
          <span class="kpi-label">Coût entreprise</span>
          <span class="kpi-value" style="font-size:1.2rem;">${Engine.fmt(calc.companyCost)}</span>
        </div>
      </div>
    `;
  }

  /* ----------------------------------------------------------
     MODALE — VUE DÉTAILS + ARBITRAGE RH
     ---------------------------------------------------------- */

  /**
   * Ouvre la modale de détails d'un opérateur avec l'arbitrage multi-statuts.
   * @param {object} op — opérateur
   */
  function _openDetailModal(op) {
    const settings = DB.settings.get();

    // Calcul du coût actuel
    const currentCost = _computeOperatorCost(op, settings);

    // Net de référence pour l'arbitrage
    const referenceNet = currentCost ? currentCost.net : (op.netDaily || 0);

    // Comparaison de tous les statuts
    const comparison = referenceNet > 0
      ? Engine.compareAllStatuses(referenceNet, settings)
      : [];

    // Identifier le plus cher pour la couleur rouge
    const maxCost = comparison.length > 0
      ? comparison[comparison.length - 1].companyCost
      : 0;

    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';

    overlay.innerHTML = `
      <div class="modal modal-lg">
        <div class="modal-header">
          <h2>${_escape(op.firstName)} ${_escape(op.lastName)}</h2>
          <button class="btn btn-sm btn-ghost" id="detail-close">&times;</button>
        </div>
        <div class="modal-body">

          <!-- Informations de base -->
          <div class="card">
            <div class="card-header">
              <h3>Informations</h3>
              <span class="tag ${STATUS_TAG_CLASS[op.status] || 'tag-neutral'}">${Engine.statusLabel(op.status)}</span>
            </div>
            <div class="form-row">
              <div>
                <span class="kpi-label">Email</span><br/>
                <span>${_escape(op.email || '—')}</span>
              </div>
              <div>
                <span class="kpi-label">Téléphone</span><br/>
                <span>${_escape(op.phone || '—')}</span>
              </div>
              <div>
                <span class="kpi-label">Actif</span><br/>
                <span>${op.active !== false ? '<span class="tag tag-green">Oui</span>' : '<span class="tag tag-neutral">Non</span>'}</span>
              </div>
            </div>
            ${(op.specialties && op.specialties.length > 0) ? `
              <div class="mt-16">
                <span class="kpi-label">Spécialités</span><br/>
                <div class="flex gap-8" style="flex-wrap:wrap;margin-top:4px;">
                  ${op.specialties.map(s => `<span class="tag tag-blue">${_escape(s)}</span>`).join('')}
                </div>
              </div>
            ` : ''}
            ${op.notes ? `
              <div class="mt-16">
                <span class="kpi-label">Notes</span><br/>
                <span style="white-space:pre-line;">${_escape(op.notes)}</span>
              </div>
            ` : ''}
          </div>

          <!-- Coût actuel -->
          ${currentCost ? `
          <div class="card">
            <div class="card-header">
              <h3>Coût actuel — ${Engine.statusLabel(op.status)}</h3>
              <span class="tag tag-neutral">${op.costMode === 'company_max' ? 'Mode : coût max entreprise' : 'Mode : net souhaité'}</span>
            </div>
            <div class="kpi-grid" style="grid-template-columns:repeat(4,1fr);">
              <div class="kpi-card">
                <span class="kpi-label">Net / jour</span>
                <span class="kpi-value" style="font-size:1.3rem;">${Engine.fmt(currentCost.net)}</span>
              </div>
              <div class="kpi-card">
                <span class="kpi-label">Brut / jour</span>
                <span class="kpi-value" style="font-size:1.3rem;">${Engine.fmt(currentCost.gross)}</span>
              </div>
              <div class="kpi-card">
                <span class="kpi-label">Charges</span>
                <span class="kpi-value" style="font-size:1.3rem;">${Engine.fmt(currentCost.charges)}</span>
              </div>
              <div class="kpi-card">
                <span class="kpi-label">Coût entreprise</span>
                <span class="kpi-value" style="font-size:1.3rem;">${Engine.fmt(currentCost.companyCost)}</span>
              </div>
            </div>
          </div>
          ` : ''}

          <!-- Arbitrage RH — Comparaison de tous les statuts -->
          ${referenceNet > 0 ? `
          <div class="card">
            <div class="card-header">
              <h3>Arbitrage RH — Comparaison pour ${Engine.fmt(referenceNet)} net/jour</h3>
            </div>
            <p style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:12px;">
              Pour un même net journalier de <strong>${Engine.fmt(referenceNet)}</strong>,
              voici le coût entreprise selon chaque statut contractuel.
            </p>
            <div class="comparison-grid">
              ${comparison.map((item, idx) => {
                // Premier = recommandé (le moins cher), dernier = plus cher
                let cardClass = '';
                if (item.companyCost === 0) {
                  cardClass = 'recommended'; // Fondateur = coût 0
                } else if (idx === 0) {
                  cardClass = 'recommended';
                } else if (item.companyCost === maxCost && maxCost > 0) {
                  cardClass = 'not-recommended';
                }
                const isCurrent = item.status === op.status;
                return `
                  <div class="comparison-card ${cardClass}" ${isCurrent ? 'style="outline:2px solid var(--color-info);"' : ''}>
                    <div class="comp-label">${item.label}${isCurrent ? ' (actuel)' : ''}</div>
                    <div class="comp-value">${Engine.fmt(item.companyCost)}</div>
                    <div class="comp-detail">
                      Brut : ${Engine.fmt(item.gross)}<br/>
                      Charges : ${Engine.fmt(item.charges)}
                    </div>
                    ${idx === 0 && item.companyCost > 0 ? '<div class="comp-detail" style="margin-top:4px;"><strong style="color:var(--color-success);">Recommandé</strong></div>' : ''}
                    ${item.companyCost === maxCost && maxCost > 0 && idx === comparison.length - 1 ? '<div class="comp-detail" style="margin-top:4px;"><strong style="color:var(--accent-red-light);">Plus coûteux</strong></div>' : ''}
                  </div>
                `;
              }).join('')}
            </div>
            ${comparison.length >= 2 && comparison[0].companyCost > 0 ? `
              <div class="mt-16" style="font-size:0.82rem;color:var(--text-secondary);">
                Écart entre le moins cher (<strong>${comparison[0].label}</strong>) et le plus cher
                (<strong>${comparison[comparison.length - 1].label}</strong>) :
                <strong style="color:var(--accent-red-light);">${Engine.fmt(comparison[comparison.length - 1].companyCost - comparison[0].companyCost)}</strong> / jour
                (${Engine.fmtPercent(((comparison[comparison.length - 1].companyCost - comparison[0].companyCost) / comparison[0].companyCost) * 100)})
              </div>
            ` : ''}
          </div>
          ` : `
          <div class="card">
            <div class="card-header"><h3>Arbitrage RH</h3></div>
            <p style="font-size:0.85rem;color:var(--text-muted);">
              Renseignez un tarif journalier pour cet opérateur afin d'afficher la comparaison multi-statuts.
            </p>
          </div>
          `}

        </div>
        <div class="modal-footer">
          <button class="btn" id="detail-close-footer">Fermer</button>
          <button class="btn btn-primary" id="detail-edit">Modifier</button>
        </div>
      </div>
    `;

    document.body.appendChild(overlay);

    // Fermeture
    const closeDetail = () => overlay.remove();
    overlay.querySelector('#detail-close').addEventListener('click', closeDetail);
    overlay.querySelector('#detail-close-footer').addEventListener('click', closeDetail);
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) closeDetail();
    });

    // Bouton modifier → ouvre le formulaire
    overlay.querySelector('#detail-edit').addEventListener('click', () => {
      closeDetail();
      _openFormModal(op);
    });
  }

  /* ----------------------------------------------------------
     MODALE — CONFIRMATION DE SUPPRESSION
     ---------------------------------------------------------- */

  /**
   * Demande confirmation avant de supprimer un opérateur.
   * @param {object} op — opérateur à supprimer
   */
  function _confirmDelete(op) {
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';

    overlay.innerHTML = `
      <div class="modal" style="max-width:480px;">
        <div class="modal-header">
          <h2>Confirmer la suppression</h2>
          <button class="btn btn-sm btn-ghost" id="del-close">&times;</button>
        </div>
        <div class="modal-body">
          <p style="margin-bottom:8px;">
            Voulez-vous vraiment supprimer l'opérateur
            <strong>${_escape(op.firstName)} ${_escape(op.lastName)}</strong> ?
          </p>
          <p style="font-size:0.82rem;color:var(--text-muted);">
            Cette action est irréversible. L'opérateur sera retiré du vivier RH.
          </p>
        </div>
        <div class="modal-footer">
          <button class="btn" id="del-cancel">Annuler</button>
          <button class="btn btn-primary" id="del-confirm" style="background:var(--accent-red);border-color:var(--accent-red);">Supprimer</button>
        </div>
      </div>
    `;

    document.body.appendChild(overlay);

    const closeConfirm = () => overlay.remove();
    overlay.querySelector('#del-close').addEventListener('click', closeConfirm);
    overlay.querySelector('#del-cancel').addEventListener('click', closeConfirm);
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) closeConfirm();
    });

    overlay.querySelector('#del-confirm').addEventListener('click', () => {
      DB.operators.delete(op.id);
      closeConfirm();
      _renderPage();
    });
  }

  /* ----------------------------------------------------------
     SAUVEGARDE D'UN OPÉRATEUR (CRÉATION OU MISE À JOUR)
     ---------------------------------------------------------- */

  /**
   * Collecte les données du formulaire et crée ou met à jour l'opérateur.
   * @param {string|null} operatorId — ID existant ou null pour création
   * @param {HTMLElement} overlay — élément modale à fermer après sauvegarde
   */
  function _saveOperator(operatorId, overlay) {
    const costMode = overlay.querySelector('input[name="costMode"]:checked').value;

    // Transformer les spécialités en tableau de tags propres
    const rawSpecialties = overlay.querySelector('#op-specialties').value;
    const specialties = rawSpecialties
      .split(',')
      .map(s => s.trim())
      .filter(s => s.length > 0);

    const data = {
      firstName:        overlay.querySelector('#op-firstName').value.trim(),
      lastName:         overlay.querySelector('#op-lastName').value.trim(),
      email:            overlay.querySelector('#op-email').value.trim(),
      phone:            overlay.querySelector('#op-phone').value.trim(),
      status:           overlay.querySelector('#op-status').value,
      active:           overlay.querySelector('#op-active').checked,
      costMode:         costMode,
      netDaily:         costMode === 'net_desired'
                          ? parseFloat(overlay.querySelector('#op-netDaily').value) || 0
                          : 0,
      companyCostDaily: costMode === 'company_max'
                          ? parseFloat(overlay.querySelector('#op-companyCostDaily').value) || 0
                          : 0,
      specialties:      specialties,
      notes:            overlay.querySelector('#op-notes').value.trim()
    };

    // Validation minimale
    if (!data.firstName || !data.lastName) return;

    if (operatorId) {
      DB.operators.update(operatorId, data);
    } else {
      DB.operators.create(data);
    }

    overlay.remove();
    _renderPage();
  }

  /* ----------------------------------------------------------
     ÉVÉNEMENTS DE LA PAGE
     ---------------------------------------------------------- */

  /** Attache tous les écouteurs d'événements de la page principale */
  function _bindPageEvents() {
    // Bouton ajout (en-tête)
    const btnAdd = _container.querySelector('#btn-add-operator');
    if (btnAdd) {
      btnAdd.addEventListener('click', () => _openFormModal(null));
    }

    // Bouton ajout (état vide)
    const btnAddEmpty = _container.querySelector('#btn-add-operator-empty');
    if (btnAddEmpty) {
      btnAddEmpty.addEventListener('click', () => _openFormModal(null));
    }

    // Recherche textuelle
    const searchInput = _container.querySelector('#search-operators');
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        _searchQuery = e.target.value;
        _renderPage();
        // Remettre le focus et la position du curseur
        const newInput = _container.querySelector('#search-operators');
        if (newInput) {
          newInput.focus();
          newInput.setSelectionRange(newInput.value.length, newInput.value.length);
        }
      });
    }

    // Filtre par statut
    const filterSelect = _container.querySelector('#filter-status');
    if (filterSelect) {
      filterSelect.addEventListener('change', (e) => {
        _statusFilter = e.target.value;
        _renderPage();
      });
    }

    // Actions sur les lignes du tableau (délégation d'événements)
    _container.querySelectorAll('[data-action]').forEach(btn => {
      btn.addEventListener('click', () => {
        const action = btn.dataset.action;
        const id = btn.dataset.id;
        const op = DB.operators.getById(id);
        if (!op) return;

        switch (action) {
          case 'view':
            _openDetailModal(op);
            break;
          case 'edit':
            _openFormModal(op);
            break;
          case 'delete':
            _confirmDelete(op);
            break;
        }
      });
    });
  }

  /* ----------------------------------------------------------
     UTILITAIRES INTERNES
     ---------------------------------------------------------- */

  /**
   * Retourne les opérateurs filtrés selon la recherche et le statut.
   * @returns {Array}
   */
  function _getFilteredOperators() {
    let operators = DB.operators.getAll();

    // Filtre par statut
    if (_statusFilter) {
      operators = operators.filter(op => op.status === _statusFilter);
    }

    // Filtre par recherche textuelle (nom, prénom, spécialités)
    if (_searchQuery.trim()) {
      const q = _searchQuery.toLowerCase().trim();
      operators = operators.filter(op => {
        const fullName = `${op.firstName} ${op.lastName}`.toLowerCase();
        const specs = (op.specialties || []).join(' ').toLowerCase();
        const statusText = Engine.statusLabel(op.status).toLowerCase();
        return fullName.includes(q) || specs.includes(q) || statusText.includes(q);
      });
    }

    // Tri : actifs en premier, puis par nom
    operators.sort((a, b) => {
      const activeA = a.active !== false ? 0 : 1;
      const activeB = b.active !== false ? 0 : 1;
      if (activeA !== activeB) return activeA - activeB;
      return `${a.lastName} ${a.firstName}`.localeCompare(`${b.lastName} ${b.firstName}`, 'fr');
    });

    return operators;
  }

  /**
   * Retourne le coût entreprise journalier d'un opérateur pour l'affichage.
   * @param {object} op — opérateur
   * @param {object} settings — paramètres économiques
   * @returns {number|null}
   */
  function _getDisplayCost(op, settings) {
    if (op.status === 'fondateur') return 0;
    if (op.costMode === 'company_max') {
      return op.companyCostDaily || null;
    }
    if (op.netDaily && op.netDaily > 0) {
      const calc = Engine.netToCompanyCost(op.netDaily, op.status, settings);
      return calc.companyCost;
    }
    return null;
  }

  /**
   * Calcule le détail complet du coût pour un opérateur.
   * @param {object} op — opérateur
   * @param {object} settings — paramètres économiques
   * @returns {object|null}
   */
  function _computeOperatorCost(op, settings) {
    if (op.costMode === 'company_max' && op.companyCostDaily > 0) {
      return Engine.companyCostToNet(op.companyCostDaily, op.status, settings);
    }
    if (op.netDaily && op.netDaily > 0) {
      return Engine.netToCompanyCost(op.netDaily, op.status, settings);
    }
    return null;
  }

  /**
   * Calcule le coût entreprise moyen des opérateurs actifs.
   * @param {Array} operators — liste d'opérateurs actifs
   * @returns {number|null}
   */
  function _computeAverageCost(operators) {
    if (operators.length === 0) return null;
    const settings = DB.settings.get();
    let total = 0;
    let count = 0;

    operators.forEach(op => {
      const cost = _getDisplayCost(op, settings);
      if (cost !== null && cost > 0) {
        total += cost;
        count++;
      }
    });

    return count > 0 ? Engine.round2(total / count) : null;
  }

  /**
   * Retourne un objet opérateur par défaut pour le formulaire de création.
   * @returns {object}
   */
  function _defaultOperator() {
    return {
      firstName: '',
      lastName: '',
      email: '',
      phone: '',
      status: 'freelance',
      active: true,
      costMode: 'net_desired',
      netDaily: 0,
      companyCostDaily: 0,
      specialties: [],
      notes: ''
    };
  }

  /**
   * Échappe le HTML pour éviter les injections XSS.
   * @param {string} str
   * @returns {string}
   */
  function _escape(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  /**
   * Échappe une chaîne pour utilisation dans un attribut HTML.
   * @param {string} str
   * @returns {string}
   */
  function _escapeAttr(str) {
    if (!str) return '';
    return str
      .replace(/&/g, '&amp;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  /* ----------------------------------------------------------
     API PUBLIQUE
     ---------------------------------------------------------- */

  return { render };

})();
/* ============================================================
   DST-SYSTEM — Vue : Catalogue des Modules de Formation
   Gestion CRUD complète des modules d'entraînement.
   Chaque module définit un objectif de session, ses coûts,
   ses contraintes et ses incompatibilités.
   ============================================================ */

window.Views = window.Views || {};

Views.Modules = {

  /* --- Point d'entrée principal --- */
  render(container) {
    'use strict';

    /* --------------------------------------------------------
       État local de la vue
       -------------------------------------------------------- */
    let searchQuery = '';
    let currentModal = null; // null | 'create' | moduleId (édition)

    /* --------------------------------------------------------
       Correspondance catégorie → classe CSS tag
       -------------------------------------------------------- */
    const CATEGORY_TAG_MAP = {
      'tir':          'tag-red',
      'cqb':          'tag-red',
      'stress':       'tag-yellow',
      'tactique':     'tag-blue',
      'secourisme':   'tag-green',
      'communication':'tag-blue',
      'leadership':   'tag-blue',
      'navigation':   'tag-neutral',
      'explosifs':    'tag-red',
      'renseignement':'tag-neutral'
    };

    /**
     * Retourne la classe CSS du tag pour une catégorie donnée.
     * Comparaison insensible à la casse, valeur par défaut neutre.
     */
    function categoryTagClass(category) {
      if (!category) return 'tag-neutral';
      const key = category.trim().toLowerCase();
      return CATEGORY_TAG_MAP[key] || 'tag-neutral';
    }

    /* --------------------------------------------------------
       Récupération et filtrage des modules
       -------------------------------------------------------- */

    /** Retourne tous les modules filtrés par la recherche courante. */
    function getFilteredModules() {
      const all = DB.modules.getAll();
      if (!searchQuery) return all;
      const q = searchQuery.toLowerCase();
      return all.filter(m =>
        (m.name || '').toLowerCase().includes(q) ||
        (m.category || '').toLowerCase().includes(q)
      );
    }

    /* --------------------------------------------------------
       Rendu principal
       -------------------------------------------------------- */

    function renderPage() {
      const modules = getFilteredModules();

      container.innerHTML = `
        <!-- En-tête de page -->
        <div class="page-header">
          <h1>Modules de formation</h1>
          <div class="actions">
            <div class="search-bar">
              <span class="search-icon">&#128269;</span>
              <input type="text"
                     id="mod-search"
                     class="form-control"
                     placeholder="Rechercher nom ou catégorie..."
                     value="${escapeAttr(searchQuery)}" />
            </div>
            <button class="btn btn-primary" id="btn-add-module">+ Nouveau module</button>
          </div>
        </div>

        <!-- Contenu principal -->
        ${modules.length === 0 ? renderEmptyState() : renderTable(modules)}
      `;

      /* --- Branchement des événements --- */
      bindPageEvents();
    }

    /* --------------------------------------------------------
       Rendu : état vide
       -------------------------------------------------------- */

    function renderEmptyState() {
      const hasSearch = searchQuery.length > 0;
      return `
        <div class="card">
          <div class="empty-state">
            <div class="empty-icon">&#128218;</div>
            <p>${hasSearch
              ? 'Aucun module ne correspond à votre recherche.'
              : 'Aucun module de formation enregistré.'
            }</p>
            ${hasSearch
              ? '<button class="btn btn-sm" id="btn-clear-search">Effacer la recherche</button>'
              : '<button class="btn btn-primary" id="btn-empty-add">Créer un premier module</button>'
            }
          </div>
        </div>
      `;
    }

    /* --------------------------------------------------------
       Rendu : tableau des modules
       -------------------------------------------------------- */

    function renderTable(modules) {
      const rows = modules.map(m => {
        /* Calcul du coût total affiché (fixe + variable) */
        const totalCost = (m.fixedCost || 0) + (m.variableCost || 0);
        const activeLabel = m.active !== false
          ? '<span class="tag tag-green">Actif</span>'
          : '<span class="tag tag-neutral">Inactif</span>';

        return `
          <tr data-id="${m.id}">
            <td>
              <strong>${escapeHtml(m.name || '')}</strong>
              ${m.objective ? `<br><span class="text-muted" style="font-size:0.78rem">${escapeHtml(truncate(m.objective, 60))}</span>` : ''}
            </td>
            <td><span class="tag ${categoryTagClass(m.category)}">${escapeHtml(m.category || '—')}</span></td>
            <td class="num">${m.requiredOperators || 1}</td>
            <td class="num" data-tooltip="Fixe : ${escapeAttr(Engine.fmt(m.fixedCost || 0))} + Variable : ${escapeAttr(Engine.fmt(m.variableCost || 0))}">
              ${Engine.fmt(totalCost)}
            </td>
            <td class="num">${m.duration ? m.duration + ' h' : '—'}</td>
            <td>${activeLabel}</td>
            <td class="actions-cell">
              <button class="btn btn-sm btn-ghost btn-edit" data-id="${m.id}" title="Modifier">&#9998;</button>
              <button class="btn btn-sm btn-ghost text-red btn-delete" data-id="${m.id}" title="Supprimer">&#128465;</button>
            </td>
          </tr>
        `;
      }).join('');

      return `
        <div class="card">
          <div class="data-table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Nom</th>
                  <th>Catégorie</th>
                  <th class="text-right">Opérateurs</th>
                  <th class="text-right">Coût session</th>
                  <th class="text-right">Durée</th>
                  <th>Statut</th>
                  <th class="text-right">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    /* --------------------------------------------------------
       Rendu : modale de création / édition
       -------------------------------------------------------- */

    /**
     * Affiche la modale de formulaire pour un module.
     * @param {Object|null} mod - module existant (édition) ou null (création)
     */
    function renderModal(mod) {
      const isEdit = !!mod;
      const title = isEdit ? 'Modifier le module' : 'Nouveau module de formation';
      const m = mod || {};

      /* Liste des autres modules pour les incompatibilités */
      const allModules = DB.modules.getAll().filter(x => !mod || x.id !== mod.id);
      const incompatibleIds = m.incompatibilities || [];

      /* Calcul d'aperçu coût */
      const previewFixedCost = m.fixedCost || 0;
      const previewVarCost = m.variableCost || 0;
      const previewTotal = previewFixedCost + previewVarCost;

      /* Construction des checkboxes d'incompatibilités */
      const incompatChecks = allModules.length > 0
        ? allModules.map(other => `
            <label class="form-check" style="margin-bottom:4px">
              <input type="checkbox"
                     name="incompat"
                     value="${other.id}"
                     ${incompatibleIds.includes(other.id) ? 'checked' : ''} />
              <span>${escapeHtml(other.name || other.id)}${other.category ? ' <span class="text-muted">(' + escapeHtml(other.category) + ')</span>' : ''}</span>
            </label>
          `).join('')
        : '<span class="text-muted">Aucun autre module disponible.</span>';

      /* Catégories suggérées (issues des modules existants + par défaut) */
      const existingCategories = [...new Set(
        DB.modules.getAll()
          .map(x => x.category)
          .filter(Boolean)
      )];
      const defaultCategories = ['Tir', 'CQB', 'Stress', 'Tactique', 'Secourisme'];
      const allCategories = [...new Set([...defaultCategories, ...existingCategories])];
      const datalistOptions = allCategories.map(c =>
        `<option value="${escapeAttr(c)}">`
      ).join('');

      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.id = 'mod-modal-overlay';

      overlay.innerHTML = `
        <div class="modal modal-lg">
          <!-- En-tête modale -->
          <div class="modal-header">
            <h2>${title}</h2>
            <button class="btn btn-sm btn-ghost" id="btn-modal-close">&times;</button>
          </div>

          <!-- Corps du formulaire -->
          <div class="modal-body">
            <form id="mod-form" autocomplete="off">

              <!-- Bloc principal -->
              <div class="form-row">
                <div class="form-group">
                  <label for="mod-name">Nom du module *</label>
                  <input type="text" id="mod-name" class="form-control"
                         value="${escapeAttr(m.name || '')}"
                         placeholder="Ex : Tir de précision longue distance" required />
                </div>
                <div class="form-group">
                  <label for="mod-category">Catégorie</label>
                  <input type="text" id="mod-category" class="form-control"
                         list="dl-categories"
                         value="${escapeAttr(m.category || '')}"
                         placeholder="Ex : Tir, CQB, Stress..." />
                  <datalist id="dl-categories">${datalistOptions}</datalist>
                </div>
              </div>

              <div class="form-group">
                <label for="mod-objective">Objectif de la session *</label>
                <textarea id="mod-objective" class="form-control" rows="2"
                          placeholder="Décrivez l'objectif pédagogique clair de ce module..."
                          required>${escapeHtml(m.objective || '')}</textarea>
                <div class="form-help">Cet objectif sera affiché sur les documents de session.</div>
              </div>

              <div class="form-group">
                <label for="mod-description">Description complémentaire</label>
                <textarea id="mod-description" class="form-control" rows="2"
                          placeholder="Détails internes, notes pour les opérateurs...">${escapeHtml(m.description || '')}</textarea>
              </div>

              <!-- Bloc opérateurs et durée -->
              <div class="form-row">
                <div class="form-group">
                  <label for="mod-operators">Opérateurs requis</label>
                  <input type="number" id="mod-operators" class="form-control"
                         min="1" step="any"
                         value="${m.requiredOperators || 1}"
                         placeholder="1" />
                  <div class="form-help">Nombre minimum d'opérateurs pour animer ce module.</div>
                </div>
                <div class="form-group">
                  <label for="mod-duration">Durée (heures)</label>
                  <input type="number" id="mod-duration" class="form-control"
                         min="0.5" step="any"
                         value="${m.duration || ''}"
                         placeholder="Ex : 4" />
                </div>
                <div class="form-group">
                  <label>&nbsp;</label>
                  <label class="form-check" style="margin-top:4px">
                    <input type="checkbox" id="mod-active" ${m.active !== false ? 'checked' : ''} />
                    <span>Module actif</span>
                  </label>
                </div>
              </div>

              <!-- Bloc coûts -->
              <div class="card" style="margin-top:8px">
                <div class="card-header">
                  <h3>Coûts du module</h3>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="mod-fixed-cost">Coût fixe par session</label>
                    <input type="number" id="mod-fixed-cost" class="form-control"
                           min="0" step="any"
                           value="${m.fixedCost || 0}"
                           placeholder="0" />
                    <div class="form-help">Ajouté systématiquement à chaque session.</div>
                  </div>
                  <div class="form-group">
                    <label for="mod-var-cost">Coût variable par session</label>
                    <input type="number" id="mod-var-cost" class="form-control"
                           min="0" step="any"
                           value="${m.variableCost || 0}"
                           placeholder="0" />
                    <div class="form-help">Consommables, munitions, usure matériel...</div>
                  </div>
                </div>
                <!-- Aperçu automatique du coût total -->
                <div id="cost-preview" class="alert alert-info" style="margin-top:8px">
                  <span class="alert-icon">&#9432;</span>
                  <span>
                    <strong>Effet sur session :</strong>
                    Fixe ${Engine.fmt(previewFixedCost)} + Variable ${Engine.fmt(previewVarCost)}
                    = <strong>${Engine.fmt(previewTotal)}</strong> par session
                    ${(m.requiredOperators || 1) > 1
                      ? ` — Nécessite <strong>${m.requiredOperators} opérateurs</strong>`
                      : ''}
                  </span>
                </div>
              </div>

              <!-- Bloc contraintes et logistique -->
              <div class="card" style="margin-top:8px">
                <div class="card-header">
                  <h3>Contraintes &amp; logistique</h3>
                </div>
                <div class="form-group">
                  <label for="mod-location">Exigences de lieu</label>
                  <input type="text" id="mod-location" class="form-control"
                         value="${escapeAttr(m.locationRequirements || '')}"
                         placeholder="Ex : Stand de tir homologué 200m, terrain urbain..." />
                </div>
                <div class="form-group">
                  <label for="mod-equipment">Matériel nécessaire</label>
                  <textarea id="mod-equipment" class="form-control" rows="2"
                            placeholder="Ex : 10 simulateurs laser, cibles IPSC, chronographe...">${escapeHtml(m.equipmentNeeded || '')}</textarea>
                </div>
                <div class="form-group">
                  <label for="mod-security">Contraintes de sécurité</label>
                  <textarea id="mod-security" class="form-control" rows="2"
                            placeholder="Ex : Briefing sécurité obligatoire, périmètre bouclé...">${escapeHtml(m.securityConstraints || '')}</textarea>
                </div>
              </div>

              <!-- Bloc incompatibilités -->
              <div class="card" style="margin-top:8px">
                <div class="card-header">
                  <h3>Incompatibilités</h3>
                </div>
                <p class="text-muted mb-8" style="font-size:0.82rem">
                  Cochez les modules qui ne peuvent pas être combinés avec celui-ci dans une même session.
                </p>
                <div id="incompat-list" style="max-height:180px;overflow-y:auto">
                  ${incompatChecks}
                </div>
              </div>

            </form>
          </div>

          <!-- Pied de modale -->
          <div class="modal-footer">
            <button class="btn" id="btn-modal-cancel">Annuler</button>
            <button class="btn btn-primary" id="btn-modal-save">
              ${isEdit ? 'Enregistrer les modifications' : 'Créer le module'}
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(overlay);
      bindModalEvents(overlay, mod);
    }

    /* --------------------------------------------------------
       Rendu : modale de confirmation de suppression
       -------------------------------------------------------- */

    function renderDeleteConfirm(mod) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.id = 'mod-delete-overlay';

      overlay.innerHTML = `
        <div class="modal" style="max-width:480px">
          <div class="modal-header">
            <h2>Confirmer la suppression</h2>
            <button class="btn btn-sm btn-ghost" id="btn-del-close">&times;</button>
          </div>
          <div class="modal-body">
            <div class="alert alert-danger">
              <span class="alert-icon">&#9888;</span>
              <span>
                Vous êtes sur le point de supprimer le module
                <strong>${escapeHtml(mod.name || '')}</strong>.<br>
                Cette action est irréversible.
              </span>
            </div>
            ${checkModuleUsage(mod.id)}
          </div>
          <div class="modal-footer">
            <button class="btn" id="btn-del-cancel">Annuler</button>
            <button class="btn btn-primary" id="btn-del-confirm" style="background:var(--accent-red)">
              Supprimer définitivement
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(overlay);

      /* Événements de la modale de suppression */
      const close = () => { overlay.remove(); };
      overlay.querySelector('#btn-del-close').addEventListener('click', close);
      overlay.querySelector('#btn-del-cancel').addEventListener('click', close);
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) close();
      });

      overlay.querySelector('#btn-del-confirm').addEventListener('click', () => {
        /* Nettoyer les références d'incompatibilité dans les autres modules */
        removeIncompatibilityRefs(mod.id);
        DB.modules.delete(mod.id);
        close();
        renderPage();
      });
    }

    /**
     * Vérifie si le module est utilisé dans des sessions existantes.
     * Retourne un avertissement HTML le cas échéant.
     */
    function checkModuleUsage(moduleId) {
      const sessions = DB.sessions.getAll().filter(s =>
        (s.moduleIds || []).includes(moduleId)
      );
      if (sessions.length === 0) return '';
      return `
        <div class="alert alert-warning" style="margin-top:8px">
          <span class="alert-icon">&#9888;</span>
          <span>
            Ce module est référencé dans <strong>${sessions.length} session(s)</strong>.
            La suppression ne modifiera pas les sessions existantes, mais elles
            référenceront un module introuvable.
          </span>
        </div>
      `;
    }

    /**
     * Supprime l'ID du module des listes d'incompatibilités des autres modules.
     */
    function removeIncompatibilityRefs(moduleId) {
      const allModules = DB.modules.getAll();
      allModules.forEach(m => {
        if (m.incompatibilities && m.incompatibilities.includes(moduleId)) {
          const cleaned = m.incompatibilities.filter(id => id !== moduleId);
          DB.modules.update(m.id, { incompatibilities: cleaned });
        }
      });
    }

    /* --------------------------------------------------------
       Événements : page principale
       -------------------------------------------------------- */

    function bindPageEvents() {
      /* Barre de recherche */
      const searchInput = container.querySelector('#mod-search');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          searchQuery = e.target.value.trim();
          renderPage();
          /* Remettre le focus et le curseur dans le champ de recherche */
          const newInput = container.querySelector('#mod-search');
          if (newInput) {
            newInput.focus();
            newInput.setSelectionRange(newInput.value.length, newInput.value.length);
          }
        });
      }

      /* Bouton "Effacer la recherche" (état vide avec filtre) */
      const btnClear = container.querySelector('#btn-clear-search');
      if (btnClear) {
        btnClear.addEventListener('click', () => {
          searchQuery = '';
          renderPage();
        });
      }

      /* Boutons d'ajout (en-tête et état vide) */
      const btnAdd = container.querySelector('#btn-add-module');
      if (btnAdd) {
        btnAdd.addEventListener('click', () => renderModal(null));
      }
      const btnEmptyAdd = container.querySelector('#btn-empty-add');
      if (btnEmptyAdd) {
        btnEmptyAdd.addEventListener('click', () => renderModal(null));
      }

      /* Boutons d'action dans le tableau */
      container.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', () => {
          const mod = DB.modules.getById(btn.dataset.id);
          if (mod) renderModal(mod);
        });
      });

      container.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', () => {
          const mod = DB.modules.getById(btn.dataset.id);
          if (mod) renderDeleteConfirm(mod);
        });
      });
    }

    /* --------------------------------------------------------
       Événements : modale de formulaire
       -------------------------------------------------------- */

    function bindModalEvents(overlay, existingMod) {
      const isEdit = !!existingMod;

      /* Fermeture de la modale */
      const close = () => { overlay.remove(); };

      overlay.querySelector('#btn-modal-close').addEventListener('click', close);
      overlay.querySelector('#btn-modal-cancel').addEventListener('click', close);
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) close();
      });

      /* Mise à jour dynamique de l'aperçu des coûts */
      const fixedInput = overlay.querySelector('#mod-fixed-cost');
      const varInput = overlay.querySelector('#mod-var-cost');
      const opInput = overlay.querySelector('#mod-operators');
      const preview = overlay.querySelector('#cost-preview');

      function updateCostPreview() {
        const fc = parseFloat(fixedInput.value) || 0;
        const vc = parseFloat(varInput.value) || 0;
        const total = fc + vc;
        const ops = parseInt(opInput.value) || 1;

        preview.innerHTML = `
          <span class="alert-icon">&#9432;</span>
          <span>
            <strong>Effet sur session :</strong>
            Fixe ${Engine.fmt(fc)} + Variable ${Engine.fmt(vc)}
            = <strong>${Engine.fmt(total)}</strong> par session
            ${ops > 1 ? ` — Nécessite <strong>${ops} opérateurs</strong>` : ''}
          </span>
        `;
      }

      fixedInput.addEventListener('input', updateCostPreview);
      varInput.addEventListener('input', updateCostPreview);
      opInput.addEventListener('input', updateCostPreview);

      /* Sauvegarde */
      overlay.querySelector('#btn-modal-save').addEventListener('click', () => {
        const form = overlay.querySelector('#mod-form');

        /* Récupération des valeurs */
        const name = overlay.querySelector('#mod-name').value.trim();
        const objective = overlay.querySelector('#mod-objective').value.trim();
        const category = overlay.querySelector('#mod-category').value.trim();
        const description = overlay.querySelector('#mod-description').value.trim();
        const requiredOperators = parseInt(overlay.querySelector('#mod-operators').value) || 1;
        const duration = parseFloat(overlay.querySelector('#mod-duration').value) || 0;
        const active = overlay.querySelector('#mod-active').checked;
        const fixedCost = parseFloat(fixedInput.value) || 0;
        const variableCost = parseFloat(varInput.value) || 0;
        const locationRequirements = overlay.querySelector('#mod-location').value.trim();
        const equipmentNeeded = overlay.querySelector('#mod-equipment').value.trim();
        const securityConstraints = overlay.querySelector('#mod-security').value.trim();

        /* Incompatibilités sélectionnées */
        const incompatibilities = [];
        overlay.querySelectorAll('input[name="incompat"]:checked').forEach(cb => {
          incompatibilities.push(cb.value);
        });

        /* Validation minimale */
        if (!name) {
          highlightField(overlay.querySelector('#mod-name'));
          return;
        }
        if (!objective) {
          highlightField(overlay.querySelector('#mod-objective'));
          return;
        }

        /* Construction de l'objet module */
        const data = {
          name,
          description,
          objective,
          category,
          requiredOperators,
          fixedCost,
          variableCost,
          locationRequirements,
          equipmentNeeded,
          securityConstraints,
          incompatibilities,
          duration,
          active
        };

        if (isEdit) {
          DB.modules.update(existingMod.id, data);
          /* Synchroniser les incompatibilités bidirectionnelles */
          syncIncompatibilities(existingMod.id, incompatibilities);
        } else {
          const created = DB.modules.create(data);
          /* Synchroniser les incompatibilités bidirectionnelles */
          syncIncompatibilities(created.id, incompatibilities);
        }

        close();
        renderPage();
      });
    }

    /* --------------------------------------------------------
       Synchronisation bidirectionnelle des incompatibilités
       Quand A est marqué incompatible avec B, B est aussi
       marqué incompatible avec A.
       -------------------------------------------------------- */

    function syncIncompatibilities(moduleId, selectedIds) {
      const allModules = DB.modules.getAll();

      allModules.forEach(other => {
        if (other.id === moduleId) return;

        const otherIncompat = other.incompatibilities || [];
        const shouldBeIncompat = selectedIds.includes(other.id);
        const isCurrentlyIncompat = otherIncompat.includes(moduleId);

        if (shouldBeIncompat && !isCurrentlyIncompat) {
          /* Ajouter la référence réciproque */
          DB.modules.update(other.id, {
            incompatibilities: [...otherIncompat, moduleId]
          });
        } else if (!shouldBeIncompat && isCurrentlyIncompat) {
          /* Retirer la référence réciproque */
          DB.modules.update(other.id, {
            incompatibilities: otherIncompat.filter(id => id !== moduleId)
          });
        }
      });
    }

    /* --------------------------------------------------------
       Utilitaires
       -------------------------------------------------------- */

    /** Échappe les caractères HTML dangereux. */
    function escapeHtml(str) {
      if (!str) return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    /** Échappe pour utilisation dans les attributs HTML. */
    function escapeAttr(str) {
      return escapeHtml(String(str));
    }

    /** Tronque un texte à la longueur maximale spécifiée. */
    function truncate(str, max) {
      if (!str || str.length <= max) return str || '';
      return str.substring(0, max) + '...';
    }

    /** Met en surbrillance un champ invalide avec un effet temporaire. */
    function highlightField(el) {
      if (!el) return;
      el.style.borderColor = 'var(--accent-red)';
      el.focus();
      setTimeout(() => {
        el.style.borderColor = '';
      }, 2000);
    }

    /* --------------------------------------------------------
       Lancement du rendu initial
       -------------------------------------------------------- */
    renderPage();
  }
};
/* ============================================================
   DST-SYSTEM — Vue : Gestion des Lieux
   CRUD complet pour les sites d'entraînement (stands de tir,
   salles CQB, terrains extérieurs, etc.)
   ============================================================ */

window.Views = window.Views || {};

Views.Locations = {

  /**
   * Point d'entrée — injecte le HTML dans le conteneur et
   * branche tous les écouteurs d'événements.
   */
  render(container) {
    'use strict';

    /* ----------------------------------------------------------
       État local de la vue
       ---------------------------------------------------------- */
    let searchTerm = '';

    /* ----------------------------------------------------------
       Helpers internes
       ---------------------------------------------------------- */

    /** Récupère les lieux filtrés selon la recherche courante. */
    function getFilteredLocations() {
      const all = DB.locations.getAll();
      if (!searchTerm) return all;
      const q = searchTerm.toLowerCase();
      return all.filter(loc =>
        (loc.name || '').toLowerCase().includes(q) ||
        (loc.city || '').toLowerCase().includes(q)
      );
    }

    /** Retourne le nombre de modules compatibles pour un lieu donné. */
    function compatibleCount(loc) {
      return (loc.compatibleModuleIds && loc.compatibleModuleIds.length) || 0;
    }

    /** Choisit la classe de tag CSS en fonction du type de lieu. */
    function typeTagClass(type) {
      const map = {
        'Stand de tir':      'tag-red',
        'Salle CQB':        'tag-yellow',
        'Terrain extérieur': 'tag-green',
        'Salle de cours':    'tag-blue',
        'Site client':       'tag-neutral',
        'Autre':             'tag-neutral'
      };
      return map[type] || 'tag-neutral';
    }

    /** Échappe le HTML pour éviter les injections XSS. */
    function esc(str) {
      if (str == null) return '';
      const el = document.createElement('span');
      el.textContent = String(str);
      return el.innerHTML;
    }

    /* ----------------------------------------------------------
       Construction du tableau principal
       ---------------------------------------------------------- */
    function buildTableHTML(locations) {
      if (locations.length === 0) {
        return `
          <div class="empty-state">
            <div class="empty-icon">&#x1F4CD;</div>
            <p>Aucun lieu enregistré pour le moment.</p>
            <button class="btn btn-primary" id="loc-empty-add">Ajouter un lieu</button>
          </div>`;
      }

      const rows = locations.map(loc => `
        <tr data-id="${esc(loc.id)}">
          <td>${esc(loc.name)}</td>
          <td>${esc(loc.city)}</td>
          <td><span class="tag ${typeTagClass(loc.type)}">${esc(loc.type || 'N/D')}</span></td>
          <td class="num">${loc.capacity != null ? loc.capacity : '—'}</td>
          <td class="num">${compatibleCount(loc)}</td>
          <td class="num">${Engine.fmt(loc.costPerSession || 0)}</td>
          <td>
            <span class="tag ${loc.active !== false ? 'tag-green' : 'tag-neutral'}">
              ${loc.active !== false ? 'Actif' : 'Inactif'}
            </span>
          </td>
          <td class="actions-cell">
            <button class="btn btn-sm btn-ghost loc-btn-edit" data-id="${esc(loc.id)}" title="Modifier">&#9998;</button>
            <button class="btn btn-sm btn-ghost loc-btn-delete" data-id="${esc(loc.id)}" title="Supprimer">&#128465;</button>
          </td>
        </tr>`).join('');

      return `
        <div class="data-table-wrap">
          <table class="data-table">
            <thead>
              <tr>
                <th>Nom</th>
                <th>Ville</th>
                <th>Type</th>
                <th class="num">Capacité</th>
                <th class="num">Modules</th>
                <th class="num">Coût / session</th>
                <th>Statut</th>
                <th></th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;
    }

    /* ----------------------------------------------------------
       Construction du modal (création / édition)
       ---------------------------------------------------------- */
    function buildModalHTML(loc) {
      const isEdit     = !!loc;
      const title      = isEdit ? 'Modifier le lieu' : 'Nouveau lieu';
      const data       = loc || {};
      const allModules = DB.modules.getAll();
      const selected   = data.compatibleModuleIds || [];

      /* Types prédéfinis pour le champ libre (datalist) */
      const typeOptions = [
        'Stand de tir',
        'Salle CQB',
        'Terrain extérieur',
        'Salle de cours',
        'Site client',
        'Autre'
      ];

      /* Liste de modules avec cases à cocher */
      let modulesCheckboxes = '';
      if (allModules.length === 0) {
        modulesCheckboxes = '<p class="text-muted" style="font-size:.82rem;">Aucun module enregistré.</p>';
      } else {
        modulesCheckboxes = allModules.map(m => {
          const checked = selected.includes(m.id) ? 'checked' : '';
          return `
            <label class="form-check" style="margin-bottom:6px;">
              <input type="checkbox" name="compatibleModuleIds" value="${esc(m.id)}" ${checked}>
              <span>${esc(m.name)}</span>
            </label>`;
        }).join('');
      }

      return `
      <div class="modal-overlay" id="loc-modal-overlay">
        <div class="modal modal-lg">

          <div class="modal-header">
            <h2>${title}</h2>
            <button class="btn btn-sm btn-ghost" id="loc-modal-close">&times;</button>
          </div>

          <div class="modal-body">
            <form id="loc-form" autocomplete="off">
              ${isEdit ? `<input type="hidden" name="id" value="${esc(data.id)}">` : ''}

              <!-- Informations principales -->
              <div class="form-row">
                <div class="form-group">
                  <label for="loc-name">Nom du lieu *</label>
                  <input type="text" id="loc-name" name="name" class="form-control"
                         value="${esc(data.name)}" required placeholder="Ex : Stand municipal Villepinte">
                </div>
                <div class="form-group">
                  <label for="loc-city">Ville</label>
                  <input type="text" id="loc-city" name="city" class="form-control"
                         value="${esc(data.city)}" placeholder="Ex : Villepinte">
                </div>
              </div>

              <div class="form-group">
                <label for="loc-address">Adresse complète</label>
                <input type="text" id="loc-address" name="address" class="form-control"
                       value="${esc(data.address)}" placeholder="Rue, code postal…">
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="loc-type">Type de lieu</label>
                  <input type="text" id="loc-type" name="type" class="form-control"
                         list="loc-type-list" value="${esc(data.type)}" placeholder="Sélectionner ou saisir…">
                  <datalist id="loc-type-list">
                    ${typeOptions.map(t => `<option value="${esc(t)}">`).join('')}
                  </datalist>
                </div>
                <div class="form-group">
                  <label for="loc-capacity">Capacité (participants)</label>
                  <input type="number" id="loc-capacity" name="capacity" class="form-control"
                         value="${data.capacity != null ? data.capacity : ''}" min="0" placeholder="Ex : 12">
                </div>
                <div class="form-group">
                  <label for="loc-cost">Coût par session</label>
                  <input type="number" id="loc-cost" name="costPerSession" class="form-control"
                         value="${data.costPerSession != null ? data.costPerSession : ''}" min="0" step="any"
                         placeholder="0 si propriétaire">
                  <span class="form-help">0 si lieu détenu en propre</span>
                </div>
              </div>

              <!-- Équipement disponible -->
              <div class="form-group">
                <label for="loc-equipment">Équipements disponibles sur place</label>
                <textarea id="loc-equipment" name="equipmentAvailable" class="form-control"
                          placeholder="Cibles, système de ventilation, éclairage modulable…">${esc(data.equipmentAvailable)}</textarea>
              </div>

              <!-- Contact sur place -->
              <div class="form-row">
                <div class="form-group">
                  <label for="loc-contact-name">Nom du contact</label>
                  <input type="text" id="loc-contact-name" name="contactName" class="form-control"
                         value="${esc(data.contactName)}" placeholder="Responsable du site">
                </div>
                <div class="form-group">
                  <label for="loc-contact-phone">Téléphone du contact</label>
                  <input type="tel" id="loc-contact-phone" name="contactPhone" class="form-control"
                         value="${esc(data.contactPhone)}" placeholder="06 XX XX XX XX">
                </div>
              </div>

              <!-- Options -->
              <div class="form-row">
                <div class="form-group">
                  <label>&nbsp;</label>
                  <label class="form-check">
                    <input type="checkbox" name="active" id="loc-active" ${data.active !== false ? 'checked' : ''}>
                    <span>Lieu actif</span>
                  </label>
                </div>
                <div class="form-group">
                  <label>&nbsp;</label>
                  <label class="form-check">
                    <input type="checkbox" name="shared" id="loc-shared" ${data.shared ? 'checked' : ''}>
                    <span>Mutualisable entre clients</span>
                  </label>
                </div>
              </div>

              <!-- Notes -->
              <div class="form-group">
                <label for="loc-notes">Notes internes</label>
                <textarea id="loc-notes" name="notes" class="form-control"
                          placeholder="Informations complémentaires…">${esc(data.notes)}</textarea>
              </div>

              <!-- Modules compatibles -->
              <div class="form-group">
                <label>Modules compatibles</label>
                <div id="loc-modules-list" style="max-height:200px;overflow-y:auto;padding:8px;background:var(--bg-input);border:1px solid var(--border-color);border-radius:6px;">
                  ${modulesCheckboxes}
                </div>
              </div>

            </form>
          </div>

          <div class="modal-footer">
            <button class="btn" id="loc-modal-cancel">Annuler</button>
            <button class="btn btn-primary" id="loc-modal-save">${isEdit ? 'Enregistrer' : 'Créer'}</button>
          </div>

        </div>
      </div>`;
    }

    /* ----------------------------------------------------------
       Collecte des données du formulaire
       ---------------------------------------------------------- */
    function collectFormData() {
      const form = document.getElementById('loc-form');
      if (!form) return null;

      /* Récupération des modules cochés */
      const moduleCheckboxes = form.querySelectorAll('input[name="compatibleModuleIds"]:checked');
      const compatibleModuleIds = Array.from(moduleCheckboxes).map(cb => cb.value);

      return {
        name:                form.querySelector('[name="name"]').value.trim(),
        address:             form.querySelector('[name="address"]').value.trim(),
        city:                form.querySelector('[name="city"]').value.trim(),
        type:                form.querySelector('[name="type"]').value.trim(),
        capacity:            form.querySelector('[name="capacity"]').value !== ''
                               ? parseInt(form.querySelector('[name="capacity"]').value, 10)
                               : null,
        costPerSession:      form.querySelector('[name="costPerSession"]').value !== ''
                               ? parseFloat(form.querySelector('[name="costPerSession"]').value)
                               : 0,
        equipmentAvailable:  form.querySelector('[name="equipmentAvailable"]').value.trim(),
        contactName:         form.querySelector('[name="contactName"]').value.trim(),
        contactPhone:        form.querySelector('[name="contactPhone"]').value.trim(),
        active:              form.querySelector('[name="active"]').checked,
        shared:              form.querySelector('[name="shared"]').checked,
        notes:               form.querySelector('[name="notes"]').value.trim(),
        compatibleModuleIds: compatibleModuleIds
      };
    }

    /* ----------------------------------------------------------
       Ouverture / fermeture du modal
       ---------------------------------------------------------- */
    function openModal(loc) {
      /* Supprime un éventuel modal existant */
      closeModal();

      const html = buildModalHTML(loc || null);
      document.body.insertAdjacentHTML('beforeend', html);

      /* Écouteurs du modal */
      const overlay   = document.getElementById('loc-modal-overlay');
      const btnClose  = document.getElementById('loc-modal-close');
      const btnCancel = document.getElementById('loc-modal-cancel');
      const btnSave   = document.getElementById('loc-modal-save');

      btnClose.addEventListener('click', closeModal);
      btnCancel.addEventListener('click', closeModal);

      /* Fermeture en cliquant sur le fond */
      overlay.addEventListener('click', function (e) {
        if (e.target === overlay) closeModal();
      });

      /* Sauvegarde */
      btnSave.addEventListener('click', function () {
        const data = collectFormData();
        if (!data) return;

        /* Validation minimale */
        if (!data.name) {
          document.getElementById('loc-name').focus();
          return;
        }

        const hiddenId = document.querySelector('#loc-form input[name="id"]');
        if (hiddenId) {
          /* Mode édition */
          DB.locations.update(hiddenId.value, data);
        } else {
          /* Mode création */
          DB.locations.create(data);
        }

        closeModal();
        refresh();
      });
    }

    function closeModal() {
      const existing = document.getElementById('loc-modal-overlay');
      if (existing) existing.remove();
    }

    /* ----------------------------------------------------------
       Suppression d'un lieu (avec confirmation)
       ---------------------------------------------------------- */
    function confirmDelete(id) {
      const loc = DB.locations.getById(id);
      if (!loc) return;

      /* Demande de confirmation simple */
      const ok = window.confirm(
        'Supprimer le lieu « ' + (loc.name || id) + ' » ?\nCette action est irréversible.'
      );
      if (!ok) return;

      DB.locations.delete(id);
      refresh();
    }

    /* ----------------------------------------------------------
       Rafraîchissement de la liste
       ---------------------------------------------------------- */
    function refresh() {
      const locations = getFilteredLocations();
      const tableZone = document.getElementById('loc-table-zone');
      if (tableZone) {
        tableZone.innerHTML = buildTableHTML(locations);
        attachTableListeners();
      }
    }

    /* ----------------------------------------------------------
       Branchement des écouteurs sur le tableau
       ---------------------------------------------------------- */
    function attachTableListeners() {
      /* Boutons Modifier */
      document.querySelectorAll('.loc-btn-edit').forEach(function (btn) {
        btn.addEventListener('click', function () {
          const loc = DB.locations.getById(this.dataset.id);
          if (loc) openModal(loc);
        });
      });

      /* Boutons Supprimer */
      document.querySelectorAll('.loc-btn-delete').forEach(function (btn) {
        btn.addEventListener('click', function () {
          confirmDelete(this.dataset.id);
        });
      });

      /* Bouton ajout depuis l'état vide */
      const emptyBtn = document.getElementById('loc-empty-add');
      if (emptyBtn) {
        emptyBtn.addEventListener('click', function () { openModal(null); });
      }
    }

    /* ----------------------------------------------------------
       Rendu initial de la page
       ---------------------------------------------------------- */
    const locations = getFilteredLocations();

    container.innerHTML = `
      <div class="page-header">
        <h1>Lieux d'entraînement</h1>
        <div class="actions">
          <div class="search-bar">
            <span class="search-icon">&#128269;</span>
            <input type="text" id="loc-search" placeholder="Rechercher un lieu…" value="${esc(searchTerm)}">
          </div>
          <button class="btn btn-primary" id="loc-btn-add">+ Nouveau lieu</button>
        </div>
      </div>

      <div class="card">
        <div id="loc-table-zone">
          ${buildTableHTML(locations)}
        </div>
      </div>`;

    /* ----------------------------------------------------------
       Écouteurs globaux de la page
       ---------------------------------------------------------- */

    /* Bouton Ajouter */
    document.getElementById('loc-btn-add').addEventListener('click', function () {
      openModal(null);
    });

    /* Barre de recherche (filtrage temps réel) */
    document.getElementById('loc-search').addEventListener('input', function () {
      searchTerm = this.value.trim();
      refresh();
    });

    /* Écouteurs du tableau (première passe) */
    attachTableListeners();
  }
};
/* ============================================================
   DST-SYSTEM — Vue Paramètres
   Gestion complète des paramètres économiques, RH, types
   extensibles, et import/export des données.
   ============================================================ */

window.Views = window.Views || {};

Views.Settings = {

  render(container) {
    'use strict';

    const settings = DB.settings.get();

    /* ----------------------------------------------------------
       État local mutable — copie de travail des paramètres
       ---------------------------------------------------------- */
    const state = {
      fixedCosts:      JSON.parse(JSON.stringify(settings.fixedCosts || [])),
      equipmentAmortization: JSON.parse(JSON.stringify(settings.equipmentAmortization || [])),
      defaultSessionVariableCosts: JSON.parse(JSON.stringify(settings.defaultSessionVariableCosts || [])),
      clientTypes:     [...(settings.clientTypes || [])],
      operatorStatuses: [...(settings.operatorStatuses || [])],
      offerTypes:      [...(settings.offerTypes || [])],
      employerChargeRate:       settings.employerChargeRate ?? 45,
      interimCoefficient:       settings.interimCoefficient ?? 2.0,
      freelanceChargeRate:      settings.freelanceChargeRate ?? 25,
      operatorOverloadThreshold: settings.operatorOverloadThreshold ?? 15,
      cdiThreshold:             settings.cdiThreshold ?? 80,
      targetMarginPercent:      settings.targetMarginPercent ?? 30,
      marginAlertThreshold:     settings.marginAlertThreshold ?? 15,
      vatRate:                  settings.vatRate ?? 20,
      estimatedAnnualSessions:  settings.estimatedAnnualSessions ?? 100
    };

    /* ----------------------------------------------------------
       Fonctions utilitaires de calcul
       ---------------------------------------------------------- */

    /** Total des coûts fixes annuels */
    function totalFixed() {
      return state.fixedCosts.reduce((s, c) => s + (parseFloat(c.amount) || 0), 0);
    }

    /** Total amortissement annuel */
    function totalAmortization() {
      return state.equipmentAmortization.reduce((s, a) => {
        const years = Math.max(parseFloat(a.durationYears) || 1, 1);
        return s + ((parseFloat(a.amount) || 0) / years);
      }, 0);
    }

    /** Quote-part coûts fixes par session */
    function fixedPerSession() {
      const est = Math.max(state.estimatedAnnualSessions, 1);
      return (totalFixed() + totalAmortization()) / est;
    }

    /* ----------------------------------------------------------
       Génération du HTML
       ---------------------------------------------------------- */

    /** Carte récapitulative KPI en haut de page */
    function renderSummary() {
      const tf = totalFixed();
      const ta = totalAmortization();
      const fps = fixedPerSession();
      return `
        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-label">Coûts fixes / an</div>
            <div class="kpi-value text-mono">${Engine.fmt(tf)}</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Amortissements / an</div>
            <div class="kpi-value text-mono">${Engine.fmt(ta)}</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Charge fixe / session</div>
            <div class="kpi-value text-mono">${Engine.fmt(Engine.round2(fps))}</div>
            <div class="kpi-detail">Sur base de ${state.estimatedAnnualSessions} sessions/an</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Marge cible</div>
            <div class="kpi-value">${state.targetMarginPercent} %</div>
          </div>
        </div>`;
    }

    /** Section 1 — Coûts fixes annuels */
    function renderFixedCosts() {
      const rows = state.fixedCosts.map((c, i) => `
        <div class="form-inline mb-8" data-section="fixed" data-index="${i}">
          <div class="form-group" style="flex:2;margin-bottom:0">
            <input type="text" class="form-control fc-label" value="${escapeAttr(c.label)}" placeholder="Libellé">
          </div>
          <div class="form-group" style="flex:1;margin-bottom:0">
            <input type="number" class="form-control fc-amount text-mono" value="${c.amount || 0}" min="0" step="any" placeholder="Montant">
          </div>
          <button class="btn btn-sm btn-ghost fc-remove" title="Supprimer">&times;</button>
        </div>`).join('');

      return `
        <div class="card" id="section-fixed">
          <div class="card-header">
            <h2>Coûts fixes annuels</h2>
            <button class="btn btn-sm" id="btn-add-fixed">+ Ajouter</button>
          </div>
          ${rows}
          <div class="flex-between mt-16" style="border-top:1px solid var(--border-color);padding-top:12px">
            <span class="text-muted">Total coûts fixes</span>
            <span class="font-bold text-mono" id="total-fixed">${Engine.fmt(totalFixed())}</span>
          </div>
        </div>`;
    }

    /** Section 2 — Amortissements matériels */
    function renderAmortization() {
      const rows = state.equipmentAmortization.map((a, i) => {
        const years = Math.max(parseFloat(a.durationYears) || 1, 1);
        const annual = (parseFloat(a.amount) || 0) / years;
        return `
        <div class="form-inline mb-8" data-section="amort" data-index="${i}">
          <div class="form-group" style="flex:2;margin-bottom:0">
            <input type="text" class="form-control am-label" value="${escapeAttr(a.label)}" placeholder="Libellé">
          </div>
          <div class="form-group" style="flex:1;margin-bottom:0">
            <input type="number" class="form-control am-amount text-mono" value="${a.amount || 0}" min="0" step="any" placeholder="Montant achat">
          </div>
          <div class="form-group" style="flex:0.5;margin-bottom:0">
            <input type="number" class="form-control am-duration" value="${a.durationYears || 1}" min="1" step="any" placeholder="Années">
          </div>
          <span class="text-mono text-muted" style="min-width:90px;text-align:right" title="Amortissement annuel">${Engine.fmt(Engine.round2(annual))}/an</span>
          <button class="btn btn-sm btn-ghost am-remove" title="Supprimer">&times;</button>
        </div>`;
      }).join('');

      return `
        <div class="card" id="section-amort">
          <div class="card-header">
            <h2>Amortissements matériels</h2>
            <button class="btn btn-sm" id="btn-add-amort">+ Ajouter</button>
          </div>
          <div class="form-inline mb-8 text-muted" style="font-size:0.75rem">
            <span style="flex:2">Libellé</span>
            <span style="flex:1">Montant achat</span>
            <span style="flex:0.5">Durée (ans)</span>
            <span style="min-width:90px;text-align:right">Amort./an</span>
            <span style="width:36px"></span>
          </div>
          ${rows}
          <div class="flex-between mt-16" style="border-top:1px solid var(--border-color);padding-top:12px">
            <span class="text-muted">Total amortissement annuel</span>
            <span class="font-bold text-mono" id="total-amort">${Engine.fmt(Engine.round2(totalAmortization()))}</span>
          </div>
        </div>`;
    }

    /** Section 3 — Coûts variables par défaut (par session) */
    function renderVariableCosts() {
      const rows = state.defaultSessionVariableCosts.map((v, i) => `
        <div class="form-inline mb-8" data-section="var" data-index="${i}">
          <div class="form-group" style="flex:2;margin-bottom:0">
            <input type="text" class="form-control vc-label" value="${escapeAttr(v.label)}" placeholder="Libellé">
          </div>
          <div class="form-group" style="flex:1;margin-bottom:0">
            <input type="number" class="form-control vc-amount text-mono" value="${v.amount || 0}" min="0" step="any" placeholder="Montant par défaut">
          </div>
          <button class="btn btn-sm btn-ghost vc-remove" title="Supprimer">&times;</button>
        </div>`).join('');

      return `
        <div class="card" id="section-variable">
          <div class="card-header">
            <h2>Coûts variables par défaut (par session)</h2>
            <button class="btn btn-sm" id="btn-add-var">+ Ajouter</button>
          </div>
          <p class="form-help mb-16">Ces coûts seront pré-remplis lors de la création d'une nouvelle session.</p>
          ${rows}
        </div>`;
    }

    /** Section 4 — Paramètres RH */
    function renderHR() {
      return `
        <div class="card" id="section-rh">
          <div class="card-header">
            <h2>Paramètres RH</h2>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="rh-employer-charge">Charges patronales (%)</label>
              <input type="number" id="rh-employer-charge" class="form-control" value="${state.employerChargeRate}" min="0" max="100" step="any">
              <span class="form-help">Taux appliqué sur le brut pour les salariés</span>
            </div>
            <div class="form-group">
              <label for="rh-interim-coeff">Coefficient intérim</label>
              <input type="number" id="rh-interim-coeff" class="form-control" value="${state.interimCoefficient}" min="0" step="any">
              <span class="form-help">Multiplicateur appliqué au coût de base intérim</span>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="rh-freelance-charge">Charges freelance estimées (%)</label>
              <input type="number" id="rh-freelance-charge" class="form-control" value="${state.freelanceChargeRate}" min="0" max="100" step="any">
              <span class="form-help">Estimation des charges sociales freelance</span>
            </div>
            <div class="form-group">
              <label for="rh-overload">Seuil surcharge (sessions/mois)</label>
              <input type="number" id="rh-overload" class="form-control" value="${state.operatorOverloadThreshold}" min="0" step="any">
              <span class="form-help">Alerte si un opérateur dépasse ce seuil mensuel</span>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="rh-cdi-threshold">Seuil bascule CDI (sessions/an)</label>
              <input type="number" id="rh-cdi-threshold" class="form-control" value="${state.cdiThreshold}" min="0" step="any">
              <span class="form-help">Suggestion de CDI si un opérateur atteint ce nombre annuel</span>
            </div>
          </div>
        </div>`;
    }

    /** Section 5 — Paramètres économiques */
    function renderEconomic() {
      return `
        <div class="card" id="section-eco">
          <div class="card-header">
            <h2>Paramètres économiques</h2>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="eco-target-margin">Marge cible (%)</label>
              <input type="number" id="eco-target-margin" class="form-control" value="${state.targetMarginPercent}" min="0" max="100" step="any">
              <span class="form-help">Objectif de marge sur chaque session</span>
            </div>
            <div class="form-group">
              <label for="eco-margin-alert">Seuil alerte marge (%)</label>
              <input type="number" id="eco-margin-alert" class="form-control" value="${state.marginAlertThreshold}" min="0" max="100" step="any">
              <span class="form-help">Alerte si la marge tombe sous ce seuil</span>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="eco-vat">Taux TVA (%)</label>
              <input type="number" id="eco-vat" class="form-control" value="${state.vatRate}" min="0" max="100" step="any">
            </div>
            <div class="form-group">
              <label for="eco-est-sessions">Sessions estimées / an</label>
              <input type="number" id="eco-est-sessions" class="form-control" value="${state.estimatedAnnualSessions}" min="0" step="any">
              <span class="form-help">Base de répartition des coûts fixes par session</span>
            </div>
          </div>
        </div>`;
    }

    /** Section 6 — Types extensibles */
    function renderTypes() {
      /* Types clients — éditable */
      const clientTags = state.clientTypes.map((t, i) => `
        <span class="tag tag-blue" style="gap:6px">
          ${escapeHTML(t)}
          <span class="ct-remove" data-index="${i}" style="cursor:pointer;opacity:0.7" title="Supprimer">&times;</span>
        </span>`).join('');

      /* Statuts opérateurs — lecture seule */
      const opTags = state.operatorStatuses.map(s =>
        `<span class="tag tag-neutral">${Engine.statusLabel ? Engine.statusLabel(s) : escapeHTML(s)}</span>`
      ).join('');

      /* Types d'offres — lecture seule */
      const offerTags = state.offerTypes.map(t =>
        `<span class="tag tag-neutral">${Engine.offerTypeLabel ? Engine.offerTypeLabel(t) : escapeHTML(t)}</span>`
      ).join('');

      return `
        <div class="card" id="section-types">
          <div class="card-header">
            <h2>Types extensibles</h2>
          </div>

          <div class="form-group">
            <label>Types de clients</label>
            <div class="flex gap-8 mb-8" style="flex-wrap:wrap" id="client-types-list">
              ${clientTags}
            </div>
            <div class="form-inline">
              <input type="text" id="input-new-client-type" class="form-control" placeholder="Nouveau type client" style="max-width:260px">
              <button class="btn btn-sm" id="btn-add-client-type">+ Ajouter</button>
            </div>
          </div>

          <div class="form-group mt-16">
            <label>Statuts opérateurs <span class="text-muted" style="text-transform:none;font-weight:400">(définis par le système)</span></label>
            <div class="flex gap-8" style="flex-wrap:wrap">
              ${opTags}
            </div>
          </div>

          <div class="form-group mt-16">
            <label>Types d'offres <span class="text-muted" style="text-transform:none;font-weight:400">(définis par le système)</span></label>
            <div class="flex gap-8" style="flex-wrap:wrap">
              ${offerTags}
            </div>
          </div>
        </div>`;
    }

    /** Section 7 — Données (export / import / reset) */
    function renderData() {
      return `
        <div class="card" id="section-data">
          <div class="card-header">
            <h2>Données</h2>
          </div>
          <div class="alert alert-info mb-16">
            <span class="alert-icon">&#9432;</span>
            <span>L'export génère un fichier JSON contenant toutes les données de l'application (paramètres, clients, opérateurs, sessions, etc.).</span>
          </div>
          <div class="flex gap-12" style="flex-wrap:wrap">
            <button class="btn" id="btn-export">Exporter toutes les données (JSON)</button>
            <label class="btn" style="cursor:pointer">
              Importer des données (JSON)
              <input type="file" id="input-import" accept=".json,application/json" style="display:none">
            </label>
            <button class="btn btn-warning" id="btn-reset">Réinitialiser toutes les données</button>
          </div>
          <div id="data-feedback" class="mt-16"></div>
        </div>`;
    }

    /* ----------------------------------------------------------
       Assemblage de la page
       ---------------------------------------------------------- */
    container.innerHTML = `
      <div class="page-header">
        <h1>Paramètres</h1>
        <div class="actions">
          <button class="btn btn-primary" id="btn-save-settings">Enregistrer les paramètres</button>
        </div>
      </div>

      ${renderSummary()}

      <div class="alert alert-warning mb-16">
        <span class="alert-icon">&#9888;</span>
        <span>Les modifications ne sont prises en compte qu'après avoir cliqué sur <strong>Enregistrer</strong>.</span>
      </div>

      <div class="grid-2">
        <div>
          ${renderFixedCosts()}
          ${renderAmortization()}
          ${renderVariableCosts()}
        </div>
        <div>
          ${renderHR()}
          ${renderEconomic()}
          ${renderTypes()}
        </div>
      </div>

      ${renderData()}

      <!-- Modale de confirmation de réinitialisation -->
      <div id="modal-reset-overlay" class="modal-overlay hidden">
        <div class="modal" style="max-width:480px">
          <div class="modal-header">
            <h2>Confirmer la réinitialisation</h2>
            <button class="btn btn-sm btn-ghost" id="modal-reset-close">&times;</button>
          </div>
          <div class="modal-body">
            <p style="margin-bottom:12px">Cette action va <strong>supprimer définitivement toutes les données</strong> de l'application :</p>
            <ul style="margin-left:18px;margin-bottom:16px;color:var(--text-secondary)">
              <li>Clients, opérateurs, sessions, offres, modules, lieux</li>
              <li>Tous les paramètres seront restaurés aux valeurs par défaut</li>
            </ul>
            <div class="form-group">
              <label for="reset-confirm-input">Tapez <strong style="color:var(--accent-red-light)">SUPPRIMER</strong> pour confirmer</label>
              <input type="text" id="reset-confirm-input" class="form-control" placeholder="SUPPRIMER" autocomplete="off">
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn" id="modal-reset-cancel">Annuler</button>
            <button class="btn btn-warning" id="modal-reset-confirm" disabled>Réinitialiser</button>
          </div>
        </div>
      </div>
    `;

    /* ----------------------------------------------------------
       Raccourcis vers les éléments du DOM
       ---------------------------------------------------------- */
    const $  = (sel) => container.querySelector(sel);
    const $$ = (sel) => container.querySelectorAll(sel);

    /* ----------------------------------------------------------
       Fonctions de mise à jour partielle (sans re-render complet)
       ---------------------------------------------------------- */

    /** Met à jour les totaux affichés et les KPI du résumé */
    function refreshTotals() {
      const elFixed = $('#total-fixed');
      const elAmort = $('#total-amort');
      if (elFixed) elFixed.textContent = Engine.fmt(totalFixed());
      if (elAmort) elAmort.textContent = Engine.fmt(Engine.round2(totalAmortization()));

      /* KPI résumé */
      const kpis = $$('.kpi-card .kpi-value');
      if (kpis.length >= 4) {
        kpis[0].textContent = Engine.fmt(totalFixed());
        kpis[1].textContent = Engine.fmt(Engine.round2(totalAmortization()));
        kpis[2].textContent = Engine.fmt(Engine.round2(fixedPerSession()));
        kpis[3].textContent = state.targetMarginPercent + ' %';
      }
      /* Détail sous la charge fixe/session */
      const detail = container.querySelector('.kpi-card:nth-child(3) .kpi-detail');
      if (detail) detail.textContent = 'Sur base de ' + state.estimatedAnnualSessions + ' sessions/an';
    }

    /** Recharge une section de liste éditable et réattache les listeners */
    function reRenderSection(sectionId, renderFn) {
      const wrapper = $('#section-' + sectionId);
      if (!wrapper) return;
      const tmp = document.createElement('div');
      tmp.innerHTML = renderFn();
      const newCard = tmp.firstElementChild;
      wrapper.replaceWith(newCard);
      attachListEditListeners();
      refreshTotals();
    }

    /* ----------------------------------------------------------
       Collecte des valeurs depuis le DOM → state
       ---------------------------------------------------------- */

    function syncFixedCostsFromDOM() {
      const rows = $$('[data-section="fixed"]');
      state.fixedCosts = Array.from(rows).map(row => ({
        label:  row.querySelector('.fc-label').value.trim(),
        amount: parseFloat(row.querySelector('.fc-amount').value) || 0
      }));
    }

    function syncAmortFromDOM() {
      const rows = $$('[data-section="amort"]');
      state.equipmentAmortization = Array.from(rows).map(row => ({
        label:         row.querySelector('.am-label').value.trim(),
        amount:        parseFloat(row.querySelector('.am-amount').value) || 0,
        durationYears: parseInt(row.querySelector('.am-duration').value, 10) || 1
      }));
    }

    function syncVariableCostsFromDOM() {
      const rows = $$('[data-section="var"]');
      state.defaultSessionVariableCosts = Array.from(rows).map(row => ({
        label:  row.querySelector('.vc-label').value.trim(),
        amount: parseFloat(row.querySelector('.vc-amount').value) || 0
      }));
    }

    function syncScalarsFromDOM() {
      state.employerChargeRate       = parseFloat($('#rh-employer-charge').value) || 0;
      state.interimCoefficient       = parseFloat($('#rh-interim-coeff').value) || 1;
      state.freelanceChargeRate      = parseFloat($('#rh-freelance-charge').value) || 0;
      state.operatorOverloadThreshold = parseInt($('#rh-overload').value, 10) || 1;
      state.cdiThreshold             = parseInt($('#rh-cdi-threshold').value, 10) || 1;
      state.targetMarginPercent      = parseFloat($('#eco-target-margin').value) || 0;
      state.marginAlertThreshold     = parseFloat($('#eco-margin-alert').value) || 0;
      state.vatRate                  = parseFloat($('#eco-vat').value) || 0;
      state.estimatedAnnualSessions  = parseInt($('#eco-est-sessions').value, 10) || 1;
    }

    /** Synchronise l'intégralité du state depuis les valeurs DOM */
    function syncAllFromDOM() {
      syncFixedCostsFromDOM();
      syncAmortFromDOM();
      syncVariableCostsFromDOM();
      syncScalarsFromDOM();
    }

    /* ----------------------------------------------------------
       Listeners — Listes éditables (ajout, suppression, édition)
       ---------------------------------------------------------- */

    function attachListEditListeners() {

      /* --- Coûts fixes : modification en temps réel --- */
      $$('[data-section="fixed"] .fc-label, [data-section="fixed"] .fc-amount').forEach(input => {
        input.addEventListener('input', () => {
          syncFixedCostsFromDOM();
          refreshTotals();
        });
      });

      /* --- Coûts fixes : suppression d'une ligne --- */
      $$('.fc-remove').forEach(btn => {
        btn.addEventListener('click', () => {
          syncFixedCostsFromDOM();
          const idx = parseInt(btn.closest('[data-section="fixed"]').dataset.index, 10);
          state.fixedCosts.splice(idx, 1);
          reRenderSection('fixed', renderFixedCosts);
        });
      });

      /* --- Amortissements : modification en temps réel --- */
      $$('[data-section="amort"] .am-label, [data-section="amort"] .am-amount, [data-section="amort"] .am-duration').forEach(input => {
        input.addEventListener('input', () => {
          syncAmortFromDOM();
          reRenderSection('amort', renderAmortization);
        });
      });

      /* --- Amortissements : suppression d'une ligne --- */
      $$('.am-remove').forEach(btn => {
        btn.addEventListener('click', () => {
          syncAmortFromDOM();
          const idx = parseInt(btn.closest('[data-section="amort"]').dataset.index, 10);
          state.equipmentAmortization.splice(idx, 1);
          reRenderSection('amort', renderAmortization);
        });
      });

      /* --- Coûts variables : modification en temps réel --- */
      $$('[data-section="var"] .vc-label, [data-section="var"] .vc-amount').forEach(input => {
        input.addEventListener('input', () => {
          syncVariableCostsFromDOM();
        });
      });

      /* --- Coûts variables : suppression d'une ligne --- */
      $$('.vc-remove').forEach(btn => {
        btn.addEventListener('click', () => {
          syncVariableCostsFromDOM();
          const idx = parseInt(btn.closest('[data-section="var"]').dataset.index, 10);
          state.defaultSessionVariableCosts.splice(idx, 1);
          reRenderSection('variable', renderVariableCosts);
        });
      });

      /* --- Types clients : suppression --- */
      $$('.ct-remove').forEach(span => {
        span.addEventListener('click', () => {
          const idx = parseInt(span.dataset.index, 10);
          state.clientTypes.splice(idx, 1);
          reRenderSection('types', renderTypes);
        });
      });
    }

    /* ----------------------------------------------------------
       Listeners — Boutons d'ajout de lignes
       ---------------------------------------------------------- */

    function attachAddButtons() {

      /* Ajout coût fixe */
      const btnAddFixed = $('#btn-add-fixed');
      if (btnAddFixed) {
        btnAddFixed.addEventListener('click', () => {
          syncFixedCostsFromDOM();
          state.fixedCosts.push({ label: '', amount: 0 });
          reRenderSection('fixed', renderFixedCosts);
          attachAddButtons();
          /* Focus sur le dernier champ ajouté */
          const inputs = $$('[data-section="fixed"] .fc-label');
          if (inputs.length) inputs[inputs.length - 1].focus();
        });
      }

      /* Ajout amortissement */
      const btnAddAmort = $('#btn-add-amort');
      if (btnAddAmort) {
        btnAddAmort.addEventListener('click', () => {
          syncAmortFromDOM();
          state.equipmentAmortization.push({ label: '', amount: 0, durationYears: 3 });
          reRenderSection('amort', renderAmortization);
          attachAddButtons();
          const inputs = $$('[data-section="amort"] .am-label');
          if (inputs.length) inputs[inputs.length - 1].focus();
        });
      }

      /* Ajout coût variable */
      const btnAddVar = $('#btn-add-var');
      if (btnAddVar) {
        btnAddVar.addEventListener('click', () => {
          syncVariableCostsFromDOM();
          state.defaultSessionVariableCosts.push({ label: '', amount: 0 });
          reRenderSection('variable', renderVariableCosts);
          attachAddButtons();
          const inputs = $$('[data-section="var"] .vc-label');
          if (inputs.length) inputs[inputs.length - 1].focus();
        });
      }

      /* Ajout type client */
      const btnAddCT = $('#btn-add-client-type');
      if (btnAddCT) {
        btnAddCT.addEventListener('click', addClientType);
      }
      const inputCT = $('#input-new-client-type');
      if (inputCT) {
        inputCT.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') { e.preventDefault(); addClientType(); }
        });
      }
    }

    function addClientType() {
      const input = $('#input-new-client-type');
      if (!input) return;
      const val = input.value.trim();
      if (!val) return;
      if (state.clientTypes.includes(val)) {
        input.value = '';
        return;
      }
      state.clientTypes.push(val);
      input.value = '';
      reRenderSection('types', renderTypes);
      attachAddButtons();
    }

    /* ----------------------------------------------------------
       Listeners — Paramètres scalaires (RH + éco) : rafraîchir KPI
       ---------------------------------------------------------- */

    function attachScalarListeners() {
      const scalarIds = [
        'rh-employer-charge', 'rh-interim-coeff', 'rh-freelance-charge',
        'rh-overload', 'rh-cdi-threshold',
        'eco-target-margin', 'eco-margin-alert', 'eco-vat', 'eco-est-sessions'
      ];
      scalarIds.forEach(id => {
        const el = $('#' + id);
        if (el) {
          el.addEventListener('input', () => {
            syncScalarsFromDOM();
            refreshTotals();
          });
        }
      });
    }

    /* ----------------------------------------------------------
       Listeners — Sauvegarde
       ---------------------------------------------------------- */

    function attachSaveButton() {
      const btnSave = $('#btn-save-settings');
      if (!btnSave) return;

      btnSave.addEventListener('click', () => {
        /* Synchroniser toutes les valeurs depuis le DOM */
        syncAllFromDOM();

        /* Construire l'objet de mise à jour */
        const update = {
          fixedCosts:                  state.fixedCosts,
          equipmentAmortization:       state.equipmentAmortization,
          defaultSessionVariableCosts: state.defaultSessionVariableCosts,
          clientTypes:                 state.clientTypes,
          employerChargeRate:          state.employerChargeRate,
          interimCoefficient:          state.interimCoefficient,
          freelanceChargeRate:         state.freelanceChargeRate,
          operatorOverloadThreshold:   state.operatorOverloadThreshold,
          cdiThreshold:                state.cdiThreshold,
          targetMarginPercent:         state.targetMarginPercent,
          marginAlertThreshold:        state.marginAlertThreshold,
          vatRate:                     state.vatRate,
          estimatedAnnualSessions:     state.estimatedAnnualSessions
        };

        DB.settings.update(update);

        /* Confirmation visuelle */
        showFeedback('Paramètres enregistrés avec succès.', 'success');
      });
    }

    /* ----------------------------------------------------------
       Listeners — Export / Import / Reset
       ---------------------------------------------------------- */

    function attachDataActions() {

      /* --- Export JSON --- */
      const btnExport = $('#btn-export');
      if (btnExport) {
        btnExport.addEventListener('click', () => {
          try {
            const data = DB.exportAll();
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url  = URL.createObjectURL(blob);
            const a    = document.createElement('a');
            a.href = url;
            a.download = 'dst-system-export-' + new Date().toISOString().slice(0, 10) + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showFeedback('Export terminé.', 'success');
          } catch (err) {
            showFeedback('Erreur lors de l\'export : ' + err.message, 'error');
          }
        });
      }

      /* --- Import JSON --- */
      const inputImport = $('#input-import');
      if (inputImport) {
        inputImport.addEventListener('change', (e) => {
          const file = e.target.files && e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (evt) => {
            try {
              const data = JSON.parse(evt.target.result);
              DB.importAll(data);
              showFeedback('Import réussi. Rechargement des paramètres...', 'success');
              /* Recharger la vue avec les nouvelles données */
              setTimeout(() => Views.Settings.render(container), 600);
            } catch (err) {
              showFeedback('Erreur lors de l\'import : ' + err.message, 'error');
            }
          };
          reader.onerror = () => {
            showFeedback('Impossible de lire le fichier.', 'error');
          };
          reader.readAsText(file);

          /* Réinitialiser l'input pour permettre un nouveau choix du même fichier */
          inputImport.value = '';
        });
      }

      /* --- Réinitialisation — ouvrir la modale --- */
      const btnReset = $('#btn-reset');
      if (btnReset) {
        btnReset.addEventListener('click', () => {
          const overlay = $('#modal-reset-overlay');
          if (overlay) overlay.classList.remove('hidden');
          const confirmInput = $('#reset-confirm-input');
          if (confirmInput) { confirmInput.value = ''; confirmInput.focus(); }
          const btnConfirm = $('#modal-reset-confirm');
          if (btnConfirm) btnConfirm.disabled = true;
        });
      }

      /* --- Modale : vérification du mot de confirmation --- */
      const confirmInput = $('#reset-confirm-input');
      const btnConfirm   = $('#modal-reset-confirm');
      if (confirmInput && btnConfirm) {
        confirmInput.addEventListener('input', () => {
          btnConfirm.disabled = confirmInput.value.trim() !== 'SUPPRIMER';
        });
      }

      /* --- Modale : confirmer la réinitialisation --- */
      if (btnConfirm) {
        btnConfirm.addEventListener('click', () => {
          try {
            DB.clearAll();
            showFeedback('Toutes les données ont été réinitialisées.', 'success');
            closeResetModal();
            /* Recharger la vue avec les paramètres par défaut */
            setTimeout(() => Views.Settings.render(container), 600);
          } catch (err) {
            showFeedback('Erreur lors de la réinitialisation : ' + err.message, 'error');
          }
        });
      }

      /* --- Modale : annuler / fermer --- */
      const btnCancel    = $('#modal-reset-cancel');
      const btnCloseModal = $('#modal-reset-close');
      [btnCancel, btnCloseModal].forEach(btn => {
        if (btn) btn.addEventListener('click', closeResetModal);
      });

      /* Fermer la modale en cliquant sur l'overlay */
      const overlay = $('#modal-reset-overlay');
      if (overlay) {
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) closeResetModal();
        });
      }
    }

    function closeResetModal() {
      const overlay = $('#modal-reset-overlay');
      if (overlay) overlay.classList.add('hidden');
    }

    /* ----------------------------------------------------------
       Feedback utilisateur (messages temporaires)
       ---------------------------------------------------------- */

    function showFeedback(message, type) {
      const zone = $('#data-feedback');
      if (!zone) return;
      const cssClass = type === 'success' ? 'alert-success' :
                       type === 'error'   ? 'alert-danger'  : 'alert-info';
      const icon = type === 'success' ? '&#10003;' :
                   type === 'error'   ? '&#10007;' : '&#9432;';
      zone.innerHTML = `
        <div class="alert ${cssClass}">
          <span class="alert-icon">${icon}</span>
          <span>${escapeHTML(message)}</span>
        </div>`;
      /* Disparition automatique après 5 secondes */
      setTimeout(() => { if (zone) zone.innerHTML = ''; }, 5000);
    }

    /* ----------------------------------------------------------
       Échappement HTML / attributs
       ---------------------------------------------------------- */

    function escapeHTML(str) {
      const div = document.createElement('div');
      div.appendChild(document.createTextNode(str));
      return div.innerHTML;
    }

    function escapeAttr(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    /* ----------------------------------------------------------
       Initialisation de tous les listeners
       ---------------------------------------------------------- */
    attachListEditListeners();
    attachAddButtons();
    attachScalarListeners();
    attachSaveButton();
    attachDataActions();
  }
};
/* ============================================================
   DST-SYSTEM — Application principale
   Routeur SPA, navigation, gestion du header et des alertes
   ============================================================ */

const App = (() => {
  'use strict';

  /* --- État interne --- */
  let currentView = 'dashboard';
  let alertsPanelOpen = false;

  /* --- Routes disponibles --- */
  const routes = {
    dashboard:  { label: 'Dashboard dirigeant', icon: '◉', view: () => Views.Dashboard },
    clients:    { label: 'Clients',              icon: '⊡', view: () => Views.Clients },
    offers:     { label: 'Offres / Abonnements', icon: '⊞', view: () => Views.Offers },
    sessions:   { label: 'Sessions',             icon: '▶', view: () => Views.Sessions },
    operators:  { label: 'Opérateurs',           icon: '⊕', view: () => Views.Operators },
    modules:    { label: 'Modules',              icon: '⬡', view: () => Views.Modules },
    locations:  { label: 'Lieux',                icon: '⊿', view: () => Views.Locations },
    settings:   { label: 'Paramètres',           icon: '⚙', view: () => Views.Settings }
  };

  /* --- Initialisation --- */
  function init() {
    renderSidebar();
    renderHeader();

    // Écouter le hash pour navigation
    window.addEventListener('hashchange', onHashChange);

    // Navigation initiale
    const hash = window.location.hash.replace('#', '');
    if (hash && routes[hash]) {
      navigate(hash);
    } else {
      navigate('dashboard');
    }
  }

  /* --- Navigation --- */
  function navigate(viewName) {
    if (!routes[viewName]) return;
    currentView = viewName;
    window.location.hash = viewName;

    // Mettre à jour la sidebar
    document.querySelectorAll('.nav-item').forEach(item => {
      item.classList.toggle('active', item.dataset.view === viewName);
    });

    // Mettre à jour le titre du header
    const headerTitle = document.getElementById('header-title');
    if (headerTitle) {
      headerTitle.textContent = routes[viewName].label;
    }

    // Rafraîchir les alertes dans le header
    updateAlertsBadge();

    // Rendre la vue
    const content = document.getElementById('content');
    if (content) {
      content.innerHTML = '<div class="text-center text-muted" style="padding:48px">Chargement...</div>';
      try {
        const viewModule = routes[viewName].view();
        if (viewModule && typeof viewModule.render === 'function') {
          viewModule.render(content);
        } else {
          content.innerHTML = `<div class="empty-state"><div class="empty-icon">⚠</div><p>Module "${viewName}" non disponible</p></div>`;
        }
      } catch (e) {
        console.error(`Erreur rendu vue ${viewName}:`, e);
        content.innerHTML = `<div class="alert alert-danger"><span class="alert-icon">⚠</span> Erreur lors du chargement : ${e.message}</div>`;
      }
    }

    // Fermer le panneau d'alertes si ouvert
    closeAlertsPanel();
  }

  function onHashChange() {
    const hash = window.location.hash.replace('#', '');
    if (hash && routes[hash] && hash !== currentView) {
      navigate(hash);
    }
  }

  /* --- Sidebar --- */
  function renderSidebar() {
    const sidebar = document.getElementById('sidebar');
    if (!sidebar) return;

    const navSections = [
      { title: 'Pilotage', items: ['dashboard'] },
      { title: 'Gestion opérationnelle', items: ['clients', 'offers', 'sessions'] },
      { title: 'Ressources', items: ['operators', 'modules', 'locations'] },
      { title: 'Configuration', items: ['settings'] }
    ];

    let html = `
      <div class="sidebar-brand">
        <svg width="38" height="38" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="dst-grad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#e53935;stop-opacity:1" />
              <stop offset="50%" style="stop-color:#ff6659;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#ab000d;stop-opacity:1" />
            </linearGradient>
            <filter id="dst-glow"><feGaussianBlur stdDeviation="2" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
          </defs>
          <circle cx="50" cy="50" r="46" fill="none" stroke="url(#dst-grad)" stroke-width="3" filter="url(#dst-glow)"/>
          <circle cx="50" cy="50" r="38" fill="none" stroke="rgba(229,57,53,0.3)" stroke-width="1"/>
          <text x="50" y="42" text-anchor="middle" font-family="Arial Black,sans-serif" font-size="26" font-weight="900" fill="url(#dst-grad)" filter="url(#dst-glow)">DST</text>
          <line x1="22" y1="52" x2="78" y2="52" stroke="url(#dst-grad)" stroke-width="1.5" opacity="0.6"/>
          <text x="50" y="67" text-anchor="middle" font-family="Arial,sans-serif" font-size="8" font-weight="600" fill="#a0a0a8" letter-spacing="3">SYSTEM</text>
          <line x1="50" y1="4" x2="50" y2="12" stroke="url(#dst-grad)" stroke-width="1.5" opacity="0.4"/>
          <line x1="50" y1="88" x2="50" y2="96" stroke="url(#dst-grad)" stroke-width="1.5" opacity="0.4"/>
          <line x1="4" y1="50" x2="12" y2="50" stroke="url(#dst-grad)" stroke-width="1.5" opacity="0.4"/>
          <line x1="88" y1="50" x2="96" y2="50" stroke="url(#dst-grad)" stroke-width="1.5" opacity="0.4"/>
        </svg>
        <div>
          <div class="brand-text">DST-SYSTEM</div>
          <div class="brand-sub">Drill &amp; Skills Training</div>
        </div>
      </div>
      <nav class="sidebar-nav">
    `;

    navSections.forEach(section => {
      html += `<div class="nav-section">${section.title}</div>`;
      section.items.forEach(key => {
        const route = routes[key];
        html += `
          <div class="nav-item" data-view="${key}">
            <span class="nav-icon">${route.icon}</span>
            <span>${route.label}</span>
          </div>
        `;
      });
    });

    html += `</nav>
      <div class="sidebar-footer">
        DST System &copy; ${new Date().getFullYear()}<br>
        <span class="text-muted">Outil de pilotage interne</span>
      </div>
    `;

    sidebar.innerHTML = html;

    // Attacher les événements de navigation
    sidebar.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        navigate(item.dataset.view);
      });
    });
  }

  /* --- Header --- */
  function renderHeader() {
    const header = document.getElementById('header');
    if (!header) return;

    header.innerHTML = `
      <div class="header-title" id="header-title">Dashboard dirigeant</div>
      <div class="header-alerts">
        <span class="header-context" id="header-context"></span>
        <button class="header-alert-btn" id="alerts-toggle" title="Alertes stratégiques">
          ⚠ Alertes
          <span class="badge hidden" id="alerts-badge">0</span>
        </button>
      </div>
    `;

    // Panneau d'alertes
    const panel = document.createElement('div');
    panel.className = 'alerts-panel';
    panel.id = 'alerts-panel';
    document.body.appendChild(panel);

    // Toggle alertes
    document.getElementById('alerts-toggle').addEventListener('click', toggleAlertsPanel);

    // Fermer en cliquant ailleurs
    document.addEventListener('click', (e) => {
      if (alertsPanelOpen &&
          !e.target.closest('#alerts-panel') &&
          !e.target.closest('#alerts-toggle')) {
        closeAlertsPanel();
      }
    });

    updateHeaderContext();
    updateAlertsBadge();
  }

  function updateHeaderContext() {
    const ctx = document.getElementById('header-context');
    if (!ctx) return;
    const now = new Date();
    const opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    ctx.textContent = now.toLocaleDateString('fr-FR', opts);
  }

  /* --- Alertes --- */
  function updateAlertsBadge() {
    try {
      const alerts = Engine.computeAllAlerts();
      const badge = document.getElementById('alerts-badge');
      if (badge) {
        badge.textContent = alerts.length;
        badge.classList.toggle('hidden', alerts.length === 0);
      }
    } catch (e) {
      // Silencieux si le moteur n'est pas prêt
    }
  }

  function toggleAlertsPanel() {
    alertsPanelOpen = !alertsPanelOpen;
    const panel = document.getElementById('alerts-panel');
    if (panel) {
      panel.classList.toggle('open', alertsPanelOpen);
      if (alertsPanelOpen) {
        renderAlertsPanel();
      }
    }
  }

  function closeAlertsPanel() {
    alertsPanelOpen = false;
    const panel = document.getElementById('alerts-panel');
    if (panel) panel.classList.remove('open');
  }

  function renderAlertsPanel() {
    const panel = document.getElementById('alerts-panel');
    if (!panel) return;

    try {
      const alerts = Engine.computeAllAlerts();

      if (alerts.length === 0) {
        panel.innerHTML = `
          <div class="alert-item" style="justify-content:center; color: var(--color-success);">
            ✓ Aucune alerte active
          </div>
        `;
        return;
      }

      let html = '';
      alerts.forEach(alert => {
        const levelClass = alert.level === 'critical' ? 'level-critical' :
                           alert.level === 'warning' ? 'level-warning' : 'level-info';
        const icon = alert.level === 'critical' ? '⚠' :
                     alert.level === 'warning' ? '⚡' : 'ℹ';
        html += `
          <div class="alert-item ${levelClass}">
            <span>${icon}</span>
            <div>
              <div class="alert-type">${alert.context || alert.level}</div>
              <div>${alert.message}</div>
            </div>
          </div>
        `;
      });

      panel.innerHTML = html;
    } catch (e) {
      panel.innerHTML = `<div class="alert-item">Erreur chargement alertes</div>`;
    }
  }

  /* --- Utilitaire : rafraîchir la vue courante --- */
  function refresh() {
    navigate(currentView);
  }

  /* --- API publique --- */
  return {
    init,
    navigate,
    refresh,
    get currentView() { return currentView; }
  };
})();

/* --- Démarrage --- */
document.addEventListener('DOMContentLoaded', () => {
  App.init();
});
  </script>
</body>
</html>
